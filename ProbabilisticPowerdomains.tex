\documentclass[11pt, oneside, article]{memoir}

\settrims{0pt}{0pt} % page and stock same size
\settypeblocksize{*}{32pc}{*} % {height}{width}{ratio}
\setlrmargins{*}{*}{1} % {spine}{edge}{ratio}
\setulmarginsandblock{1in}{1in}{*} % height of typeblock computed
\setheadfoot{\onelineskip}{2\onelineskip} % {headheight}{footskip}
\setheaderspaces{*}{1.5\onelineskip}{*} % {headdrop}{headsep}{ratio}
\checkandfixthelayout



\usepackage{mathtools}
\usepackage{amsthm}
\usepackage{amssymb}
\usepackage{stmaryrd}
\usepackage{bbm}
\usepackage{accents}
\usepackage{newpxtext}
\usepackage[utf8]{inputenc}
\usepackage[varg,bigdelims]{newpxmath}
\usepackage[usenames,dvipsnames]{xcolor}
\usepackage{tikz}
\usepackage{graphicx}
\usepackage{enumitem}
\usepackage{mathpartir}
\usepackage[bookmarks=true, colorlinks=true, linkcolor=blue!50!red, citecolor=orange,
pdfencoding=unicode]{hyperref}
\usepackage[capitalize]{cleveref}
  \newcommand{\creflastconjunction}{, and\nobreakspace}%Make cleveref use serial comma
\usepackage[backend=biber,style = alphabetic]{biblatex}
  \addbibresource{Library20171206.bib}
\usepackage{todonotes}



\usetikzlibrary{
	cd,
	math,
	decorations.markings,
	positioning,
	arrows.meta,
	shapes,
	calc,
	fit,
	quotes,
	intersections}
\hypersetup{final}
\setlist{nosep}

\tikzset{
  tick/.style={postaction={
    decorate,
    decoration={markings, mark=at position 0.5 with {\draw[-] (0,.4ex) -- (0,-.4ex);}}}
  },
  tickx/.style={
    postaction={ decorate,
      decoration={markings,
        mark=at position 0.5 with {
          \fill circle [radius=.28ex];
        }
      }
    }
  }
}



\theoremstyle{plain}
\newtheorem{theorem}{Theorem}[chapter] %change [] to chapter if we want to change global numbering
\newtheorem{proposition}[theorem]{Proposition}
\newtheorem{corollary}[theorem]{Corollary}
\newtheorem{lemma}[theorem]{Lemma}
\newtheorem{conjecture}[theorem]{Conjecture}

\theoremstyle{definition}
\newtheorem{definition}[theorem]{Definition}
\newtheorem{construction}[theorem]{Construction}
\newtheorem{notation}[theorem]{Notation}
\newtheorem{axiom}{Axiom}
\newtheorem*{axiom*}{Axiom}

\theoremstyle{remark}
\newtheorem{example}[theorem]{Example}
\newtheorem{remark}[theorem]{Remark}
\newtheorem{warning}[theorem]{Warning}

\setcounter{axiom}{-1}

% Renewed commands

\renewcommand{\ss}{\subseteq}

% Macros %
\DeclarePairedDelimiter{\church}{\llbracket}{\rrbracket}
\DeclarePairedDelimiter{\Church}{\llbracket}{\rrbracket}
\DeclarePairedDelimiter{\subtype}{[}{]}
\DeclarePairedDelimiter{\classify}{\ulcorner}{\urcorner}

\DeclareMathOperator{\id}{id}
\DeclareMathOperator{\Hom}{Hom}
\DeclareMathOperator{\Mor}{Mor}
\DeclareMathOperator*{\colim}{colim}
\DeclareMathOperator{\im}{im}
\DeclareMathOperator{\Ob}{Ob}


\newcommand{\const}[1]{\mathtt{#1}}
\newcommand{\Set}[1]{\mathrm{#1}}
\newcommand{\cat}[1]{\mathcal{#1}}
\newcommand{\Cat}[1]{\mathbf{#1}}
\newcommand{\fun}[1]{\mathit{#1}}
\newcommand{\Fun}[1]{\mathsf{#1}}

\newcommand{\smset}{\Cat{Set}}


\newcommand{\tickar}{\begin{tikzcd}[baseline=-0.5ex,cramped,sep=small,ampersand replacement=\&]{}\ar[r,tick]\&{}\end{tikzcd}}
\newcommand{\xtickar}[1]{\stackrel{#1}{\tickar}}
\newcommand{\cocolon}{:\!}
\newcommand{\iso}{\cong}
\newcommand{\To}[1]{\xrightarrow{#1}}
\newcommand{\Too}[1]{\xrightarrow{\;\;#1\;\;}}
\newcommand{\from}{\leftarrow}
\newcommand{\From}[1]{\xleftarrow{#1}}
\newcommand{\Fromm}[1]{\xleftarrow{\;\;#1\;\;}}
\newcommand{\surj}{\twoheadrightarrow}
\newcommand{\inj}{\rightarrowtail}
\newcommand{\wavyto}{\rightsquigarrow}

\newcommand{\tn}[1]{\textnormal{#1}}
\newcommand{\ol}[1]{\overline{#1}}
\newcommand{\ul}[1]{\underline{#1}}
\newcommand{\wt}[1]{\widetilde{#1}}
\newcommand{\ubar}[1]{\underaccent{\bar}{#1}}


\newcommand{\internal}[1]{\raisebox{-.03ex}{$\mathbbmtt{#1}$}}
\newcommand{\hs}{\hspace{1.1pt}}


\newcommand{\EE}{\mathbb{E}} % expectation value
\newcommand{\II}{\mathbb{II}} % interval domain
\newcommand{\IR}{\mathbb{IR}} % interval domain
\newcommand{\NN}{\mathbb{N}}
\newcommand{\PP}{\mathbb{P}}
\newcommand{\QQ}{\mathbb{Q}}
\newcommand{\RR}{\mathbb{R}}
\newcommand{\VV}{\mathbb{V}}
\newcommand{\ZZ}{\mathbb{Z}}
\newcommand{\LR}{\ul{\mathbb{R}}}

\newcommand{\tNN}{\internal{N}\hs}
\newcommand{\tQQ}{\internal{Q}\hs}
\newcommand{\tQQp}{\tQQ_{+}}
\newcommand{\tZZ}{\internal{Z}\hs}
\newcommand{\tQQub}{\QQ^\infty}
\newcommand{\tRR}{\internal{R}\hs}
\newcommand{\tIR}{\internal{I\hs R}\hs}
\newcommand{\tII}{\bar{\ubar{\tRR}}\hs}
\newcommand{\tLR}{\ubar{\tRR}\hs}
\newcommand{\tUR}{\bar{\tRR}\hs}
\newcommand{\tRRub}{\tRR^\infty}
\newcommand{\tIRub}{\internal{I\hs R}^\infty}
\newcommand{\tLRub}{\ubar{\tRR}^{\infty}}
\newcommand{\tURub}{\bar{\tRR}^{\infty}}
\newcommand{\tIIub}{\bar{\ubar{\tRR}}^{\infty}}

\newcommand{\tRRat}[1]{\tRR_{\SeeInline{#1}}}


\newcommand{\tConst}{\mathtt{C}}
\newcommand{\ShFun}[1]{\mathrm{Fn}(#1)}

\newcommand{\Ind}[1]{\Fun{Ind}\tn{-}#1}
\newcommand{\Psh}{\Fun{Psh}}
\newcommand{\Shv}{\Fun{Shv}}
\newcommand{\Cont}{\Fun{Cont}}
\newcommand{\Idl}{\Set{Idl}}

\newcommand{\Prop}{\const{Prop}}
\newcommand{\Time}{\const{Time}}
\newcommand{\unit}{\const{1}}
\newcommand{\Poset}{\Cat{Poset}}
\renewcommand{\Top}{\Cat{Top}}
\newcommand{\Op}{\Set{Op}}
\renewcommand{\C}{\Cat{C}}
\newcommand{\Sub}{\Set{Sub}}
\newcommand{\pt}{\Fun{pt}}

\newcommand{\op}{^\tn{op}}
\newcommand{\el}[1]{\tn{el}#1}
\newcommand{\asSh}{\Fun{sh}}

\newcommand{\apart}{\,\#\,}
\newcommand{\restrict}[2]{#1\big|\hspace{0in}_{#2}}
\newcommand{\restrictsm}[2]{#1|\hspace{0in}_{#2}}
\newcommand{\BaseTopos}{\mathcal{B}}

\newcommand{\Pointwise}{\pi}
\newcommand{\AtSymbol}{{@}}
\newcommand{\SeeSymbol}{{\down}}  % Old: \xi
\newcommand{\InSymbol}{{\upclose}}% Old: \iota
\newcommand{\At}[2][]{\AtSymbol^{#1}_{#2}}
\newcommand{\See}[2][]{\SeeSymbol^{#1}_{#2}}
\newcommand{\In}[2][]{\InSymbol^{#1}_{#2}}
\newcommand{\AtInline}[1]{@{#1}}
\newcommand{\SeeInline}[1]{\SeeSymbol{#1}}
\newcommand{\InInline}[1]{\InSymbol{#1}}


\newcommand{\sqss}{\sqsubseteq}
\newcommand{\specupclose}{{\uparrow}}
\newcommand{\specdownclose}{{\downarrow}}
\newcommand{\upclose}{{\rotatebox[origin=c]{90}{$\twoheadrightarrow$}}}
\newcommand{\downclose}{{\rotatebox[origin=c]{90}{$\twoheadleftarrow$}}}
\newcommand{\down}{\mathord{\downarrow}}
\newcommand{\up}{\mathord{\uparrow}}

\newcommand{\imp}{\Rightarrow}
\renewcommand{\iff}{\Leftrightarrow}
\newcommand{\true}{\const{true}}
\newcommand{\Bool}{\Set{Bool}}

\newcommand{\Span}{\Cat{Span}}
\newcommand{\set}{\text{--}\smset}


\newcommand{\erase}[1]{}

\linespread{1.2}
\setsecnumdepth{subsection}
\settocdepth{section}
\setlength{\parindent}{15pt}

%%%%%%%%%%%%% Document %%%%%%%%%%%%%
\begin{document}

\title{Notes on probabilistic powerdomains in a sheaf topos}

\author{Tobias and David}

\maketitle

\tableofcontents*


%%%%%%%%% Chapter %%%%%%%%%

\chapter{Introduction}

\todo[inline]{T: I think that we should work in the topos of sheaves over an \emph{arbitrary} interval domain}

\chapter{Internal posets}

\begin{notation}
We write $\tQQp\coloneqq\{q:\tQQ\mid q\geq0\}$. Given a function $P:X\to\Prop$, we write $\subtype{P}\ss X$ to denote the associated subtype, $\subtype{P}\coloneqq\{x:X\mid Px\}$.
\end{notation}

\begin{definition}
Let $X$ be a type. A \emph{poset structure on $X$} is a function $L:X\times X\to\Prop$ satisfying
\begin{enumerate}
	\item $\forall(x:X)\ldotp L(x,x)$.
	\item $\forall(x,y,z:X)\ldotp L(x,y)\imp L(y,z)\imp L(x,z)$.
\end{enumerate}
We usually denote $L(x,y)$ as $x L y$. We call $(X,L)$ a \emph{poset}.
\end{definition}

In terms of sheaf semantics on some site $(\C,J)$, an internal poset is the same thing as a sheaf with values in $\Poset$; since the theory of posets is essentially algebraic, this is a consequence of Diaconescu's theorem, but it is also instructive to check it by hand.

\begin{example}
For any type $Y$, the type $\Phi\coloneqq (Y\to\Prop)$ has a natural poset structure given by $\lambda(f,g:Y\to\Prop)\ldotp\forall(y:Y)\ldotp (fy\imp gy)$.
\end{example}

\begin{example}
The type $\tLR$ of nonnegative lower real numbers is defined as the type of functions $\delta:\tQQp\to\Prop$ satisfying the following:
\begin{description}
	\item[\quad\parbox{1in}{Down-closed:}] $\forall(q,q':\tQQp)\ldotp (q<q')\imp\delta q'\imp\delta q$.
	\item[\quad\parbox{1in}{Rounded:}] $\forall(q:\tQQp)\ldotp\delta q\imp\exists(q':\tQQ)\ldotp(q<q')\wedge\delta q'$.
\end{description}
The type $\tLR$ has the structure of an ordered semi-ring. That is, it has the structure of
\begin{itemize}
	\item a poset: $\delta\leq \delta'\iff\forall q\ldotp\delta q\imp\delta'q$,
	\item a commutative monoid $(0,+)$:
	\begin{itemize}
		\item identity $0$ given by $\lambda q\ldotp q < 0$,
		\item  addition given by $(\delta_1+\delta_2)q\iff\exists(q_1,q_2)\ldotp(q<q_1+q_2)\wedge\delta_1q_1\wedge\delta_2q_2$,
	\end{itemize}
	\item a commutative monoid $(1,*)$:
	\begin{itemize}
		\item identity $1$ given by $\lambda q\ldotp q<1$,
		\item multiplication given by $(\delta_1*\delta_2)q\iff\exists(q_1,q_2)\ldotp(q<q_1*q_2)\wedge\delta_1q_1\wedge\delta_2q_2$,
	\end{itemize}
\end{itemize}
where multiplication distributes over addition, and both preserve order.
\end{example}

\begin{definition}
Let $(X,\leq)$ be a poset. A subtype $D:X\to\Prop$ is called \emph{directed} if it satisfies the following:
\begin{enumerate}
	\item $\exists(x:X)\ldotp Dx$.
	\item $\forall(x,y:\subtype{D})\ldotp\exists(z:\subtype{D})\ldotp(x\leq z)\wedge (y\leq z)$.
\end{enumerate}
Denote the conjunction of these two conditions as $\const{Drct}:(X\to\Prop)\to\Prop$.
\end{definition}

\begin{definition}
Let $(X,\leq)$ be a poset and let $P:X\to\Prop$ be a subtype. A \emph{join} of $P$ is an element $s_P:X$ satisfying
\begin{enumerate}
	\item $\forall(x:\subtype{P})\ldotp x\leq s_P$.
	\item $\forall(s':X)\ldotp[\forall(x:\subtype{P})\ldotp x\leq s']\imp s_P\leq s'$.
\end{enumerate}
Similarly, a \emph{meet} of $P$ is an element satisfying the dual statements (the arguments to every $\leq$ symbol are swapped).

We say that $X$ has \emph{binary joins} (resp.\ \emph{binary meets}) if, for every $x_1,x_2:X$ the subtype $\lambda(x:X)\ldotp (x=x_1) \vee (x=x_2)$ has a join, in which case we denote it $x_1\vee x_2$ (resp.\ meet $x_1\wedge x_2$). 

We say that $X$ has a \emph{bottom element} if $\lambda(x:X)\ldotp \bot$ has a join, in which case we denote it $\varnothing:X$. We say that $X$ has \emph{finite joins} if $X$ has binary joins and a bottom element (resp.\ binary meets and a top element). We say that $X$ has \emph{directed joins} if, every directed $P$ has a join, denoted $\sup P$.
\end{definition}

\begin{example}
For any type $Y$, the poset $\Phi\coloneqq Y\to\Prop$ has all joins and meets. The join of $P:\Phi\to\Prop$ is $s_P\coloneqq\lambda(y:Y)\ldotp\exists(\phi:\subtype{P})\ldotp\phi y$. It is easy to check that this satisfies the conditions of being a join. The meet of $P$ is $\lambda(y:Y)\ldotp\forall(\phi:\subtype{P})\ldotp\phi y$.
\end{example}

\begin{example}
The poset $(\tLR,\leq)$ has arbitrary joins: the join of $P:\tLR\to\Prop$ is $\lambda q\ldotp\exists(\delta:\subtype{P})\ldotp\delta q$. Note that $0$ is the bottom element. It also has binary meets: $\min(\delta_1,\delta_2)q\iff(\delta_1 q\wedge \delta_2q)$.

In fact, it also has arbitrary meets, though I don't think we'll need that. The meet of $P:\tLR\to\Prop$ is $(\bigwedge P)q\iff\exists q'\ldotp (q<q')\wedge\forall(\delta:\subtype{P})\ldotp\delta q'$.
\end{example}

\begin{definition}
We say that a poset $(X,\leq)$ \emph{has valuations} \todo{Find a better term if we really need this (perhaps we want internal frames instead?)}if it has binary meets, binary joins, and directed joins.
\end{definition}

Note that if $(X,\leq)$, this does not guarantee that $(\VV(X),\leq)$ does.

\chapter{Internal topological spaces and locales}

\todo[inline]{T: possibly except for the interactions with modalities, this stuff is all standard}

Here is a potential definition of topology:
\begin{definition}
Let $X$ be a type. A \emph{topology} on $X$ is a function $\Op:(X\to\Prop)\to\Prop$ satisfying the following conditions:
\begin{enumerate}
	\item $\Op(\lambda(x:X)\ldotp\top)$.
	\item $\forall(\phi_1,\phi_2:X\to\Prop)\ldotp(\Op(\phi_1)\wedge\Op(\phi_2))\imp\Op(\lambda(x:X)\ldotp\phi_1 x\wedge\phi_2 x)$.
	\item Suppose given $I:(X\to\Prop)\to\Prop$ satisfying $\forall(\phi:X\to\Prop)\ldotp I(\phi)\imp\Op(\phi)$. Then $\Op(\lambda(x:X)\ldotp\exists(\phi:X\to\Prop)\ldotp I(\phi)\wedge\phi (x))$.
\end{enumerate}
In other words, the whole space $X$ is open, the intersection of two opens is open, and the union of any $I$-indexed set of opens is open, for any open system $I$. It will be useful to define open systems: $\mathrm{OpSys}\coloneqq\{I:(X\to\Prop)\to\Prop\mid\forall \phi\ldotp I(\phi)\imp\Op(\phi)\}.$

We refer to a pair $(X,\Op)$, where $X$ is a type and $\Op$ is a topology on $X$, as an \emph{internal topological space}.
\end{definition}

\begin{example}[Discrete topology]
For any type $X$, the \emph{discrete topology} on $X$ is given by $\Op(\phi)=\top$.
\end{example}

\begin{example}[Topology on $\tRR_j$]\label{ex.usual_topology_R}
Let $j$ be a modality and define $\Op:(\tRR_j\to\Prop)\to\Prop$ by
\[\Op(\phi)\coloneqq\forall(r:\tRR_j)\ldotp\phi r\imp\exists(\epsilon:\tRR_j)\ldotp\epsilon>0\wedge\forall(r':\tRR_j)\ldotp(-\epsilon<r-r'<\epsilon)\imp\phi(r').\]
It is easy to check condition 1. For condition 2, we obtain $\epsilon_1$ and $\epsilon_2$ from $\phi_1$ and $\phi_2$, respectively; we can satisfy the requisite condition using their infimum, $\min(\epsilon_1,\epsilon_2)>0$.

It remains to check condition 3. Let $I:(\tRR_j\to\Prop)\to\Prop$ satisfy $\forall(\phi:\tRR_j\to\Prop)\ldotp I(\phi)\imp\Op(\phi)$, i.e.\ $I$ is an open system. We need to show $\Op(\lambda(r:\tRR_j)\ldotp\exists(\phi:\tRR_j\to\Prop)\ldotp I(\phi)\wedge\phi (r))$. In other words, we need to show
\begin{multline*}
  \forall(r:\tRR_j)\ldotp[\exists(\phi:\tRR_j\to\Prop)\ldotp I(\phi)\wedge\phi(r)]\imp\exists(\epsilon:\tRR_j)\ldotp\epsilon>0\wedge\\
  \forall(r':\tRR_j)\ldotp(-\epsilon<r-r'<\epsilon)\imp\exists(\phi':\tRR_j\to\Prop)\ldotp I(\phi')\wedge\phi'(r).
\end{multline*}
So take $r:\tRR_j$ and suppose given $\phi$ such that $I(\phi)$ and $\phi(r)$ hold. It follow by hypothesis that $\Op(\phi)$ holds, so by definition we obtain $\epsilon>0$ satisfying the requisite condition with $\phi'\coloneqq\phi$.

All we used about $\tRR_j$ was that it has a definition of comparison ($a<b$), subtraction ($a-b$), that binary min's exist, and that the additive inverse of a binary min is a binary max.
\end{example}

\begin{definition}\label{def.continuous}
Suppose that $(X,\Op_X)$ and $(Y,\Op_Y)$ are internal topological space. A function $f:X\to Y$ is called \emph{continuous} if it satisfies
\[\forall(\phi:Y\to\Prop)\ldotp\Op_Y(\phi)\imp\Op_X(\phi f).\]
We denote by $\Cont(X,Y)$ the type of all $f:X\to Y$ satisfying this condition.
\end{definition}

\begin{proposition}
The internal topological spaces in a topos $\cat{E}$ and continuous maps form an external category with products, and the forgetful functor to $\cat{E}$ preserves products.
\end{proposition}
\begin{proof}
It is easy to check directly from \cref{def.continuous} that if $f:X\to Y$ and $g:Y\to Z$ are continuous then so is $g\circ f$, and the identity is clearly continuous. To check the existence of products, we need to define a product topology $\Op_{X\times Y}$ on $X\times Y$, given topologies $\Op_X$ and $\Op_Y$. Given $\phi:X\times Y\to\Prop$, define $\Op_{X\times Y}(\psi)$ to be
\begin{multline*}
	\exists(I:\mathrm{OpSys}(X))\ldotp\\
	[\forall(\phi:I)\ldotp\exists(\phi_X:\Op(X))(\phi_Y:\Op(Y))\ldotp\phi(x,y)\iff(\phi_X(x)\wedge\phi_Y(y))]\\\wedge[\forall(x:X)(y:Y)\ldotp\psi(x,y)\iff\exists(\phi:I)\ldotp\phi(x,y)]
\end{multline*}
Check that this is a topology and that it has the universal property of a product. (Unfinished)
\end{proof}

\begin{example}
The functions $+:\tRR_j\times\tRR_j\to\tRR_j$ and $*:\tRR_j\times\tRR_j\to\tRR_j$ are continuous; see \cite[Theorems 4.44, 4.48]{Schultz.Spivak:2017a}. For any $j\to j'$ the map $\tRR_j\to\tRR_{j'}$ is also continuous; see \cite[Proposition 4.52]{Schultz.Spivak:2017a}.
\end{example}

%%% The following is the Riesz approach
% \begin{definition}[Measure on an internal topological space]
%Let $(X,\Op_X)$ be an internal topological space, and let $\tRR_{\SeeInline{[d,u]}}$ be the $[d,u]$-reals with the usual topology (see \cref{ex.usual_topology_R}). Then a $[d,u]$-measure on $X$ is a function $\mu:\Cont(X,\tRRat{[d,u]})\to\tRRat{[d,u]}$
%satisfying the following properties:
%\begin{enumerate}
%	\item Linearity: $\mu(r*f+g)=r*\mu(f)+\mu(g)$ for $r:\tRR$ and $f,g:X\to\tRRat{[d,u]}$.
%	\item Positivity: $\mu(f)\geq 0$ whenever $f$ satisfies $\forall x\ldotp f(x)\geq 0$.
%\end{enumerate}
%Let $\const{Meas}_{[d,u]}(X)$ denote the type of measures on $X$ at $[d,u]$. A \emph{measure $\mu$ on $X$} consists of a measure $\mu_{[d,u]}\in\const{Meas}_{[d,u]}(X)$ for each $d,u:\tRR$ such that
%\[\forall(f:X\to\tRRat{[d',u']})\ldotp\See{[d,u]}\mu_{[d',u']}(f)=\mu_{[d,u]}(\See{[d,u]}f)\]
%holds for every $d\leq d'\leq u'\leq u$. Let $\const{Meas}(X)$ denote the type of measures on $X$.
%\end{definition}

\todo{Locally compact spaces as continuous posets}

\todo{Does at modality take locally compact spaces to locally compact spaces?}

\section{Domain-theoretic aspects of internal locales}

For now, this stuff is taking place in $\smset$.

Let $X$ be a topological space with poset of opens $\Op(X)$. Then for $U\subseteq V$ in $\Op(X)$, what does it mean for $U$ to be way below $V$? There is a nice way to relate it to the finite subcover definition of compactness:

\begin{lemma}
$U\ll V$ if and only if every open covering of $V$ has a finite subfamily which covers $U$.
\end{lemma}

\begin{proof}
If the condition holds, then every directed set of opens that goes below $V$ also covers $V$, and therefore contains an element that already contains $U$.

Conversely, given a covering family, consider the directed set of finite unions of members of the cover.
\end{proof}

Without additional separation assumptions on $X$, it seems tricky to translate this into a condition involving only the usual concepts of point-set topology. In order to do so, we need one more auxiliary statement.

\newcommand{\cl}[1]{\overline{#1}} % topological closure
\newcommand{\intr}[1]{\mathrm{int}(#1)} % interior

\begin{lemma}
Let $X$ be regular and $D\subseteq X$ dense. Suppose that every open cover of $X$ has a finite subfamily which covers $D$. Then $X$ is compact.
\end{lemma}

This may be somewhat surprising, since in many cases a finite subfamily which covers $D$ does not yet cover $X$.

\begin{proof}(Due to Ramiro de las Vegas, MO.)
Let $\mathcal{A}$ be an open cover of $X$. For every $x\in X$, choose $U_x\ni x$ such that $\cl{U_x}\subseteq V_x$ for suitable $V_x\in\mathcal{A}$. Then $\{U_x\}$ is another open covering which has a finite subcover $\{U_{x_1},\ldots,U_{x_n}\}$ by assumption. Since $X = \cl{U_{x_1}\cup\ldots\cup U_{x_n}} = \cl{U_{x_1}}\cup\ldots\cup\cl{U_{x_n}} \subseteq V_{x_1}\cup\ldots\cup V_{x_n}$, we are done.
\end{proof}

Now we can characterize the way below relation in a nice way:

\begin{lemma}
Let $X$ be regular. Then $U\ll V$ if and only if $U$ is relatively compact in $V$, i.e.~if $\cl{U}\cap V$ is compact.
\end{lemma}

\begin{proof}
If $\cl{U}\cap V$ is compact, then clearly the condition of the first lemma holds as well, and we do not need regularity.

Conversely, suppose that the condition of the first lemma holds. Then by the previous lemma, it is enough to show that every open cover of $\cl{U}\cap V$ has a finite subfamily which covers $U$. But this is clear by assumption: throwing in $V\setminus\cl{U}$ to an open cover of $\cl{U}\cap V$ gives an open cover of $V$.
\end{proof}

\section{Locales and geometric morphisms}

My question is: given a geometric morphism $f : \mathcal{T}\to\mathcal{T}'$, do internal frames in $\mathcal{T}'$ pull back to internal frames in $\mathcal{T}$?

Note that there is a natural comparison map between $f^*\Prop'$ and $\Prop$. Indeed, since $f^*$ preserves monos by virtue of being left exact, there is a map $\classify{f^*\const{true}'}\colon f^*\Prop'\to\Prop$ classifying the image under $f^*$ of $\const{true}'\colon 1'\to \Prop'$.

\begin{lemma}
If $s:A\to B$ is an arbitrary subobject in $\mathcal{T}'$, then $f^*s : f^*A\to f^*B$ is again a subobject, and $\classify{f^*s}$ is given by $f^*\classify{s}$ post-composed with the comparison map $f^*\Prop'\to\Prop$.
\end{lemma}

\begin{proof}
 This is because
\[\begin{tikzcd}
	f^*A \ar{r} \ar{d} & f^*B \ar{d} \\
	f^*1 \ar{r} & f^*\Prop'
\end{tikzcd}\]
is again a pullback diagram, and likewise is
\[\begin{tikzcd}
	f^*1 \ar{r} \ar{d} & f^*\Prop' \ar{d} \\
	1 \ar{r} & \Prop
\end{tikzcd}\]
so that the two pullbacks compose.
\end{proof}

In this reasoning, we have only needed to use that $f^*$ is left exact. Thus everything applies likewise to $f_*$, and we e.g.~have a comparison map $\classify{f_*\const{true}}\colon f_*\Prop\to\Prop'$. But this is of less interest to us here.

So given an internal poset $P$ in $\mathcal{T}'$, we get a poset structure on $f^*P$ given by the subobject $f^*(\leq) \to f^*P\times f^*P$. Again using the fact that $f^*$ preserves finite limits, it's straightforward to see that if $P$ is a meet-semilattice in $\mathcal{T}'$, then $f^*P$ is a meet-semilattice in $\mathcal{T}$. However, it's less clear if the existence of arbitrary joins is preserved in the same way.

The existence of arbitrary joins for $P = \mathcal{O}(X)$ means that the down-closure map
\[
	\mathcal{O}(X)\to\Prop'^{\mathcal{O}(X)},\qquad U\mapsto \classify{ \{ V \leq U \} }
\]
has an internal left adjoint. Here, $\Prop'^{\mathcal{O}(X)}$ carries the usual pointwise ordering, i.e.~the one corresponding to inclusion of subobjects. What we would like to have is that the down-closure map of $f^*\mathcal{O}(X)$ similarly has a left adjoint. According to the Elephant (p.~580), this is not the case in general! However for an \emph{atomic} geometric morphism---or in other words if $f^*$ is a logical functor---we can apply Corollary B2.3.10 to conclude that $f^*\mathcal{O}(X)$ is indeed an internal frame. Concretely, in this case the sup map is the composite $\Prop^{f^*(\mathcal{O}(X))}\cong f^*\left(\Prop'^{\mathcal{O}(X)}\right)\to f^*(\mathcal{O}(X))$, where the first morphism comes from $f^*$ being logical and the second one is $f^*(\sup)$.

In conclusion, internal frames can be pulled back along atomic geometric morphisms\footnote{And also along general geometric morphisms, but this requires a different construction, as in Elephant p.~580.}. Again by Elephant p.~580, pushing frames forward along $f_*$ is even simpler, and it seems plausible that this results in an adjunction $f^* \dashv f_*$ between frames in $\mathcal{T}$ and frames in $\mathcal{T}'$. I will be a bit sloppy for now and just assume that this is true.

The next question is whether $f^*$ preserves properties of locales such as regularity or local compactness. Both are concerned with relaxed notions of ordering:

\begin{definition}
For $U,V\in\mathcal{O}(X)$, one says that
\begin{enumerate}
\item $V$ is \emph{well inside} $U$, written $V\subset\subset U$, if there is $G\in\mathcal{O}(X)$ such that $V\cap G = \emptyset$ and $U\cup G = X$.
\item $V$ is \emph{way below} $U$, written $U\ll V$, if for every directed $D:\mathcal{O}(X)\to\Prop$, $U\leq\sup D$ implies that there is $W\in D$ with $V\leq W$.
\end{enumerate}
Then $X$ is regular (locally compact) if every $U$ is the sup of the $V$ that are well inside (way below) it.
\end{definition}

Since these definitions make sense constructively, we can apply them to internal locales.

So the well-inside relation corresponds to the subobject of $\mathcal{O}(X)\times\mathcal{O}(X)$ that is the projection of the subobject
\[
	\{ \: (V,G,U) \:|\: V\wedge G = \emptyset, \; U\vee G = X \: \} \quad \subseteq \quad \mathcal{O}(X)\times\mathcal{O}(X)\times\mathcal{O}(X)
\]
to the first and third factor, and this subobject itself is an equalizer. Since $f^*$ preserves monos and epis, it also preserves image factorizations and therefore pushforwards of subobjects, such as this pushforward along the product projection. Hence the well-inside relation on $f^*(\mathcal{O}(X))$ coincides with $f^*(\subset\subset)$.

Regularity means that upon exponentiating the first factor in $\classify{\subset\subset} : \mathcal{O}(X)\times\mathcal{O}(X)\to\Prop'$ to $\mathcal{O}(X)\to\Prop'^{\mathcal{O}(X)}$ and composing with $\sup$, one obtains $1_{\mathcal{O}(X)}$. Again since $f^*$ is logical and $f^*(\sup)$ is the sup map of $f^*(\mathcal{O}(X))$, we can conclude that $f^*(\mathcal{O}(X))$ is regular is well.

In order to make the same argument for local compactness, we show similarly that $f^*(\ll)$ is the way-below relation on $f^*(\mathcal{O}(X))$. By similar reasoning as for well-inside, we obtain that $\const{Drct}(f^*(\mathcal{O}(X))) = f^*(\const{Drct}(\mathcal{O}(X)))$.

\chapter{Valuations and measures}



\begin{definition}
Suppose $X$ is a locale. A \emph{valuation} on $X$ is a function $\mu:\mathcal{O}(X)\to\tRRat{[d,u]}$ satisfying the following:
\begin{enumerate}
	\item $\mu(\varnothing)=0$.
	\item $\forall(x,x':X)\ldotp(x\leq x')\imp\mu(x)\leq\mu(x')$.
	\item $\forall(x,x':X)\ldotp\mu(x)+\mu(x')=\mu(x\vee x')+\mu(x\wedge x')$.
	\item $\forall(D:X\to\Prop)\ldotp\const{Drct}(D)\imp \mu(\sup(D))=\sup(\mu(D))$.
\end{enumerate}
Here, $\mu(D)$ is shorthand for the subtype $\mu(D)=\{\mu x\mid Dx\}$.%
\footnote{Completely formally, $\mu(D)\coloneqq\{r:\RR\mid\exists(x:\subtype{D})\ldotp r=\mu(x)\}$.}

Let $\VV(X)$ denote the type of valuations $\mu$, ordered by $(\mu\leq\mu')\iff\forall(x:X)\ldotp(\mu x\leq \mu'x)$.
\end{definition}

\begin{definition}
A valuation is a \emph{probability valuation} if $\mu(X) = 1$.
\end{definition}

\section{A simpler model}

How about considering only two instances of time first, so that we work in the presheaf topos over the discrete two-point space $\{a,b\}$? Here, we will only need three modalities, where $\pi$ corresponds to sheafification, and $\At{a}{}$ and $\At{b}{}$ correspond to behavior at $a$ and $b$, respectively. In this case, measures on types (or suitable locales) which satisfy $\pi$ should semantically correspond to pairs of random variables equipped with a joint distribution. This is a good test case where the essential structures already come up, but without the technical complexity of TTT.

This is the topos $\Span\set$, where $\Span$ is the category \fbox{$a\from ab\to b$}. The subobject classifier for $\Span\set$ has five global sections, which we can represent as follows:
\[\church{\Prop}(ab)=\{\bot,a,b,a\vee b,\top\}.\]
We have $a=(\neg b)=(b\imp a)$ and similarly $b=(\neg a)=(a\imp b)$.

Here is a type theory for $\Span\set$: no atomic types, no atomic terms, two atomic propositions $a,b:\Prop$, and two axioms: $a=\neg b$ and $b=\neg a$. Note that $a=\neg\neg a$ and similarly $b=\neg\neg b$, but not so for $a\vee b$; the logic is not boolean.

The analogous modalities to those used in TTT are:
\[
\begin{array}{c|c|rccc}
	\textbf{modality}&\textbf{definition on } P:\Prop&\textbf{values: }\bot&a&b&a\vee b \\\hline
	\In{a}&a\imp P&b&\top&b&\top\\
	\See{a}&b\vee P&b&a\vee b&b&a\vee b\\
	\At{a}&(P\imp b)\imp b&b&\top&b&\top\\\hline
	\In{b}&b\imp P&a&a&\top&\top\\
	\See{b}&a\vee P&a&a&a\vee b&a\vee b\\
	\At{b}&(P\imp a)\imp a&a&a&\top&\top\\\hline
	\pi&\At{a}P\wedge\At{b}P&\bot&a&b&\top
\end{array}
\]

\todo[inline]{T: do this for an arbitrary interval domain?}

\begin{remark}
Semantically we see that $\church{\In{a}}=\church{\At{a}}$, but in fact, our axioms may not be strong enough to prove that internally. It is easy to show $\forall(P:\Prop)\ldotp(a\imp P)\imp(P\imp b)\imp b$, but I do not see how to show $\forall(P:\Prop)\ldotp[(P\imp b)\imp b]\imp^? (a\imp P)$. Without additional axioms, we have to decide whether to work with $\At{a}$ or $\In{a}$ in our notion of measure; we use $\At{}$ so as to remain faithful to the TTT case. 
\end{remark}

Although defined as the topos on presheaves on the discrete two-point space $\{a,b\}$, our topos $\Span\set$ can also be viewed as the topos of \emph{sheaves} on a topological space $W$, with three points $a,b,ab$ and four open sets: $\emptyset$, $W$, $\{a\}$ and $\{b\}$. The type $\tRR$ corresponds to the constant sheaf, by general theory of real number objects in localic toposes.

\begin{theorem}
Given finite sets $A$ and $B$, valuations on the power object of the $\pi$-type given by the product projections span
\[\begin{tikzcd}
	& A \times B \ar{dl} \ar{dr} \\
	A & & B
\end{tikzcd}\]
are semantically in bijective correspondence with probability measures on $A\times B$.
\end{theorem}

Here, our valuations take values in the lower reals.

We also write $(A,B)\in\Span\set$ as shorthand for the above span. So the global elements of the object of valuations on $(A,B)$ are precisely the probability measures on $A\times B$.

\begin{proof}
The lower reals are given by the span
\[\begin{tikzcd}
	& \{ (x, y, z) \in\mathbb{R}^3 \:\mid\: x,y\geq z \} \ar[swap]{dl}{(x,y,z)\mapsto x} \ar{dr}{(x,y,z)\mapsto y} \\
	\mathbb{R} & & \mathbb{R}
\end{tikzcd}\]
The power object $\Prop^{(A,B)}$ is given by the span
\[\begin{tikzcd}
	& Nat(A,B) \ar{dl} \ar{dr} \\
	\{\bot,\top\}^A & & \{\bot,\top\}^B
\end{tikzcd}\]
where $Nat(A,B)\subseteq \{\bot,a,b,a\lor b,\top\}^{A\times B}$ is the subset consisting of those functions $\phi : A\times B \to \{\bot,a,b,a\lor b,\top\}$ with the property that $\At{a} \phi(x,y)$ is independent of $y$, and likewise $\At{b} \phi(x,y)$ is independent of $x$. Hence the elements of $Nat(A,B)$ can be identified with triples $(S,T,U)$ where $S\subseteq A$ and $T\subseteq B$ as well as $U\subseteq S\times T$; the truth value of $(x,y)$ is $\geq a$ iff $x\in S$; it is $\geq b$ iff $y\in T$; and finally it is $\top$ iff $(x,y)\in U$. In this picture, the maps on the two legs are simply $(S,T,U)\mapsto S$ and $(S,T,U)\mapsto T$. The connectives are given componentwise,
\begin{align*}
	(S_1,T_1,U_1) \land (S_2,T_2,U_2) & = (S_1\cap S_2,T_1\cap T_2,U_1\cap U_2),\\
	(S_1,T_1,U_1) \lor (S_2,T_2,U_2)  & = (S_1\cup S_2,T_1\cup T_2,U_1\cup U_2).
\end{align*}
By all this, a global element of the object of normalized valuations is a diagram
\[\begin{tikzcd}
	& \{(S,T,U) \:\mid\: S \subseteq A , \: T \subseteq B , \: U \subseteq S\times T \} \ar{dl} \ar{dr} \ar{dd}{\mu_{ab}} \\
	\{ S \subseteq A \} \ar{dd}{\mu_a} & & \{ T \subseteq B \} \ar{dd}{\mu_b} \\
	& \{ (x,y,z) \in \mathbb{R}^3 \:\mid\: x,y\geq z \} \ar{dl} \ar{dr} \\
	\mathbb{R} & & \mathbb{R}
\end{tikzcd}\]
satisfying in addition monotonicity and the inclusion-exclusion and normalization equations. The commutativity of the diagram expresses the requirement that the first two components of $\mu_{ab}(S,T,U)$ must be equal to $\mu_a(S)$ and $\mu_b(T)$, respectively; in particular, if we replace $\mu_{ab}$ by its third component, we have the inequalities
\[
	\mu_{ab}(S,T,U) \leq \mu_a(S), \qquad \mu_{ab}(S,T,U) \leq \mu_b(T).
\]
So from now on, we will write $\mu_{ab}$ for only the third component, which is an external real number. By monotonicity of the valuation, it is enough to postulate these inequalities only in the special case $T = B$ and $U = S\times T$,
\begin{equation}
\label{marginaldomination}
	\mu_{ab}(S,B,S\times B) \leq \mu_a(S), \qquad \mu_{ab}(A,T,A\times T) \leq \mu_b(T),
\end{equation}
as long as each of $\mu_a$, $\mu_b$ and $\mu_{ab}$ is monotone (which is the case). Furthermore, we have normalization, which states $\mu_a(A) = \mu_b(B) = \mu_{ab}(A,B,A\times B) = 1$, and the inclusion-exclusion relation, which states the obvious for $\mu_a$ and $\mu_b$, as well as
\begin{equation}
\label{abinclexcl}
	\mu_{ab}(S_1\cap S_2,T_1\cap T_2,U_1\cap U_2) + \mu_{ab}(S_1\cup S_2,T_1\cup T_2,U_1\cup U_2) = \mu_{ab}(S_1,T_1,U_1) + \mu_{ab}(S_2,T_2,U_2).
\end{equation}
Moreover, we claim that together with normalization, this forces the inequalities~\eqref{marginaldomination} to be equalities. Indeed, we have as an instance of inclusion-exclusion,
\[
	\mu_{ab}(A\setminus S,B,(A\setminus S)\times B) + \mu_{ab}(S,B,S\times B) = \mu_{ab}(\emptyset,B,\emptyset) + \mu_{ab}(A,B,A\times B).
\]
The first term on the right-hand side vanishes since $0 \leq \mu_{ab}(\emptyset,B,\emptyset) \leq \mu_a(\emptyset) = 0$, while the second term is $1$ by normalization. With $A\setminus S$ in place of $S$, the first inequality~\eqref{marginaldomination} therefore gives
\[
	1 - \mu_{ab}(S,B,S\times B) \leq \mu_a(A\setminus S) = 1 - \mu_a(S).
\]
\todo[inline]{These seem to be correspond to the point-determination axiom, which therefore follows from normalization. Is this correct?}
Combining this with~\eqref{marginaldomination}, we conclude that the first inequality in~\eqref{marginaldomination} must hold with equality; the same reasoning applies to the second inequality. Therefore $\mu_a$ is already determined by $\mu_{ab}$, and so is $\mu_b$.

So overall, a normalized valuation on $(A,B)$ is the same thing as a map $(S,T,U)\longmapsto \mu_{ab}(S,T,U)$ with values in classical $[0,1]$ that satisfies monotonicity, inclusion-exclusion in the form~\eqref{abinclexcl}, and normalization $\mu_{ab}(A,B,A\times B) = 1$.

What is missing is to show that $\mu_{ab}(S,T,U) = \mu_{ab}(A,B,U)$ for all $S,T,U$, so that $\mu_{ab}$ depends only on $U\subseteq A\times B$, making it into a probability measure in the standard sense. Again by inclusion-exclusion and monotonicity, this equation is equivalent to $\mu_{ab}(A,B,\emptyset) = 0$. But this equation is also automatic thanks to inclusion-exclusion,
\[
	\mu_{ab}(A\cap \emptyset, \emptyset \cap B, \emptyset) + \mu_{ab}(A\cup \emptyset, \emptyset \cup B, \emptyset) = \mu_{ab}(A, \emptyset, \emptyset) + \mu_{ab}(\emptyset, B, \emptyset).
\]
We have already shown that both terms on the right-hand side must vanish, and the first term on the left vanishes trivially. Therefore $\mu_{ab}(A,B,\emptyset) = 0$, as was to be shown.
\end{proof}

What David sees as the most interesting part of the above proof is the last step, that $\mu_{ab}(S,T,U) = \mu_{ab}(A,B,U)$ for all $S,T,U$. Here's how that looks logically.

Recall that $\See{[0,n]}P\coloneqq(t\apart [n,0])\vee P$, where $t\apart[a,b]$ means $(b+1\leq t)\vee(t\leq a-1)$. So $\See{[0,n]}P=(1\leq t)\vee(t\leq n-1)\vee P$. Recall also that $\mu(P)$ is formally a function on rationals, $\mu(P):\tQQ\to\Prop$; if $\mu(P)(q)$ holds, we think ``$q<\mu(P)$''. So for example, down-closure says $(q'<q\wedge\mu(P)(q))\imp\mu(P)(q')$. In $\tRR_{\SeeInline{[0,n]}}$, the $\See{[d,u]}$-(nonnegative lower reals), $\See{[d,u]}\bot$ is the unit for addition.

\begin{theorem}\label{thm.logical_reformulation}
\[\See{[0,n]}\mu(P)=\See{[0,n]}\mu(\See{[0,n]}P).\]
\end{theorem}
\begin{proof}
We have $\mu(P)+\mu(\See{[0,n]}\bot)=\mu((\See{[0,n]}\bot)\wedge P)+\mu(\See{[0,n]} P)$. Since $\See{[0,n]}$ commutes with addition, it suffices to show $\See{[0,n]}\mu(\See{[0,n]}\bot)=\See{[0,n]}\mu((\See{[0,n]}\bot)\wedge P)$. But $\See{[0,n]}\bot\leq\See{[0,n]}\mu(\See{[0,n]}\bot\wedge P)\leq\See{[0,n]}\mu(\See{[0,n]}\bot)$, so it suffices to show that $\See{[0,n]}\mu(\See{[0,n]}\bot)\leq\See{[0,n]}\bot$. We also have
\[\mu(\See{[0,n]}\bot)+\mu(1\leq t\leq n-1)=\mu(1\leq t)+\mu(t\leq n-1),\]
so it suffices to show that $\See{[0,n]}\mu(1\leq t)\leq\See{[0,n]}\bot$ and $\See{[0,n]}\mu(t\leq n-1)\leq\See{[0,n]}\bot$. 

These are similar, so we show the first, and since $\See{[0,n]}$ is a modality, it suffices to show that $\mu(1\leq t)(q)\imp\See{[0,n]}\bot$ for any $q\in\QQ_{\geq0}$. So suppose $\mu(1\leq t)(q)$.

By an axiom of discrete temporal type theory (analogous to Axiom 3a in TTT), we have $\neg(t\leq 0)\imp (1\leq t)$ [and similarly $\neg(n\leq t)\imp(t\leq n-1)$]. Since $(1\leq t)\imp\See{[0,n]}\bot$, it suffices to show $\neg(t\leq 0)$, so assume $t\leq 0$. Then $\mu(1\leq t)=\mu(\bot)$, so $\mu(1\leq t)(q)=\mu(\bot)(q)=\bot$. This completes the proof.\end{proof}

\todo[inline]{Do we generally expect it to be the case that $\mu(P) = P$, or at least $\mu(P) \leq P$, for every proposition $P$? Because then we would get
\[
	\mu(1 \leq t) \leq \mu(\See{[0,n]} \bot) \leq \See{[0,n]} \bot,
\]
and therefore directly $\See{[0,n]} \mu(1 \leq t) \leq \See{[0,n]} \bot$, since applying $\See{[0,n]}$ to a lower real is the internal left adjoint to $\RR \rightarrow \RR_{\SeeInline{[0,n]}}$. (Right?) Or is this argument begging the question?}

\paragraph{May 9}

The following can surely be phrased more generally, but I'm writing it as follows for speed/assurance reasons. For any nonnegative lower real $x:\tLR$, let $\bar{x}\coloneqq\min(x,1)$.

\begin{proposition}
Let $[d,u]$ be a point in $\BaseTopos$, let $X$ be a type, and let $\mu\colon\Prop^X\to\tLR$ be a valuation. Then
\[\mu(\At{[d,u]}P)=\ol{\At{[d,u]}\mu(\At{[d,u]}P)}.\]
\end{proposition}
\begin{proof}
By TTT, we have $\top=(\At{[d,u]}P\vee(P\imp\At{[d,u]}\bot))$; this and the fact that $\At{[d,u]}$ commutes with addition, are the only assumptions we use.

Clearly $\mu(\At{[d,u}P)\leq\At{[d,u]}(\mu(\At{[d,u]}P))$ and $\mu(P\imp\At{[d,u]}\bot)\leq\At{[d,u]}\mu(P\imp\At{[d,u]}\bot)$. By inclusion-exclusion we have
\[\mu(\At{[d,u]}P)+\mu(P\imp\At{[d,u]}\bot)=\mu(\At{[d,u]}\bot)+\mu(\top).\]
Since $\At{[d,u]}\bot$ is a constant predicate, we have $\mu(\At{[d,u]}\bot)=i(\At{[d,u]}\bot)=\ol{\At{[d,u]}0}$, by \cref{prop.unique_NCV_on_prop}. So we have 
\begin{align*}
	\ol{\At{[d,u]}0}+1
	&=\mu(\At{[d,u]}P)+\mu(P\imp\At{[d,u]}\bot)\\
	&\leq\At{[d,u]}\mu(\At{[d,u]}P)+\At{[d,u]}\mu(P\imp\At{[d,u]}\bot)\\
	&=\ol{\At{[d,u]}0}+\ol{\At{[d,u]}1}=\ol{\At{[d,u]}0}+1
\end{align*}
because $\At{[d,u]}$ commutes with addition, and thus the inequality becomes an equality. We are done (believing that $\tLR$ is order-cancellative) , $x\leq x'$ and $y\leq y'$ and $x+y=x'+y'$ implies $x=x'$ and $y=y'$.
\end{proof}

The following holds for any open modality $T\imp-$.
\begin{proposition}\label{prop.In_NCV}
\[\In{[d,u]}\mu(\In{[d,u]}P)=\In{[d,u]}\mu(P).\]
\end{proposition}
\begin{proof}
This is just naturality; recall that $\In{[d,u]}P\coloneqq T\imp P$ for some $T$. One direction is obvious, so suppose $T\imp\mu(T\imp P)$; we want to show $T\imp\mu(P)$. But assuming $T$ we have $\mu(T\imp P)$ which is the same as $\mu(P)$.
\end{proof}

\begin{proposition}
\[\mu(P)=\inf_{d< u}\At{[d,u]}\mu(P).\]
\end{proposition}
\begin{proof}
This is the axiom that our topos has enough points. The right-hand side, applied to some $q:\tQQ$, is translated to
\[\forall(d,u:\tRR)\ldotp d<u\imp\At{[d,u]}(q<\mu(P)),\]
which is $q<\mu(P)$ by TTT axiom 8.
\end{proof}

\begin{proposition}\label{prop.valuations_OR}
Suppose $P:\Prop$ and $Q:X\to\Prop$ for some $X$. Then
\[\mu(P\vee Q)=\ol{P\vee\mu(Q)}.\]
\end{proposition} 
\begin{proof}
The $\geq$ direction is trivial, so we want to show the $\leq$ direction, that $\mu(P\vee Q)(q)\leq P\vee\mu(Q)(q)$ for all $q:\tQQ$.

It is enough to show $P\vee\mu(P\vee Q)\leq P\vee\mu(Q)$. By inclusion-exclusion we have $\mu(P\vee Q)+\mu(P\wedge Q)=\mu(P)+\mu(Q)$ and any modality, including $(P\vee-)$, commutes with addition. Hence, by order-cancellativity \cref{rem.order_canc}, it is enough to show $P\vee\mu(P)\leq P\vee\mu(P\wedge Q)$.
For this it suffices to show $\mu(P)\leq P\vee\mu(P\wedge Q)$, but by \cref{prop.unique_NCV_on_prop}, the left-hand side is just $P$.
\end{proof}


\begin{proposition}
For all $d'<d\leq u<u'$ and $P\colon X\to\Prop$ we have
\[\At{[d,u]}\mu(P)=\At{[d,u]}\mu(\In{[d',u']}P).\]
\end{proposition}
\begin{proof}
One direction is trivial. For any $q:\tQQ$ we have
\begin{align*}
	\At{[d,u]}\mu(\In{[d',u']}P)(q)
	&\imp\At{[d,u]}\In{[d',u']}\mu(\In{[d',u']}P)(q)\\
	&=\At{[d,u]}\In{[d',u']}\mu(P)(q)&\text{\cref{prop.In_NCV}}\\
	&\imp\At{[d,u]}\At{[d,u]}\mu(P)(q)&\text{\cite[Prop 5.39]{Schultz.Spivak:2017a}}\\	
	&=\At{[d,u]}\mu(P)(q).
\end{align*}
\end{proof}

\begin{remark}\label{rem.order_canc}
Semantically, the lower-reals on $\IR$ are order-cancellative in the sense that if $a+b\leq a+c$ then $b\leq c$. We haven't proven this internally.
\end{remark}

\paragraph{May 10}

For any predicate $f:\Prop\to\Prop$, the infimum is $\forall(P:\Prop)\ldotp(fP\imp P)$.

\begin{lemma}
For any modality $j$, the type $\Prop_j$ is closed under infima. That is, for any $f:\Prop_j\to\Prop$
\[(j\forall(P:\Prop_j)\ldotp fP\imp P)\imp\forall(P:\Prop_j)\ldotp fP\imp P.\]
\end{lemma}
\begin{proof}
Assume $j\forall P\ldotp fP\imp P$, and move the $j$ inside the $\forall$ and the implication, to obtain $\forall P\ldotp fP\imp jP$. To prove $\forall(P:\Prop_j)\ldotp fP\imp P$, take any $P:\Prop_j$. Then we have $jP$ by assumption, which implies $P$ by $j$-closure.
\end{proof}

\subsection{Restating the conjecture}

An internal continuous normalized valuation $\mu\colon\Prop^X\to\tLR$ on $\cat{E}$ gives rise to an external monotonic map
\[|\mu|\colon\cat{E}(X,\Omega)\times\pt(\cat{E})\to\LR\]
that is Scott continuous (at least in each variable) and a CNV for each point $a\in\pt(\cat{E})$.

Consider the case where $B$ is a compact space, $CB$ is its space of compacts, and $\cat{E}=\Shv(CB)$. In this case, if $X\in\cat{E}$ is a sheaf, then evaluation at $B$ is the same thing as taking global sections, $X(B)\cong\Gamma(X)$; we denote it by $|X|$.

\begin{lemma}\label{lemma.inequality_rand9865}
Let $\cat{E}$ be above. For any point $a\in\pt(\cat{E})$ and predicate $P:X\to\Prop$, we have
\[
\sup_{a\in U}|\mu(\At{B}\In{U}P)|\leq |\mu|(\,|P|,a\,).
\]
\end{lemma}
\begin{proof}
The proof uses a few facts:
\begin{enumerate}
	\item The fact that $B$ is Scott-minimal is internally expressed as an equivalence of modalities, $\At{B}=\See{B}$.
	\item $\See{B}\mu(P)=\mu(\See{B}P)$ by \cref{prop.valuations_OR}
	\item for any point $a\in U$, evaluating at that point we get $(\In{U}P)(a)=P(a)$ and $(\See{a}P)(a)=P(a)$.
\end{enumerate}
We have now established the following:
\begin{align}
\nonumber
	\sup_{a\in U}|\mu(\At{B}\In{U}P)|
	&\coloneqq\sup_{a\in U}\mu(\At{B}\In{U}P)(B)\\
	&=\sup_{a\in U}\mu(\See{B}\In{U}P)(B)&\text{item 1}\\\nonumber
	&=\sup_{a\in U}\See{B}\mu(\In{U}P)(B)&\text{item 2}\\\nonumber
	&=\sup_{a\in U}\mu(\In{U}P)(B)&\text{item 3}\\\nonumber
	&\leq\sup_{a\in U}\mu(\In{U}P)(a)&\text{increasing}\\\nonumber
	&=\sup_{a\in U}\In{U}\mu(\In{U}P)(a)&\text{item 3}\\\nonumber
	&=\sup_{a\in U}\In{U}\mu(P)(a)&\text{\cref{prop.In_NCV}}\\\nonumber
	&=\mu(P)(a)&\text{item 3}
\end{align}
\end{proof}

We are ready to prove that we can recover the external CNV $|\mu|$ from various global sections of $\mu$. The one caveat is that we need to ``internalize the sup''; we will point that out below.

\begin{theorem}\label{thm.discrete_internal_space}
Let $B$ be a compact space, $CB$ is its space of compacts, and $\cat{E}=\Shv(CB)$. For any point $a\in\pt(\cat{E})$ and predicate $P:X\to\Prop$, we have
\[
|\mu|(\,|P|,a\,)=\sup_{U\ni a}|\mu(\At{B}\In{U}P)|.
\]
\end{theorem}
\begin{proof}
By \cref{lemma.inequality_rand9865}, we have $\sup_{U\ni a}|\mu(\At{B}\In{U}P)|\leq |\mu|(\,|P|,a\,)$ for any $P$. \emph{Internalizing the sup}, 
\[\big(\sup_{U\ni a}\mu(\In{U}P)\big)(B)\leq\big(\sup_{U\ni a}\mu(\In{U}P)\big)(a)\]
Here the (internalized) sup is just shorthand: $\sup_{U\ni a}X(U)\coloneqq \exists U\ldotp \At{a}U\wedge X(U)$. This is a directed sup, so by continuity, we have
\[\mu(\exists U\ldotp \At{a}U\wedge\In{U}P)(B)\leq\mu(\exists U\ldotp \At{a}U\wedge\In{U}P)(a).\]

Now we use one of our favorite tricks: we apply the above inequality to both $P$ and $P\imp\At{a}\bot$, then add them and use inclusion-exclusion.
We obtain something of the form $X(B)+Y(B)\leq X(a)+Y(a)$, where
\begin{align*}
	X\coloneqq\mu\Big((\exists U\ldotp \At{a}U\wedge\In{U}P)\wedge\big(\exists U\ldotp \At{a}U\wedge\In{U}(P\imp\At{a}\bot)\big)\Big)\\
	X\coloneqq\mu\Big((\exists U\ldotp \At{a}U\wedge\In{U}P)\wedge\big(\exists U\ldotp \At{a}U\vee\In{U}(P\imp\At{a}\bot)\big)\Big)	
\end{align*}
We will show that $Y=\top$ and that $X\imp\At{a}\bot$. This will complete the proof because $\mu(\At{a}\bot)(a)=\mu(\At{a}\bot)(B)=0$.

First we show $X\imp\At{a}\bot$. We claim $X\imp\exists U\ldotp \At{a}U\wedge\In{U}(P\wedge P\imp\At{a}\bot)$; indeed, take $U$ to be the conjunction of the existentials from $X$ and use the fact that $\At{a}$ and $\In{U}$ commute with $\wedge$. From here we get $\exists U\ldotp\At{a}U\wedge\In{U}\At{a}\bot$. Since $\In{U}P$ means $U\imp P$, we obtain $\At{a}\bot$ by monotonicity of $\In{U}$ and idempotence of $\At{a}$.

We now show $Y=\top$. By cases we have $\exists U\ldotp\At{a}U\wedge(\In{U}P\vee\In{U}(P\imp\At{a}\bot))\imp Y$. Thus to prove $Y$, it is enough to show that the following existential statement holds:
\[\exists U\ldotp\At{a}U\wedge(\In{U}P\vee(P\imp\At{a}\bot)).\]
By \cite{Schultz.Spivak:2017a} we have De Morgan's, $\At{a}P\vee (P\imp\At{a}\bot)$. In the first case, take $U=P$ and the existential holds. In the second case take $U$ to be any open for which $\At{a}U$ holds. This completes the proof.
\end{proof}

\begin{remark}
The one issue above is ``internalizing the sup''. We think that works, but it's not technically proven. The argument is basically that we can check the following external fact holds about points contained in opens:
\[\big(a\in\church{\exists(U)\ldotp\At{a}U\wedge\In{U}P}\big)\iff\big(\text{there exists $U$ such that $a\in U$ and }a\in\church{\In{U}P}\big).\]
\end{remark}

\paragraph{Other thoughts}

In \cref{thm.discrete_internal_space}, we assume $B$ is compact, but this is not the general case. David wonder's if the correct modality to use, rather than $\See{B}$ might be $\exists(d,u)\ldotp\See{[d,u]}P$.
\begin{lemma}
The map $j:\Prop\to\Prop$, defined by $P\mapsto\exists(d,u)\ldotp\See{[d,u]}P$, is a modality.
\end{lemma}
\begin{proof}
Clearly the proposed function is pointed, $P\imp jP$. To see it is idempotent, assume $jjP$, i.e.\ $\exists(d,u)\ldotp (t\apart[u,d])\vee\exists(d',u')\ldotp(t\apart[u',d'])\vee P$, and proceed by cases to show $jP$. Finally, we must show
\begin{multline*}
	\exists(d,u)\ldotp (t\apart[u,d])\vee(P\wedge Q)\\
	\iff(\exists(d',u')\ldotp (t\apart[u',d'])\vee P\big)\wedge\big(\exists(d'',u'')\ldotp (t\apart[u'',d''])\vee P\big)
\end{multline*}
The $\imp$ direction is easy; for the $\Leftarrow$ direction, take $d\coloneqq\min(d',d'')$ and $u\coloneqq\max(u',u'')$.
\end{proof}

\section{What we can aim for}

Tentative setup, to be adjusted: let $B$ be a topological space (say, T1), $G$ a group that acts on $B$, and $K$ a $G$-invariant collection of compact sets in $B$ that includes all singletons and is closed in the upper Vietoris topology (that we equip $K$ with), and such that every compact set in $B$ is contained in some element of $K$. Whatever setup we use, it should cover the following two cases that are of main interest:

\begin{enumerate}
\item $B = \RR$ with $K = \mathbb{IR}$, where $G$ is either trivial or the translation group; this should give a topos-theoretic formulation of (stationary) stochastic processes.
\item $B$ a discrete finite space with $K = 2^B$, where $G$ is either trivial or the permutation group; this should give a topos-theoretic formulation of joint distributions of $|B|$ many random variables.
\end{enumerate}

If things go really well, we can also hope to cover one more case that is fundamental to statistical mechanics and quantum field theory:

\begin{enumerate}[resume]
\item $B = \RR^n$ with $K$ e.g.~all compact subsets, where $G$ is again the translation group.
\end{enumerate}

For now, let me formulate the conjecture in the case where $G$ is trivial:

\begin{conjecture}
Every space $p : X\to B$ over $B$ is an internal space in $\Shv(B)$~\cite{Moerdijk:1984a}, but also becomes an internal space in $\Shv(K)$. Global elements of the object of normalized continuous valuations on this space with values in the lower reals of $\Shv(K)$ are in bijection with external normalized continuous valuations on the space of global sections of $p$, equipped with (e.g.) the compact-open topology.
\end{conjecture}

Essentially, the problem is to find suitable hypotheses that make some version of this conjecture correct. Developing a result of this type is mostly a topos-theoretic problem and does not involve technical aspects of measure theory. However, in order to get to the traditional picture of stochastic processes, there is one more step to take:

\begin{conjecture}
Under suitable hypotheses, (external) continuous valuations on the space of global sections of $p : X\to \RR$ are in bijection with stochastic processes taking values in $X$.
\end{conjecture}

\newpage
\chapter{Notes from meetings (to be organized)}

\section{Valuations on $\Prop$}
\paragraph{May 7}
Consider the function $i\colon\Prop\to\tLR$ defined as follows
\[i(P)(q)\coloneqq(q<0)\vee((q<1)\vee P).\]
We next show that it is a normalized continuous valuation (NCV). Later we will show that, under some conditions, it is unique as such.

\begin{proposition}\label{prop.sandwich}
The function $i\colon\Prop\to\tLR$ defined above is indeed an NCV on $\Prop$, and for any NCV $\mu\colon\Prop\to\tLR$, we have $i\leq\mu\leq i\neg\neg$.
\end{proposition}
\begin{proof}[Sketch]
It's not hard to show that $i$ is an NCV. The proof of the inclusion-exclusion formula for $i$ involved using $\max$ and $\min$ in one direction, and using case analysis in the other direction. To show that $i\leq\mu$, one uses monotonicity and normality of $\mu$. To show that $\mu\leq i\neg\neg$, take $P:\Prop$ and $q:\tQQ$ with $0\leq q$; we need to show $\mu(P)(q)\imp\neg\neg P$. Assume $\mu(P)(q)$ and $\neg P$. Then by monotonicity we have $\mu(\bot)(q)$, and by normality ($\mu(\bot)=0)$, this means $q<0$, a contradiction.
\end{proof}

Recall that an open set $U$ in a topological space is called \emph{regular} if it is the interior of its closure, or in other words $\neg\neg U=U$. Because $\neg\neg$ is a dense modality, the set of regular opens contains the whole space, the empty space, and is closed under finite intersections.

\begin{definition}
Say that a topos $\cat{E}$ is \emph{regularly-based} if the following statement holds internally:
\[\forall(P:\Prop)\ldotp P\imp\exists(Q:\Prop)\ldotp (Q\imp P)\wedge(\neg\neg Q\imp Q)\wedge Q.\]
For topological spaces, this is the condition that the regular opens form a basis, i.e.\ for all $P\in\Op$, we have $P=\bigcup_{\{Q\ss P\mid \neg\neg Q=Q\}}Q$.

We say $Q$ is a \emph{regular basis element} if $Q=\neg\neg Q$.
\end{definition}

\begin{proposition}\label{prop.unique_NCV_on_prop}
Suppose that $\cat{E}$ is regularly-based. Then $i\colon\Prop\to\tLR$ is the unique NCV on $\Prop$. 
\end{proposition}
\begin{proof}
Let $\mu$ be an arbitrary valuation; we want to show $\mu=i$. Define a subtype $T\coloneqq\{P:\Prop\mid\mu(P)=i(P)\}$, where $T$ stands for target; we want to show that $T=\Prop$. If $Q$ is a basis element then by \cref{prop.sandwich} we have $i(Q)\leq\mu(Q)\leq i(\neg\neg Q)=i(Q)$, so $Q\in T$.

Next suppose $Q$ is of the form $Q=Q_1\vee Q_2$ for $Q_1,Q_2\in T$. It is not hard to show that $i(Q_1\vee Q_2)=\max(i(Q_1),i(Q_2))$ and $i(Q_1\wedge Q_2)=\min(i(Q_1),i(Q_2))$ by definition of $i$. Thus
\begin{align*}
	i(Q_1\vee Q_2)+i(Q_1\wedge Q_2)
	&\leq\mu(Q_1\vee Q_2)+i(Q_1\wedge Q_2)\\
	&\leq \mu(Q_1\vee Q_2)+\mu(Q_1\wedge Q_2)\\
	&=\mu(Q_1)+\mu(Q_2)\\
	&=i(Q_1)+i(Q_2)
\end{align*}
Since $i(Q_1\vee Q_2)+i(Q_1\wedge Q_2)=i(Q_1)+i(Q_2)$, it follows that $\mu(Q_1\vee Q_2)=i(Q_1\vee Q_2)$, so we have shown $Q\in T$. The argument that $(Q_1\wedge Q_2)\in T$ is similar: just replace $\mu(Q_1\vee Q_2)+i(Q_1\wedge Q_2)$ with $i(Q_1\vee Q_2)+\mu(Q_1\wedge Q_2)$ in the argument above.

Since every join can be decomposed into a directed join of finite joins, by assumption an arbitrary proposition $P:\Prop$ is a directed join of elements in $T$. Thus it suffices to show that $T$ is closed under directed joins, but this is clear: if $(Q_d)_{d\in D}$ is a directed system where $Q_d\in T$ for all $d$ then
\[\mu(\sup_{d\in D}Q_d)=\sup_{d\in D}\mu(Q_d)=\sup_{d\in D} i(Q_d)=i(\sup_{d\in D}Q_d).\qedhere\]
\end{proof}

\begin{example}
The assumption that $\cat{E}$ is regularly based is necessary. For example, consider the topological space where $\NN$ is the set of points and a subset $U\ss\NN$ is open $U\in \Op$ iff it is either empty or cofinite. This space is not regularly-based because the only regular opens are $\emptyset$ and $\NN$; for any other $U$, we have $\neg\neg U=\NN$. Consider the function $\mu\colon\Op\to\LR$ given by
\[\mu(U)=\begin{cases}0&\tn{ if }U=\emptyset\\1&\tn{ if }U\neq\emptyset\end{cases}\]
Then $\mu$ is monotonic, normalized, and commutes with directed joins. It satisfies inclusion exclusion because (three out of four cases are clear and) the intersection of cofinite sets is cofinite, and in particular nonempty.
\end{example}

\begin{remark}
In the book \emph{Counterexamples in Topology} they define semi-regular spaces to be Hausdorff spaces that are regularly-based in our sense above. We are certainly interested in cases where the space is not Hausdorff, e.g.\ $\IR$.

It is not hard to show however that any regular space is regularly-based in our sense.
\end{remark}

\paragraph{May 8}
All left exact functors $F$ preserve internal adjunctions $L\dashv R$. The finite limit preservation ensures that the $F$-image of a category object is a category object, and similarly for functors. But once you have that, the idea is to construct the unit and counit and see that they're preserved. Write down the diagram
\[
\begin{tikzcd}
	\Ob(C)\ar[drr, bend left, "RL"]\ar[ddr, bend right, equal]\ar[dr, "\eta"]\\
	&\Mor(C)\ar[r, "cod"]\ar[d, "dom"]&\Ob(C)\\
	&\Ob(C)
\end{tikzcd}
\]
and similarly for $\epsilon$, and assert the triangle identities; all of this structure will be preserved by $F$.

\section{$f_*$ preserves internal locales and frames?}\label{sec.preserve_loc_frame}
We want to understand why $f_*$ preserves internal locales---the proof in Johnstone is opaque---and similarly for internal frames. An internal poset $A$ has all sups if it is equipped with an adjunction
\[
\begin{tikzcd}
	A\ar[r, shift left, "\down"]&\Prop^A\ar[l, shift left, "\bigvee"]
\end{tikzcd}
\]
So suppose $A$ is an internal locale in $\cat{E}$ and that we have a geometric morphism $f_*\colon\cat{E}\to\cat{F}$. Applying our work above, we get an adjunction
\[
\begin{tikzcd}
	f_*A\ar[r, shift left, "f_*\down"]&f_*(\Prop^A)\ar[l, shift left, "f_*\bigvee"]
\end{tikzcd}
\]
in $\cat{F}$. We also have a map $e\colon f_*(\Prop^A)\to\Prop^{f_*A}$ given by $f_*$ of evaluation followed by the characteristic map for $f_*\true\colon 1\to f_*\Prop$. Thus it suffices to find a left adjoint for $e$.

We produced a candidate left adjoint $e'$ for $e$, but we did not prove it works. However, it seems to work when $f_*$ is a geometric inclusion, i.e.\ when $\cat{E}$ is the category of sheaves for some modality on $\cat{F}$. In that case, we think of $U\coloneqq f_*$ as the underlying presheaf map and $\asSh\coloneqq f^*$ as sheafification. The desired map $e'\colon\Sub_p(UA)\to U\Sub_s(A)$ sends a subpresheaf $X\ss UA$ to the sheaf-theoretic image of its adjunct $\asSh(X)\surj\bullet\inj A$. In other words, $e'$ takes a sub-presheaf to its sheaf-theoretic image; this construction should be left adjoint to $e$.

For an arbitrary $f$, we attempt to repeat this idea. To obtain a map $\Prop^{f_*A}\to f_*(\Prop^A)$, we need a map $A\times f^*(\Prop^{f_*A})\to\Prop$, i.e.\ a subobject of the domain. Form the following diagram, and take the subobject shown on the bottom row:
\[
\begin{tikzcd}
	&\bullet\ar[r]\ar[d, tail]\ar[dr, phantom, very near start, "\lrcorner"]\ar[dddl, two heads, bend right]&1\ar[d]\\
	&f^*(f_*A\times\Prop^{f_*A})\ar[r, "f_*(ev)"]\ar[d, "\cong"']&f^*\Prop\\
	&f^*f_*A\times f^*\Prop^{f_*A}\ar[d, "\epsilon"']\\
	\bullet\ar[r, tail]&A\times f^*\Prop^{f_*A}
\end{tikzcd}
\]
Note that in the subtopos case above, $f^*f_*A\to A$ is an iso, so there is no need for the epi-mono factorization.

We believe that direct image functors $f_*$ preserve the internal structures of DCPOs, complete sup-lattices, and frames. For example, rather than consider $\Prop^P$ we consider $\Idl(P)$ and try to lift the previously (semi-)defined adjunction, as shown:
\[
\begin{tikzcd}
	f_*(\Idl P)\ar[r, shift left, dotted]\ar[d, tail]&\Idl(f_*P)\ar[l, shift left, dotted]\ar[d, tail]\\
	f_*(\Prop^P)\ar[r, shift left]&\Prop^{f_*P}\ar[l, shift left]
\end{tikzcd}
\]

\section{The valuations profunctor}

If $\cat{C}$ is a category with finite limits and small colimits then one can define frames and symmetric monoidal DCPOs internal to $\cat{C}$. From here, one can define normalized complete valuations (NCVs) as a profunctor
\[V_{\cat{E}}\colon\Fun{Frm}(\cat{E})\tickar\Fun{SMonDCPO}(\cat{E})\]
In other words, one can precompose an NCV with a frame morphism on the left or post-compose with a monoidal DCPO map on the right. We will usually refer to this profunctor more simply as the \emph{valuations profunctor}.

The question is how direct image functors $f_*\colon\cat{E}\to\cat{E}'$ interact with the valuations profunctor. What we want is a 2-cell in the double category of categories, functors, and profunctors:
\begin{equation}\label{eqn.direct_image_valuations}
\begin{tikzcd}
	\Fun{Frm}(\cat{E})\ar[r, tick, "V_{\cat{E}}"]\ar[d, "\Fun{Frm}(f_*)"']&\Fun{SMonDCPO}(\cat{E})\ar[d, "\Fun{SMonDCPO}(f_*)"]\\
	\Fun{Frm}(\cat{E}')\ar[r, tick, "V_{\cat{E}'}"']&\Fun{SMonDCPO}(\cat{E}')\ar[ul, phantom, "?\Downarrow"]
\end{tikzcd}
\end{equation}
where the functors on the left and right were (hopefully) established in \cref{sec.preserve_loc_frame}. Intuitively, given a valuation $\mu\colon F\to R$ upstairs, we want to define a valuation $\mu'\colon f_*F\to f_*R$ downstairs. There is an obvious candidate, namely $\mu'\coloneqq f_*\mu$. The question is whether this preserves the various structures.

It should be obvious that $\mu'$ is monotonic. We believe that $\mu'$ will commute with directed joins by the work in \cref{sec.preserve_loc_frame}. Both the top and bottom element of an internal frame can be characterized by an equational theory, so they should be preserved by left-exact functors such as $f_*$. It remains to show that $\mu'$ satisfies inclusion-exclusion.

To begin with, we need to know that $f_*$ commutes with binary joins; but what does this mean? We want to define binary joins equationally on a frame $F$ as $\vee\colon F\times F\to F$, and then ask that $f_*(\vee_F)=\vee_{f_*F}$, but then the question becomes ``in what sense is the binary join operation the same as the actual binary join?'' In other words, what if we're only preserving a structure, not the universal property it is supposed to satisfy?

For any pair of objects $A^B$ in a topos there is a map $\im\colon A^B\to\Prop^A$, that ``sends a map to its image''. Namely, use the predicate $I\colon A\times A^B\to\Prop$ given by $I(a,f)=\exists(b:B)\ldotp f(b)=a$. Thus we get a diagram, and the above questions are whether it commutes:
\[
\begin{tikzcd}
	F\times F\ar[d, equal]\ar[r, "\vee"]&F\\
	F^{1+1}\ar[r, "I"']&\Prop^F\ar[u, "\bigvee"']\ar[ul, phantom, "?"]
\end{tikzcd}
\]
The goal then is to encode the universal property itself in an equational way. Take the graph of the function $\vee\colon F\times F\to F$ and call it $G(\vee)\ss F\times F\times F$. There are two equations that characterize it as the graph of a function, so we know that $f_*$ will send it to the graph of a function, which must again be $f_*(\vee_F)$. We want to characterize its universal property. We thought it is roughly the following:
\[
\begin{tikzcd}
	\{w,x,y,z:F\mid x\leq z, y\leq z, w=x\vee y\}\ar[r]\ar[d]\ar[dd, shift right=40pt, bend right=60pt, dotted]
	&\{w,x,y,z:F\mid (x,y,w)\in G(\vee)\}\ar[d]\\
	\{w,x,y,z:F\mid x\leq z, y\leq z\}\ar[r]&\{w,x,y,z:F\}\ar[ul, phantom, very near end, "\lrcorner"]\ar[d]\\
	\{w,z\mid w\leq z\}\ar[r]&\{w,z:F\}
\end{tikzcd}
\]

Now we have that the direct image map $f_*$ preserves everything that's equationally defined, so we are willing to bet on the following.
\begin{proposition}
A direct image functor $f_*\colon\cat{E}\to\cat{E'}$ preserves valuations in the sense that it induces a 2-cell as shown in \cref{eqn.direct_image_valuations}.
\end{proposition}

\section{Conjecture}

\begin{conjecture}\label{conj.may8}
Let $B$ be a ``nice'' compact space, $CB$ its space of compacts. Let $p\colon X\to CB$ be ``nice'', and consider the internal topological space $(\Gamma(p),p_*\Omega_X)$ in $\Shv(CB)$. Then there is a bijection
\begin{multline*}
  \{\tn{internal NCVs } \mu\colon p_*\Omega_X\to\tLR\}
	\cong\\
	\{\tn{external NCVs } \mu'\colon(\Gamma(p),\tn{ compact-open top})\to\LR\}
\end{multline*}
\end{conjecture}

One special case is when $p$ has no global sections, so that the external set is empty. An even more special case is when $p$ is the inclusion of an open set, and here the conjecture is true.

\begin{proposition}
\cref{conj.may8} holds in the case that $p\colon U\ss CB$ is the inclusion of an open set.
\end{proposition}
\begin{proof}
If $U=CB$ then there is exactly one section, so there is exactly one external valuation, and the result follows from \cref{prop.unique_NCV_on_prop}.

So suppose that $U\neq CB$. Then there are no external NCVs because the set $\Gamma(p)$ is empty. We suppose for contradiction that $\mu\colon p_*\Omega_U\to\tLR$ is an internal valuation. Then composing with the unique internal frame homomorphism $!\colon\Prop\to p_*\Omega_U$, we have an internal valuation $\mu\circ !$ on $\Prop$. By \cref{prop.unique_NCV_on_prop}, we have $\mu\circ!=i$, where $i\colon\Prop\to\tLR$ is the indicator function.

Clearly $\church{i}(U)\neq \church{i}(CB)$, because these functions differ on points in the complement of $U$. But $\church{!}(U)=U\cap U=U\cap CB=\church{!}(CB)$, so $\church{\mu\circ !}(U)=\church{\mu\circ!}(CB)$, a contradiction.
\end{proof}






\newpage

\appendix

\chapter{Another (less satisfactory) attempt}

Tobias: I'm not sure if this is going in the right direction. My idea was that we'd have a sheaf $\tRR_{\EE}$ in which expectation values land, such that a section over $(a,b)$ is either an arbitrary function $\II(a,b)\to\II\RR$, or more specifically such a function which in addition takes maximal elements to maximal elements.

The things that we want to take expectation values of should be \emph{observables} on $X$. In the sheaf of observables, a section over $(a,b)$ should be a function $f:\prod_{(c,d)\subseteq(a,b)} X(c,d)\to\II\RR$ which is suitably monotone, i.e.~such that $(c,d)\sqsupseteq(c',d')$ implies $f(c,d)\sqsupseteq f(c',d')$.

Then taking expectation values should be an internal function $X\to $

\chapter{Riesz approach}

\todo[inline]{T: I now think that the valuations approach is superior, so this got relegated to the appendix}

One idea is to follow the spirit of the Riesz representation theorem (reference?). We could try to define a measure on a type $X$ to be a positive linear functional on the type $(X\to\tRR)$. However, there is a semantic problem with this idea, namely the Dedekind reals $\tRR$ are constant, so the value of a sheaf homomorphism $X\to\tRR$ on a section $x$ must remain constant as we restrict $x$. This is too strong.

One possibility is to replace $\tRR$ with $\tRRat{[d,u]}$ in the above formulation, where $d\leq u$ are elements of $\tRR$.%
\footnote{
It is shown in \cite[Prop 7.9]{Schultz.Spivak:2017a} that there is an isomorphism $\tRRat{[d,u]}\cong\tRR_{\AtInline{[d,u]}}$.
}
The semantics of the sheaf $\tRRat{[d,u]}$ are as follows. For any interval $(a,b)\ss\RR$, if $a<d\leq u<b$ then $\RR\cong\church{\tRRat{[d,u]}}(a,b)$, i.e.\ sections on intervals containing $[d,u]$ are constant reals. If $d\leq a$ or $b\leq u$, then $1\cong\church{\tRRat{[d,u]}}(a,b)$, i.e.\ on intervals missing either endpoint of $[d,u]$ there is exactly one section.

The semantics of an internal function $f:X\to\tRRat{[d,u]}$ is that of a function $\church{X}_{[d,u]}\to\RR$ from the stalk of $X$ at $[d,u]$ to $\RR$. This seems to be what Tobias wanted.

For any $d\leq d'\leq u'\leq u$ and any $P:\Prop$, we have $\See{[d',u']}P\imp\See{[d,u]}P$. This induces a morphism
\begin{equation}
\label{Rlocalize}
	\See{[d,u]}:\tRRat{[d',u']}\to\tRRat{[d,u]}.
\end{equation}

\begin{definition}
Let $X$ be a type. For $d,u\in\tRR$, a \emph{measure on $X$ at $[d,u]$} is defined to be a function $\mu:(X\to\tRRat{[d,u]})\to\tRRat{[d,u]}$%
\footnote{
I guess we want to consider continuous maps from a locale $X$ to the locale of opens in $\tRRat{[d,u]}$?
}
satisfying the following properties:
\begin{enumerate}
	\item Linearity: $\mu(r*f+g)=r*\mu(f)+\mu(g)$ for $r:\tRR$ and $f,g:X\to\tRRat{[d,u]}$.
	\item Positivity: $\mu(f)\geq 0$ whenever $f$ satisfies $\forall x\ldotp f(x)\geq 0$.%
	\footnote{The notation $a\leq b$ here is shorthand for $(b<a)\imp\At{[d,u]}\bot$. The correct notation is $a\leq_{\AtInline{[d,u]}}b$, but this is a bit heavy.
	}
\end{enumerate}
Let $\const{Meas}_{[d,u]}(X)$ denote the type of measures on $X$ at $[d,u]$. A \emph{measure $\mu$ on $X$} consists of a measure $\mu_{[d,u]}\in\const{Meas}_{[d,u]}(X)$ for each $d,u:\tRR$\todo{This quantifies over $u$ and $d$. So the modal operators $\See{[d,u]}$ are a family of functions $\Prop\to\Prop$ indexed internally by pairs $d\leq u$ from the (extended) Dedekind reals? Seems to be in line with TTT Sec 5.3},%
\footnote{Thus $\mu$ is a dependent product type.}
such that
\[\forall(f:X\to\tRRat{[d',u']})\ldotp\See{[d,u]}\mu_{[d',u']}(f)=\mu_{[d,u]}(\See{[d,u]}f)\]
holds for every $d\leq d'\leq u'\leq u$. Let $\const{Meas}(X)$ denote the type of measures on $X$.
\end{definition}

Here, $\See{[d,u]}f$ denotes the function obtained by composition of $f$ with~\eqref{Rlocalize}.

$X\to\tRRat{[d,u]}$ can be interpreted as the type of \emph{observables} supported on the interval $[d,u]$. Concretely, a section of $\Church{X\to\tRRat{[d,u]}}$ over an interval $(a,b)$ which contains $[d,u]$ assigns to every section between $(a,b)$ and $[d,u]$ a real number, in such a way that it is compatible with restriction, which means that the number assigned to a section must be a function of its germ at $[d,u]$. Over an interval $(a,b)$ not containing $[d,u]$, this function type has exactly one section, and the compatibility conditions are trivial. In total, $\Church{X\to\tRRat{[d,u]}}$ is the constant sheaf given by the set of functions\footnote{where $\Church{X}[d,u]$ denotes the stalk.} $\Church{X}[d,u]\to\RR$ on $\downarrow [d,u]$, but looks like the terminal sheaf outside of that. For $f:X\to\tRRat{[d',u']}$, the new function $\See{[d,u]}f$ corresponds to the trivial extension of $f$ to $[d,u]$.

Classically and in the case when $X$ is a sheaf on $\RR$, I'd expect these observables to be (up to continuity conditions) precisely all the random variables that are measurable with respect to the $\sigma$-algebra generated by the $X_t$ for $t\in [d,u]$.

Thus a measure at $[d,u]$ assigns to every observable on $[d,u]$ a real number, which is exactly what we'd expect.

\printbibliography

\end{document}
