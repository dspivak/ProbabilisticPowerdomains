\documentclass[11pt, oneside, article]{memoir}

\settrims{0pt}{0pt} % page and stock same size
\settypeblocksize{*}{32pc}{*} % {height}{width}{ratio}
\setlrmargins{*}{*}{1} % {spine}{edge}{ratio}
\setulmarginsandblock{1in}{1in}{*} % height of typeblock computed
\setheadfoot{\onelineskip}{2\onelineskip} % {headheight}{footskip}
\setheaderspaces{*}{1.5\onelineskip}{*} % {headdrop}{headsep}{ratio}
\checkandfixthelayout



\usepackage{mathtools}
\usepackage{amsthm}
\usepackage{amssymb}
\usepackage{stmaryrd}
\usepackage{bbm}
\usepackage{accents}
\usepackage{newpxtext}
\usepackage[utf8]{inputenc}
\usepackage[varg,bigdelims]{newpxmath}
\usepackage[usenames,dvipsnames]{xcolor}
\usepackage{tikz}
\usepackage{graphicx}
\usepackage{enumitem}
\usepackage{mathpartir}
\usepackage[bookmarks=true, colorlinks=true, linkcolor=blue!50!red, citecolor=orange,
pdfencoding=unicode]{hyperref}
\usepackage[capitalize]{cleveref}
  \newcommand{\creflastconjunction}{, and\nobreakspace}%Make cleveref use serial comma
\usepackage[backend=biber,style = alphabetic]{biblatex}
  \addbibresource{Library20171206.bib}
\usepackage{ebproof}
\usepackage{todonotes}



\crefname{axiom}{Axiom}{Axioms}
\usetikzlibrary{
	cd,
	math,
	decorations.markings,
	positioning,
	arrows.meta,
	shapes,
	calc,
	fit,
	quotes,
	intersections}
\hypersetup{final}
\setlist{nosep}

\tikzset{
   oriented WD/.style={%everything after equals replaces "oriented WD" in key.
      every to/.style={out=0,in=180,draw},
      label/.style={
         font=\everymath\expandafter{\the\everymath\scriptstyle},
         inner sep=0pt,
         node distance=2pt and -2pt},
      semithick,
      node distance=1 and 1,
      decoration={markings, mark=at position .5 with {\arrow{stealth};}},
      ar/.style={postaction={decorate}},
      execute at begin picture={\tikzset{
         x=\bbx, y=\bby,
         every fit/.style={inner xsep=\bbx, inner ysep=\bby}}}
      },
   bbx/.store in=\bbx,
   bbx = 1.5cm,
   bby/.store in=\bby,
   bby = 1.75ex,
   bb port sep/.store in=\bbportsep,
   bb port sep=2,
   % bb wire sep/.store in=\bbwiresep,
   % bb wire sep=1.75ex,
   bb port length/.store in=\bbportlen,
   bb port length=4pt,
   bb min width/.store in=\bbminwidth,
   bb min width=1cm,
   bb rounded corners/.store in=\bbcorners,
   bb rounded corners=2pt,
   bb small/.style={bb port sep=1, bb port length=2.5pt, bbx=.4cm, bb min width=.4cm, bby=.7ex},
   bb/.code 2 args={%When you see this key, run the code below:
      \pgfmathsetlengthmacro{\bbheight}{\bbportsep * (max(#1,#2)+1) * \bby}
      \pgfkeysalso{draw,minimum height=\bbheight,minimum width=\bbminwidth,outer sep=0pt,
         rounded corners=\bbcorners,thick,
         prefix after command={\pgfextra{\let\fixname\tikzlastnode}},
         append after command={\pgfextra{\draw
            \ifnum #1=0{} \else foreach \i in {1,...,#1} {
               ($(\fixname.north west)!{\i/(#1+1)}!(\fixname.south west)$) +(-\bbportlen,0) 
coordinate (\fixname_in\i) -- +(\bbportlen,0) coordinate (\fixname_in\i')}\fi %Define the endpoints 
%of tickmarks
            \ifnum #2=0{} \else foreach \i in {1,...,#2} {
               ($(\fixname.north east)!{\i/(#2+1)}!(\fixname.south east)$) +(-\bbportlen,0) 
coordinate (\fixname_out\i') -- +(\bbportlen,0) coordinate (\fixname_out\i)}\fi;
         }}}
   },
   bb name/.style={append after command={\pgfextra{\node[anchor=north] at (\fixname.north) {#1};}}}
}


\tikzset{
	unoriented WD/.style={
		every to/.style={draw},
		shorten <=-\portlen, shorten >=-\portlen,
		label distance=-2pt,
		thick,
		node distance=\spacing,
		execute at begin picture={\tikzset{
			x=\spacing, y=\spacing}}
		},
	pack size/.store in=\psize,
	pack size = 8pt,
	spacing/.store in=\spacing,
	spacing = \psize,
	link size/.store in=\lsize,
	link size = 2pt,
	port len/.store in=\portlen,
	port len = \lsize,
	pack color/.store in=\pcolor,
	pack color=blue,
	surround sep/.store in=\ssep,
	surround sep=\psize,
	link/.style={
		circle,
		anchor=center,
		draw=black,
		fill=black,
		inner sep=0pt,
		minimum size=\lsize
	},
	pack/.style={
		circle,
		anchor=center,
		draw = \pcolor!50!black,
		fill = \pcolor!20,
		inner sep = .25*\psize,
		minimum size = \psize
	},
	outer pack/.style={
		ellipse,
		anchor=center,
		draw,
		inner sep=\ssep,
		color=\pcolor!50!black,
	},
	intermediate pack/.style={
		ellipse,
		anchor=center,
		dashed,
		draw,
		inner sep=\ssep,
		color=\pcolor!50!black,
	},
}

\newcommand{\mypic}[4]{
	\node (lend) {};
	\node [right=#1 of lend] (L) {#4};
	\node [right=#2 of L] (R) {#4};
	\node [right=#1 of R] (rend) {};
	\node at ($(L)!.5!(R)+(0,#2/2)$) (M) {};
	\draw[thick, black, #3] (L.center) -- (M.center) -- (R.center);
	\fill[fill=black!15] (L.center) -- (M.center) -- (R.center) -- cycle;
	\draw[thick, <->] (lend) -- (rend);
}


\theoremstyle{plain}
\newtheorem{theorem}{Theorem}[chapter] %change [] to chapter if we want to change global numbering
\newtheorem{proposition}[theorem]{Proposition}
\newtheorem{corollary}[theorem]{Corollary}
\newtheorem{lemma}[theorem]{Lemma}
\newtheorem{conjecture}[theorem]{Conjecture}

\theoremstyle{definition}
\newtheorem{definition}[theorem]{Definition}
\newtheorem{construction}[theorem]{Construction}
\newtheorem{notation}[theorem]{Notation}
\newtheorem{axiom}{Axiom}
\newtheorem*{axiom*}{Axiom}

\theoremstyle{remark}
\newtheorem{example}[theorem]{Example}
\newtheorem{remark}[theorem]{Remark}
\newtheorem{warning}[theorem]{Warning}

\setcounter{axiom}{-1}

% Renewed commands

\renewcommand{\ss}{\subseteq}

% Macros %
\DeclarePairedDelimiter{\church}{\llbracket}{\rrbracket}
\DeclarePairedDelimiter{\Church}{\llbracket}{\rrbracket}
\DeclarePairedDelimiter{\subtype}{[}{]}

\DeclareMathOperator{\id}{id}
\DeclareMathOperator{\Hom}{Hom}
\DeclareMathOperator{\Mor}{Mor}
\DeclareMathOperator*{\colim}{colim}
\DeclareMathOperator{\im}{im}
\DeclareMathOperator{\Ob}{Ob}


\newcommand{\const}[1]{\mathtt{#1}}
\newcommand{\Set}[1]{\mathrm{#1}}
\newcommand{\cat}[1]{\mathcal{#1}}
\newcommand{\Cat}[1]{\mathbf{#1}}
\newcommand{\fun}[1]{\mathit{#1}}
\newcommand{\Fun}[1]{\mathsf{#1}}
\newcommand{\mach}[1]{\mathcal{#1}}


\newcommand{\cocolon}{:\!}
\newcommand{\iso}{\cong}
\newcommand{\To}[1]{\xrightarrow{#1}}
\newcommand{\Too}[1]{\xrightarrow{\;\;#1\;\;}}
\newcommand{\from}{\leftarrow}
\newcommand{\From}[1]{\xleftarrow{#1}}
\newcommand{\Fromm}[1]{\xleftarrow{\;\;#1\;\;}}
\newcommand{\surj}{\twoheadrightarrow}
\newcommand{\inj}{\rightarrowtail}
\newcommand{\wavyto}{\rightsquigarrow}

\newcommand{\tn}[1]{\textnormal{#1}}
\newcommand{\ol}[1]{\overline{#1}}
\newcommand{\ul}[1]{\underline{#1}}
\newcommand{\wt}[1]{\widetilde{#1}}
\newcommand{\ubar}[1]{\underaccent{\bar}{#1}}


\newcommand{\internal}[1]{\raisebox{-.03ex}{$\mathbbmtt{#1}$}}
\newcommand{\hs}{\hspace{1.1pt}}


\newcommand{\NN}{\mathbb{N}}
\newcommand{\PP}{\mathbb{P}}
\newcommand{\QQ}{\mathbb{Q}}
\newcommand{\RR}{\mathbb{R}}
\newcommand{\VV}{\mathbb{V}}
\newcommand{\ZZ}{\mathbb{Z}}
\newcommand{\LR}{\ul{\mathbb{R}}}

\newcommand{\tNN}{\internal{N}\hs}
\newcommand{\tQQ}{\internal{Q}\hs}
\newcommand{\tQQp}{\tQQ_{+}}
\newcommand{\tZZ}{\internal{Z}\hs}
\newcommand{\tQQub}{\QQ^\infty}
\newcommand{\tRR}{\internal{R}\hs}
\newcommand{\tIR}{\internal{I\hs R}\hs}
\newcommand{\tII}{\bar{\ubar{\tRR}}\hs}
\newcommand{\tLR}{\ubar{\tRR}\hs}
\newcommand{\tUR}{\bar{\tRR}\hs}
\newcommand{\tRRub}{\tRR^\infty}
\newcommand{\tIRub}{\internal{I\hs R}^\infty}
\newcommand{\tLRub}{\ubar{\tRR}^{\infty}}
\newcommand{\tURub}{\bar{\tRR}^{\infty}}
\newcommand{\tIIub}{\bar{\ubar{\tRR}}^{\infty}}

\newcommand{\tRRat}[1]{\tRR_{\SeeInline{#1}}}


\newcommand{\tConst}{\mathtt{C}}
\newcommand{\ShFun}[1]{\mathrm{Fn}(#1)}

\newcommand{\Ind}[1]{\Fun{Ind}\tn{-}#1}
\newcommand{\Psh}[1]{\Fun{Psh}(#1)}
\newcommand{\Shv}[1]{\Fun{Shv}(#1)}
\newcommand{\Cont}[1]{\Fun{Cont}(#1)}

\newcommand{\Prop}{\const{Prop}}
\newcommand{\Time}{\const{Time}}
\newcommand{\unit}{\const{1}}
\newcommand{\Poset}{\Cat{Poset}}
\renewcommand{\Top}{\Cat{Top}}
\renewcommand{\C}{\Cat{C}}

\newcommand{\op}{^\tn{op}}
\newcommand{\el}[1]{\tn{el}#1}
\newcommand{\asSh}{\Fun{sh}}

\newcommand{\restrict}[2]{#1\big|\hspace{0in}_{#2}}
\newcommand{\restrictsm}[2]{#1|\hspace{0in}_{#2}}

\newcommand{\Pointwise}{\pi}
\newcommand{\AtSymbol}{{@}}
\newcommand{\SeeSymbol}{{\down}}  % Old: \xi
\newcommand{\InSymbol}{{\upclose}}% Old: \iota
\newcommand{\At}[2][]{\AtSymbol^{#1}_{#2}}
\newcommand{\See}[2][]{\SeeSymbol^{#1}_{#2}}
\newcommand{\In}[2][]{\InSymbol^{#1}_{#2}}
\newcommand{\AtInline}[1]{@{#1}}
\newcommand{\SeeInline}[1]{\SeeSymbol{#1}}
\newcommand{\InInline}[1]{\InSymbol{#1}}


\newcommand{\sqss}{\sqsubseteq}
\newcommand{\specupclose}{{\uparrow}}
\newcommand{\specdownclose}{{\downarrow}}
\newcommand{\upclose}{{\rotatebox[origin=c]{90}{$\twoheadrightarrow$}}}
\newcommand{\downclose}{{\rotatebox[origin=c]{90}{$\twoheadleftarrow$}}}
\newcommand{\down}{\mathord{\downarrow}}
\newcommand{\up}{\mathord{\uparrow}}

\newcommand{\imp}{\Rightarrow}
\renewcommand{\iff}{\Leftrightarrow}


\newcommand{\erase}[1]{}

\linespread{1.2}
\allowdisplaybreaks
\setsecnumdepth{subsection}
\settocdepth{section}
\setlength{\parindent}{15pt}

%%%%%%%%%%%%% Document %%%%%%%%%%%%%
\begin{document}

\title{Notes on probabilistic powerdomains in a sheaf topos}

\author{Tobias and David}

\maketitle

\tableofcontents*


%%%%%%%%% Chapter %%%%%%%%%
\chapter{Type theory stuff}

\begin{notation}
We write $\tQQp\coloneqq\{q:\tQQ\mid q\geq0\}$. Given a function $P:X\to\Prop$, we write $\subtype{P}\ss X$ to denote the associated subtype, $\subtype{P}\coloneqq\{x:X\mid Px\}$.
\end{notation}

\begin{definition}
Let $X$ be a type. A \emph{poset structure on $X$} is a function $L:X\times X\to\Prop$ satisfying
\begin{enumerate}
	\item $\forall(x:X)\ldotp L(x,x)$.
	\item $\forall(x,y,z:X)\ldotp L(x,y)\imp L(y,z)\imp L(x,z)$.
\end{enumerate}
We usually denote $L(x,y)$ as $x L y$. We call $(X,L)$ a \emph{poset}.
\end{definition}

In terms of sheaf semantics on some site $(\C,J)$, an internal poset is the same thing as a sheaf with values in $\Poset$; since the theory of posets is essentially algebraic, this is a consequence of Diaconescu's theorem, but it is also instructive to check it by hand.

\begin{example}
For any type $Y$, the type $\Phi\coloneqq (Y\to\Prop)$ has a natural poset structure given by $\lambda(f,g:Y\to\Prop)\ldotp\forall(y:Y)\ldotp (fy\imp gy)$.
\end{example}

\begin{example}
The type $\tLR$ of nonnegative lower real numbers is defined as the type of functions $\delta:\tQQp\to\Prop$ satisfying the following:
\begin{description}
	\item[\quad\parbox{1in}{Down-closed:}] $\forall(q,q':\tQQp)\ldotp (q<q')\imp\delta q'\imp\delta q$.
	\item[\quad\parbox{1in}{Rounded:}] $\forall(q:\tQQp)\ldotp\delta q\imp\exists(q':\tQQ)\ldotp(q<q')\wedge\delta q'$.
\end{description}
The type $\tLR$ has the structure of an ordered semi-ring. That is, it has the structure of
\begin{itemize}
	\item a poset: $\delta\leq \delta'\iff\forall q\ldotp\delta q\imp\delta'q$,
	\item a commutative monoid $(0,+)$:
	\begin{itemize}
		\item identity $0$ given by $\lambda q\ldotp \bot$,
		\item  addition given by $(\delta_1+\delta_2)q\iff\exists(q_1,q_2)\ldotp(q<q_1+q_2)\wedge\delta_1q_1\wedge\delta_2q_2$,
	\end{itemize}
	\item a commutative monoid $(1,*)$:
	\begin{itemize}
		\item identity $1$ given by $\lambda q\ldotp q<1$,
		\item multiplication given by $(\delta_1*\delta_2)q\iff\exists(q_1,q_2)\ldotp(q<q_1*q_2)\wedge\delta_1q_1\wedge\delta_2q_2$,
	\end{itemize}
\end{itemize}
where multiplication distributes over addition, and both preserve order.
\end{example}

\begin{definition}
Let $(X,\leq)$ be a poset. A subtype $D:X\to\Prop$ is called \emph{directed} if it satisfies the following:
\begin{enumerate}
	\item $\exists(x:X)\ldotp Dx$.
	\item $\forall(x,y:\subtype{D})\ldotp\exists(z:\subtype{D})\ldotp(x\leq z)\wedge (y\leq z)$.
\end{enumerate}
Denote the conjunction of these two conditions as $\const{Drct}:(X\to\Prop)\to\Prop$.
\end{definition}

\begin{definition}
Let $(X,\leq)$ be a poset and let $P:X\to\Prop$ be a subtype. A \emph{join} of $P$ is an element $s_P:X$ satisfying
\begin{enumerate}
	\item $\forall(x:\subtype{P})\ldotp x\leq s_P$.
	\item $\forall(s':X)\ldotp[\forall(x:\subtype{P})\ldotp x\leq s']\imp s_P\leq s'$.
\end{enumerate}
Similarly, a \emph{meet} of $P$ is an element satisfying the dual statements (the arguments to every $\leq$ symbol are swapped).

We say that $X$ has \emph{binary joins} (resp.\ \emph{binary meets}) if, for every $x_1,x_2:X$ the subtype $\lambda(x:X)\ldotp (x=x_1) \vee (x=x_2)$ has a join, in which case we denote it $x_1\vee x_2$ (resp.\ meet $x_1\wedge x_2$). 

We say that $X$ has a \emph{bottom element} if $\lambda(x:X)\ldotp \bot$ has a join, in which case we denote it $\varnothing:X$. We say that $X$ has \emph{finite joins} if $X$ has binary joins and a bottom element (resp.\ binary meets and a top element). We say that $X$ has \emph{directed joins} if, every directed $P$ has a join, denoted $\sup P$.
\end{definition}

\begin{example}
For any type $Y$, the poset $\Phi\coloneqq Y\to\Prop$ has all joins and meets. The join of $P:\Phi\to\Prop$ is $s_P\coloneqq\lambda(y:Y)\ldotp\exists(\phi:\subtype{P})\ldotp\phi y$. It is easy to check that this satisfies the conditions of being a join. The meet of $P$ is $\lambda(y:Y)\ldotp\forall(\phi:\subtype{P})\ldotp\phi y$.
\end{example}

\begin{example}
The poset $(\tLR,\leq)$ has arbitrary joins: the join of $P:\tLR\to\Prop$ is $\lambda q\ldotp\exists(\delta:\subtype{P})\ldotp\delta q$. Note that $0$ is the bottom element. It also has binary meets: $\min(\delta_1,\delta_2)q\iff(\delta_1 q\wedge \delta_2q)$.

In fact, it also has arbitrary meets, though I don't think we'll need that. The meet of $P:\tLR\to\Prop$ is $(\bigwedge P)q\iff\exists q'\ldotp (q<q')\wedge\forall(\delta:\subtype{P})\ldotp\delta q'$.
\end{example}

\begin{definition}
We say that a poset $(X,\leq)$ \emph{has valuations} \todo{Feel free to suggest better terminology; I just don't want to repeat "binary meets, finite joins, directed joins".}if it has binary meets, finite joins, and directed joins.

Suppose $(X,\leq)$ has valuations. A \emph{valuation} on $X$ is a function $\mu:X\to\tLR$ satisfying the following:
\begin{enumerate}
	\item $\mu(\varnothing)=0$.
	\item $\forall(x,x':X)\ldotp(x\leq x')\imp\mu(x)\leq\mu(x')$.
	\item $\forall(x,x':X)\ldotp\mu(x)+\mu(x')=\mu(x\vee x')+\mu(x\wedge x')$.
	\item $\forall(D:X\to\Prop)\ldotp\const{Drct}(D)\imp \mu(\sup(D))=\sup(\mu(D))$.
\end{enumerate}
Here, $\mu(D)$ is shorthand for the subtype $\mu(D)=\{\mu x\mid Dx\}$.%
\footnote{Completely formally, $\mu(D)\coloneqq\{r:\RR\mid\exists(x:\subtype{D})\ldotp r=\mu(x)\}$.}

Let $\VV(X)$ denote the type of valuations $\mu$, ordered by $(\mu\leq\mu')\iff\forall(x:X)\ldotp(\mu x\leq \mu'x)$.
\end{definition}

Note that if $(X,\leq)$, this does not guarantee that $(\VV(X),\leq)$ does.

%%%%%%%%% Chapter %%%%%%%%%
\chapter{Riesz approach}

One idea is to follow the spirit of the Riesz representation theorem (reference?). We could try to define a measure on a type $X$ to be a positive linear functional on the type $(X\to\tRR)$. However, there is a semantic problem with this idea, namely the Dedekind reals $\tRR$ are constant, so the value of a sheaf homomorphism $X\to\tRR$ on a section $x$ must remain constant as we restrict $x$. This is too strong.

One possibility is to replace $\tRR$ with $\tRRat{[d,u]}$ in the above formulation, where $d\leq u$ are elements of $\tRR$.%
\footnote{
It is shown in \cite[Prop 7.9]{Schultz.Spivak:2017a} that there is an isomorphism $\tRRat{[d,u]}\cong\tRR_{\AtInline{[d,u]}}$.
}
The semantics of the sheaf $\tRRat{[d,u]}$ are as follows. For any interval $(a,b)\ss\RR$, if $a<d\leq u<b$ then $\RR\cong\church{\tRRat{[d,u]}}(a,b)$, i.e.\ sections on intervals containing $[d,u]$ are constant reals. If $d\leq a$ or $b\leq u$, then $1\cong\church{\tRRat{[d,u]}}(a,b)$, i.e.\ on intervals missing either endpoint of $[d,u]$ there is exactly one section.

The semantics of an internal function $f:X\to\tRRat{[d,u]}$ is that of a function $\church{X}_{[d,u]}\to\RR$ from the stalk of $X$ at $[d,u]$ to $\RR$. This seems to be what Tobias wanted.

For any $d\leq d'\leq u'\leq u$ and any $P:\Prop$, we have $\See{[d',u']}P\imp\See{[d,u]}P$. This induces a morphism
\[\See{[d,u]}:\tRRat{[d',u']}\to\tRRat{[d,u]}.\]

\begin{definition}
Let $X$ be a type. For $t:\Time$ and $d,u\in\tRR$, a \emph{measure on $X$ at $[d,u]$} is defined to be a function $\mu:(X\to\tRRat{[d,u]})\to\tRRat{[d,u]}$ satisfying the following properties:
\begin{enumerate}
	\item Linearity: $\mu(f+g)=\mu(f)+\mu(g)$ for $f,g:X\to\tRRat{[d,u]}$.
	\item Positivity: $\mu(f)\geq 0$ whenever $f$ satisfies $\forall x\ldotp f(x)\geq 0$.%
	\footnote{The notation $a\leq b$ here is shorthand for $(b<a)\imp\At{[d,u]}\bot$. The correct notation is $a\leq_{\AtInline{[d,u]}}b$, but this is a bit heavy.
	}
\end{enumerate}
Let $\const{Meas}_{[d,u]}(X)$ denote the type of measures on $X$ at $[d,u]$. A \emph{measure $\mu$ on $X$} consists of a measure $\mu_{[d,u]}\in\const{Meas}_{[d,u]}(X)$ for each $d,u:\tRR$,%
\footnote{Thus $\mu$ is a dependent product type.}
such that
\[\forall(f:X\to\tRRat{[d',u']})\ldotp\See{[d,u]}\mu_{[d',u']}(f)=\mu_{[d,u]}(\See{[d,u]}f)\]
holds for every $d\leq d'\leq u'\leq u$. Let $\const{Meas}(X)$ denote the type of measures on $X$.
\end{definition}


%%%%%%%%% Chapter %%%%%%%%%
\chapter{Questions}

\begin{enumerate}
	\item Does every internal frame embed into a discrete frame?
	\item What are the semantics of valuations in the topos of sheaves on a topological space? What about in the (presheaf) topos of graphs?
	\item At every point in a topos $\cat{B}$, logic becomes classical. What is a valuation at a point?
\end{enumerate}

\printbibliography

\end{document}
