\documentclass[11pt, oneside, article]{memoir}

\settrims{0pt}{0pt} % page and stock same size
\settypeblocksize{*}{32pc}{*} % {height}{width}{ratio}
\setlrmargins{*}{*}{1} % {spine}{edge}{ratio}
\setulmarginsandblock{1in}{1in}{*} % height of typeblock computed
\setheadfoot{\onelineskip}{2\onelineskip} % {headheight}{footskip}
\setheaderspaces{*}{1.5\onelineskip}{*} % {headdrop}{headsep}{ratio}
\checkandfixthelayout



\usepackage{mathtools}
\usepackage{amsthm}
\usepackage{amssymb}
\usepackage{stmaryrd}
\usepackage{bbm}
\usepackage{accents}
\usepackage{newpxtext}
\usepackage[utf8]{inputenc}
\usepackage[varg,bigdelims]{newpxmath}
\usepackage[usenames,dvipsnames]{xcolor}
\usepackage{tikz}
\usepackage{graphicx}
\usepackage{enumitem}
\usepackage{mathpartir}
\usepackage[bookmarks=true, colorlinks=true, linkcolor=blue!50!red, citecolor=orange,
pdfencoding=unicode]{hyperref}
\usepackage[capitalize]{cleveref}
  \newcommand{\creflastconjunction}{, and\nobreakspace}%Make cleveref use serial comma
\usepackage[backend=biber,style = alphabetic]{biblatex}
  \addbibresource{Library20171206.bib}
\usepackage{ebproof}
\usepackage{todonotes}



\crefname{axiom}{Axiom}{Axioms}
\usetikzlibrary{
	cd,
	math,
	decorations.markings,
	positioning,
	arrows.meta,
	shapes,
	calc,
	fit,
	quotes,
	intersections}
\hypersetup{final}
\setlist{nosep}

\tikzset{
   oriented WD/.style={%everything after equals replaces "oriented WD" in key.
      every to/.style={out=0,in=180,draw},
      label/.style={
         font=\everymath\expandafter{\the\everymath\scriptstyle},
         inner sep=0pt,
         node distance=2pt and -2pt},
      semithick,
      node distance=1 and 1,
      decoration={markings, mark=at position .5 with {\arrow{stealth};}},
      ar/.style={postaction={decorate}},
      execute at begin picture={\tikzset{
         x=\bbx, y=\bby,
         every fit/.style={inner xsep=\bbx, inner ysep=\bby}}}
      },
   bbx/.store in=\bbx,
   bbx = 1.5cm,
   bby/.store in=\bby,
   bby = 1.75ex,
   bb port sep/.store in=\bbportsep,
   bb port sep=2,
   % bb wire sep/.store in=\bbwiresep,
   % bb wire sep=1.75ex,
   bb port length/.store in=\bbportlen,
   bb port length=4pt,
   bb min width/.store in=\bbminwidth,
   bb min width=1cm,
   bb rounded corners/.store in=\bbcorners,
   bb rounded corners=2pt,
   bb small/.style={bb port sep=1, bb port length=2.5pt, bbx=.4cm, bb min width=.4cm, bby=.7ex},
   bb/.code 2 args={%When you see this key, run the code below:
      \pgfmathsetlengthmacro{\bbheight}{\bbportsep * (max(#1,#2)+1) * \bby}
      \pgfkeysalso{draw,minimum height=\bbheight,minimum width=\bbminwidth,outer sep=0pt,
         rounded corners=\bbcorners,thick,
         prefix after command={\pgfextra{\let\fixname\tikzlastnode}},
         append after command={\pgfextra{\draw
            \ifnum #1=0{} \else foreach \i in {1,...,#1} {
               ($(\fixname.north west)!{\i/(#1+1)}!(\fixname.south west)$) +(-\bbportlen,0) 
coordinate (\fixname_in\i) -- +(\bbportlen,0) coordinate (\fixname_in\i')}\fi %Define the endpoints 
%of tickmarks
            \ifnum #2=0{} \else foreach \i in {1,...,#2} {
               ($(\fixname.north east)!{\i/(#2+1)}!(\fixname.south east)$) +(-\bbportlen,0) 
coordinate (\fixname_out\i') -- +(\bbportlen,0) coordinate (\fixname_out\i)}\fi;
         }}}
   },
   bb name/.style={append after command={\pgfextra{\node[anchor=north] at (\fixname.north) {#1};}}}
}


\tikzset{
	unoriented WD/.style={
		every to/.style={draw},
		shorten <=-\portlen, shorten >=-\portlen,
		label distance=-2pt,
		thick,
		node distance=\spacing,
		execute at begin picture={\tikzset{
			x=\spacing, y=\spacing}}
		},
	pack size/.store in=\psize,
	pack size = 8pt,
	spacing/.store in=\spacing,
	spacing = \psize,
	link size/.store in=\lsize,
	link size = 2pt,
	port len/.store in=\portlen,
	port len = \lsize,
	pack color/.store in=\pcolor,
	pack color=blue,
	surround sep/.store in=\ssep,
	surround sep=\psize,
	link/.style={
		circle,
		anchor=center,
		draw=black,
		fill=black,
		inner sep=0pt,
		minimum size=\lsize
	},
	pack/.style={
		circle,
		anchor=center,
		draw = \pcolor!50!black,
		fill = \pcolor!20,
		inner sep = .25*\psize,
		minimum size = \psize
	},
	outer pack/.style={
		ellipse,
		anchor=center,
		draw,
		inner sep=\ssep,
		color=\pcolor!50!black,
	},
	intermediate pack/.style={
		ellipse,
		anchor=center,
		dashed,
		draw,
		inner sep=\ssep,
		color=\pcolor!50!black,
	},
}

\newcommand{\mypic}[4]{
	\node (lend) {};
	\node [right=#1 of lend] (L) {#4};
	\node [right=#2 of L] (R) {#4};
	\node [right=#1 of R] (rend) {};
	\node at ($(L)!.5!(R)+(0,#2/2)$) (M) {};
	\draw[thick, black, #3] (L.center) -- (M.center) -- (R.center);
	\fill[fill=black!15] (L.center) -- (M.center) -- (R.center) -- cycle;
	\draw[thick, <->] (lend) -- (rend);
}


\theoremstyle{plain}
\newtheorem{theorem}{Theorem}[chapter] %change [] to chapter if we want to change global numbering
\newtheorem{proposition}[theorem]{Proposition}
\newtheorem{corollary}[theorem]{Corollary}
\newtheorem{lemma}[theorem]{Lemma}
\newtheorem{conjecture}[theorem]{Conjecture}

\theoremstyle{definition}
\newtheorem{definition}[theorem]{Definition}
\newtheorem{construction}[theorem]{Construction}
\newtheorem{notation}[theorem]{Notation}
\newtheorem{axiom}{Axiom}
\newtheorem*{axiom*}{Axiom}

\theoremstyle{remark}
\newtheorem{example}[theorem]{Example}
\newtheorem{remark}[theorem]{Remark}
\newtheorem{warning}[theorem]{Warning}

\setcounter{axiom}{-1}

% Renewed commands

\renewcommand{\ss}{\subseteq}

% Macros %
\DeclarePairedDelimiter{\church}{\llbracket}{\rrbracket}
\DeclarePairedDelimiter{\Church}{\llbracket}{\rrbracket}
\DeclarePairedDelimiter{\subtype}{[}{]}
\DeclarePairedDelimiter{\classify}{\ulcorner}{\urcorner}

\DeclareMathOperator{\id}{id}
\DeclareMathOperator{\Hom}{Hom}
\DeclareMathOperator{\Mor}{Mor}
\DeclareMathOperator*{\colim}{colim}
\DeclareMathOperator{\im}{im}
\DeclareMathOperator{\Ob}{Ob}


\newcommand{\const}[1]{\mathtt{#1}}
\newcommand{\Set}[1]{\mathrm{#1}}
\newcommand{\cat}[1]{\mathcal{#1}}
\newcommand{\Cat}[1]{\mathbf{#1}}
\newcommand{\fun}[1]{\mathit{#1}}
\newcommand{\Fun}[1]{\mathsf{#1}}
\newcommand{\mach}[1]{\mathcal{#1}}


\newcommand{\cocolon}{:\!}
\newcommand{\iso}{\cong}
\newcommand{\To}[1]{\xrightarrow{#1}}
\newcommand{\Too}[1]{\xrightarrow{\;\;#1\;\;}}
\newcommand{\from}{\leftarrow}
\newcommand{\From}[1]{\xleftarrow{#1}}
\newcommand{\Fromm}[1]{\xleftarrow{\;\;#1\;\;}}
\newcommand{\surj}{\twoheadrightarrow}
\newcommand{\inj}{\rightarrowtail}
\newcommand{\wavyto}{\rightsquigarrow}

\newcommand{\tn}[1]{\textnormal{#1}}
\newcommand{\ol}[1]{\overline{#1}}
\newcommand{\ul}[1]{\underline{#1}}
\newcommand{\wt}[1]{\widetilde{#1}}
\newcommand{\ubar}[1]{\underaccent{\bar}{#1}}


\newcommand{\internal}[1]{\raisebox{-.03ex}{$\mathbbmtt{#1}$}}
\newcommand{\hs}{\hspace{1.1pt}}


\newcommand{\EE}{\mathbb{E}} % expectation value
\newcommand{\II}{\mathbb{I}} % interval domain
\newcommand{\NN}{\mathbb{N}}
\newcommand{\PP}{\mathbb{P}}
\newcommand{\QQ}{\mathbb{Q}}
\newcommand{\RR}{\mathbb{R}}
\newcommand{\VV}{\mathbb{V}}
\newcommand{\ZZ}{\mathbb{Z}}
\newcommand{\LR}{\ul{\mathbb{R}}}

\newcommand{\tNN}{\internal{N}\hs}
\newcommand{\tQQ}{\internal{Q}\hs}
\newcommand{\tQQp}{\tQQ_{+}}
\newcommand{\tZZ}{\internal{Z}\hs}
\newcommand{\tQQub}{\QQ^\infty}
\newcommand{\tRR}{\internal{R}\hs}
\newcommand{\tIR}{\internal{I\hs R}\hs}
\newcommand{\tII}{\bar{\ubar{\tRR}}\hs}
\newcommand{\tLR}{\ubar{\tRR}\hs}
\newcommand{\tUR}{\bar{\tRR}\hs}
\newcommand{\tRRub}{\tRR^\infty}
\newcommand{\tIRub}{\internal{I\hs R}^\infty}
\newcommand{\tLRub}{\ubar{\tRR}^{\infty}}
\newcommand{\tURub}{\bar{\tRR}^{\infty}}
\newcommand{\tIIub}{\bar{\ubar{\tRR}}^{\infty}}

\newcommand{\tRRat}[1]{\tRR_{\SeeInline{#1}}}


\newcommand{\tConst}{\mathtt{C}}
\newcommand{\ShFun}[1]{\mathrm{Fn}(#1)}

\newcommand{\Ind}[1]{\Fun{Ind}\tn{-}#1}
\newcommand{\Psh}[1]{\Fun{Psh}(#1)}
\newcommand{\Shv}[1]{\Fun{Shv}(#1)}
\newcommand{\Cont}{\Fun{Cont}}

\newcommand{\Prop}{\const{Prop}}
\newcommand{\Time}{\const{Time}}
\newcommand{\unit}{\const{1}}
\newcommand{\Poset}{\Cat{Poset}}
\renewcommand{\Top}{\Cat{Top}}
\newcommand{\Op}{\Set{Op}}
\renewcommand{\C}{\Cat{C}}

\newcommand{\op}{^\tn{op}}
\newcommand{\el}[1]{\tn{el}#1}
\newcommand{\asSh}{\Fun{sh}}

\newcommand{\apart}{\,\#\,}
\newcommand{\restrict}[2]{#1\big|\hspace{0in}_{#2}}
\newcommand{\restrictsm}[2]{#1|\hspace{0in}_{#2}}

\newcommand{\Pointwise}{\pi}
\newcommand{\AtSymbol}{{@}}
\newcommand{\SeeSymbol}{{\down}}  % Old: \xi
\newcommand{\InSymbol}{{\upclose}}% Old: \iota
\newcommand{\At}[2][]{\AtSymbol^{#1}_{#2}}
\newcommand{\See}[2][]{\SeeSymbol^{#1}_{#2}}
\newcommand{\In}[2][]{\InSymbol^{#1}_{#2}}
\newcommand{\AtInline}[1]{@{#1}}
\newcommand{\SeeInline}[1]{\SeeSymbol{#1}}
\newcommand{\InInline}[1]{\InSymbol{#1}}


\newcommand{\sqss}{\sqsubseteq}
\newcommand{\specupclose}{{\uparrow}}
\newcommand{\specdownclose}{{\downarrow}}
\newcommand{\upclose}{{\rotatebox[origin=c]{90}{$\twoheadrightarrow$}}}
\newcommand{\downclose}{{\rotatebox[origin=c]{90}{$\twoheadleftarrow$}}}
\newcommand{\down}{\mathord{\downarrow}}
\newcommand{\up}{\mathord{\uparrow}}

\newcommand{\imp}{\Rightarrow}
\renewcommand{\iff}{\Leftrightarrow}

\newcommand{\Span}{\Cat{Span}}
\newcommand{\set}{\text{--}\Cat{Set}}


\newcommand{\erase}[1]{}

\linespread{1.2}
\allowdisplaybreaks
\setsecnumdepth{subsection}
\settocdepth{section}
\setlength{\parindent}{15pt}

%%%%%%%%%%%%% Document %%%%%%%%%%%%%
\begin{document}

\title{Notes on probabilistic powerdomains in a sheaf topos}

\author{Tobias and David}

\maketitle

\tableofcontents*


%%%%%%%%% Chapter %%%%%%%%%

\chapter{Introduction}

\todo[inline]{T: I think that we should work in the topos of sheaves over an \emph{arbitrary} interval domain}

\chapter{Internal posets}

\begin{notation}
We write $\tQQp\coloneqq\{q:\tQQ\mid q\geq0\}$. Given a function $P:X\to\Prop$, we write $\subtype{P}\ss X$ to denote the associated subtype, $\subtype{P}\coloneqq\{x:X\mid Px\}$.
\end{notation}

\begin{definition}
Let $X$ be a type. A \emph{poset structure on $X$} is a function $L:X\times X\to\Prop$ satisfying
\begin{enumerate}
	\item $\forall(x:X)\ldotp L(x,x)$.
	\item $\forall(x,y,z:X)\ldotp L(x,y)\imp L(y,z)\imp L(x,z)$.
\end{enumerate}
We usually denote $L(x,y)$ as $x L y$. We call $(X,L)$ a \emph{poset}.
\end{definition}

In terms of sheaf semantics on some site $(\C,J)$, an internal poset is the same thing as a sheaf with values in $\Poset$; since the theory of posets is essentially algebraic, this is a consequence of Diaconescu's theorem, but it is also instructive to check it by hand.

\begin{example}
For any type $Y$, the type $\Phi\coloneqq (Y\to\Prop)$ has a natural poset structure given by $\lambda(f,g:Y\to\Prop)\ldotp\forall(y:Y)\ldotp (fy\imp gy)$.
\end{example}

\begin{example}
The type $\tLR$ of nonnegative lower real numbers is defined as the type of functions $\delta:\tQQp\to\Prop$ satisfying the following:
\begin{description}
	\item[\quad\parbox{1in}{Down-closed:}] $\forall(q,q':\tQQp)\ldotp (q<q')\imp\delta q'\imp\delta q$.
	\item[\quad\parbox{1in}{Rounded:}] $\forall(q:\tQQp)\ldotp\delta q\imp\exists(q':\tQQ)\ldotp(q<q')\wedge\delta q'$.
\end{description}
The type $\tLR$ has the structure of an ordered semi-ring. That is, it has the structure of
\begin{itemize}
	\item a poset: $\delta\leq \delta'\iff\forall q\ldotp\delta q\imp\delta'q$,
	\item a commutative monoid $(0,+)$:
	\begin{itemize}
		\item identity $0$ given by $\lambda q\ldotp q < 0$,
		\item  addition given by $(\delta_1+\delta_2)q\iff\exists(q_1,q_2)\ldotp(q<q_1+q_2)\wedge\delta_1q_1\wedge\delta_2q_2$,
	\end{itemize}
	\item a commutative monoid $(1,*)$:
	\begin{itemize}
		\item identity $1$ given by $\lambda q\ldotp q<1$,
		\item multiplication given by $(\delta_1*\delta_2)q\iff\exists(q_1,q_2)\ldotp(q<q_1*q_2)\wedge\delta_1q_1\wedge\delta_2q_2$,
	\end{itemize}
\end{itemize}
where multiplication distributes over addition, and both preserve order.
\end{example}

\begin{definition}
Let $(X,\leq)$ be a poset. A subtype $D:X\to\Prop$ is called \emph{directed} if it satisfies the following:
\begin{enumerate}
	\item $\exists(x:X)\ldotp Dx$.
	\item $\forall(x,y:\subtype{D})\ldotp\exists(z:\subtype{D})\ldotp(x\leq z)\wedge (y\leq z)$.
\end{enumerate}
Denote the conjunction of these two conditions as $\const{Drct}:(X\to\Prop)\to\Prop$.
\end{definition}

\begin{definition}
Let $(X,\leq)$ be a poset and let $P:X\to\Prop$ be a subtype. A \emph{join} of $P$ is an element $s_P:X$ satisfying
\begin{enumerate}
	\item $\forall(x:\subtype{P})\ldotp x\leq s_P$.
	\item $\forall(s':X)\ldotp[\forall(x:\subtype{P})\ldotp x\leq s']\imp s_P\leq s'$.
\end{enumerate}
Similarly, a \emph{meet} of $P$ is an element satisfying the dual statements (the arguments to every $\leq$ symbol are swapped).

We say that $X$ has \emph{binary joins} (resp.\ \emph{binary meets}) if, for every $x_1,x_2:X$ the subtype $\lambda(x:X)\ldotp (x=x_1) \vee (x=x_2)$ has a join, in which case we denote it $x_1\vee x_2$ (resp.\ meet $x_1\wedge x_2$). 

We say that $X$ has a \emph{bottom element} if $\lambda(x:X)\ldotp \bot$ has a join, in which case we denote it $\varnothing:X$. We say that $X$ has \emph{finite joins} if $X$ has binary joins and a bottom element (resp.\ binary meets and a top element). We say that $X$ has \emph{directed joins} if, every directed $P$ has a join, denoted $\sup P$.
\end{definition}

\begin{example}
For any type $Y$, the poset $\Phi\coloneqq Y\to\Prop$ has all joins and meets. The join of $P:\Phi\to\Prop$ is $s_P\coloneqq\lambda(y:Y)\ldotp\exists(\phi:\subtype{P})\ldotp\phi y$. It is easy to check that this satisfies the conditions of being a join. The meet of $P$ is $\lambda(y:Y)\ldotp\forall(\phi:\subtype{P})\ldotp\phi y$.
\end{example}

\begin{example}
The poset $(\tLR,\leq)$ has arbitrary joins: the join of $P:\tLR\to\Prop$ is $\lambda q\ldotp\exists(\delta:\subtype{P})\ldotp\delta q$. Note that $0$ is the bottom element. It also has binary meets: $\min(\delta_1,\delta_2)q\iff(\delta_1 q\wedge \delta_2q)$.

In fact, it also has arbitrary meets, though I don't think we'll need that. The meet of $P:\tLR\to\Prop$ is $(\bigwedge P)q\iff\exists q'\ldotp (q<q')\wedge\forall(\delta:\subtype{P})\ldotp\delta q'$.
\end{example}

\begin{definition}
We say that a poset $(X,\leq)$ \emph{has valuations} \todo{Find a better term if we really need this (perhaps we want internal frames instead?)}if it has binary meets, binary joins, and directed joins.
\end{definition}

Note that if $(X,\leq)$, this does not guarantee that $(\VV(X),\leq)$ does.

\chapter{Internal topological spaces and locales}

\todo[inline]{T: possibly except for the interactions with modalities, this stuff is all standard}

Here is a potential definition of topology:
\begin{definition}
Let $X$ be a type. A \emph{topology} on $X$ is a function $\Op:(X\to\Prop)\to\Prop$ satisfying the following conditions:
\begin{enumerate}
	\item $\Op(\lambda(x:X)\ldotp\top)$.
	\item $\forall(\phi_1,\phi_2:X\to\Prop)\ldotp(\Op(\phi_1)\wedge\Op(\phi_2))\imp\Op(\lambda(x:X)\ldotp\phi_1 x\wedge\phi_2 x)$.
	\item Suppose given $I:(X\to\Prop)\to\Prop$ satisfying $\forall(\phi:X\to\Prop)\ldotp I(\phi)\imp\Op(\phi)$. Then $\Op(\lambda(x:X)\ldotp\exists(\phi:X\to\Prop)\ldotp I(\phi)\wedge\phi (x))$.
\end{enumerate}
In other words, the whole space $X$ is open, the intersection of two opens is open, and the union of any $I$-indexed set of opens is open, for any open system $I$. It will be useful to define open systems: $\mathrm{OpSys}\coloneqq\{I:(X\to\Prop)\to\Prop\mid\forall \phi\ldotp I(\phi)\imp\Op(\phi)\}.$

We refer to a pair $(X,\Op)$, where $X$ is a type and $\Op$ is a topology on $X$, as an \emph{internal topological space}.
\end{definition}

\begin{example}[Discrete topology]
For any type $X$, the \emph{discrete topology} on $X$ is given by $\Op(\phi)=\top$.
\end{example}

\begin{example}[Topology on $\tRR_j$]\label{ex.usual_topology_R}
Let $j$ be a modality and define $\Op:(\tRR_j\to\Prop)\to\Prop$ by
\[\Op(\phi)\coloneqq\forall(r:\tRR_j)\ldotp\phi r\imp\exists(\epsilon:\tRR_j)\ldotp\epsilon>0\wedge\forall(r':\tRR_j)\ldotp(-\epsilon<r-r'<\epsilon)\imp\phi(r').\]
It is easy to check condition 1. For condition 2, we obtain $\epsilon_1$ and $\epsilon_2$ from $\phi_1$ and $\phi_2$, respectively; we can satisfy the requisite condition using their infimum, $\min(\epsilon_1,\epsilon_2)>0$.

It remains to check condition 3. Let $I:(\tRR_j\to\Prop)\to\Prop$ satisfy $\forall(\phi:\tRR_j\to\Prop)\ldotp I(\phi)\imp\Op(\phi)$, i.e.\ $I$ is an open system. We need to show $\Op(\lambda(r:\tRR_j)\ldotp\exists(\phi:\tRR_j\to\Prop)\ldotp I(\phi)\wedge\phi (r))$. In other words, we need to show
\begin{multline*}
  \forall(r:\tRR_j)\ldotp[\exists(\phi:\tRR_j\to\Prop)\ldotp I(\phi)\wedge\phi(r)]\imp\exists(\epsilon:\tRR_j)\ldotp\epsilon>0\wedge\\
  \forall(r':\tRR_j)\ldotp(-\epsilon<r-r'<\epsilon)\imp\exists(\phi':\tRR_j\to\Prop)\ldotp I(\phi')\wedge\phi'(r).
\end{multline*}
So take $r:\tRR_j$ and suppose given $\phi$ such that $I(\phi)$ and $\phi(r)$ hold. It follow by hypothesis that $\Op(\phi)$ holds, so by definition we obtain $\epsilon>0$ satisfying the requisite condition with $\phi'\coloneqq\phi$.

All we used about $\tRR_j$ was that it has a definition of comparison ($a<b$), subtraction ($a-b$), that binary min's exist, and that the additive inverse of a binary min is a binary max.
\end{example}

\begin{definition}\label{def.continuous}
Suppose that $(X,\Op_X)$ and $(Y,\Op_Y)$ are internal topological space. A function $f:X\to Y$ is called \emph{continuous} if it satisfies
\[\forall(\phi:Y\to\Prop)\ldotp\Op_Y(\phi)\imp\Op_X(\phi f).\]
We denote by $\Cont(X,Y)$ the type of all $f:X\to Y$ satisfying this condition.
\end{definition}

\begin{proposition}
The internal topological spaces in a topos $\cat{E}$ and continuous maps form an external category with products, and the forgetful functor to $\cat{E}$ preserves products.
\end{proposition}
\begin{proof}
It is easy to check directly from \cref{def.continuous} that if $f:X\to Y$ and $g:Y\to Z$ are continuous then so is $g\circ f$, and the identity is clearly continuous. To check the existence of products, we need to define a product topology $\Op_{X\times Y}$ on $X\times Y$, given topologies $\Op_X$ and $\Op_Y$. Given $\phi:X\times Y\to\Prop$, define $\Op_{X\times Y}(\psi)$ to be
\begin{multline*}
	\exists(I:\mathrm{OpSys}(X))\ldotp\\
	[\forall(\phi:I)\ldotp\exists(\phi_X:\Op(X))(\phi_Y:\Op(Y))\ldotp\phi(x,y)\iff(\phi_X(x)\wedge\phi_Y(y))]\\\wedge[\forall(x:X)(y:Y)\ldotp\psi(x,y)\iff\exists(\phi:I)\ldotp\phi(x,y)]
\end{multline*}
Check that this is a topology and that it has the universal property of a product. (Unfinished)
\end{proof}

\begin{example}
The functions $+:\tRR_j\times\tRR_j\to\tRR_j$ and $*:\tRR_j\times\tRR_j\to\tRR_j$ are continuous; see \cite[Theorems 4.44, 4.48]{Schultz.Spivak:2017a}. For any $j\to j'$ the map $\tRR_j\to\tRR_{j'}$ is also continuous; see \cite[Proposition 4.52]{Schultz.Spivak:2017a}.
\end{example}

%%% The following is the Riesz approach
% \begin{definition}[Measure on an internal topological space]
%Let $(X,\Op_X)$ be an internal topological space, and let $\tRR_{\SeeInline{[d,u]}}$ be the $[d,u]$-reals with the usual topology (see \cref{ex.usual_topology_R}). Then a $[d,u]$-measure on $X$ is a function $\mu:\Cont(X,\tRRat{[d,u]})\to\tRRat{[d,u]}$
%satisfying the following properties:
%\begin{enumerate}
%	\item Linearity: $\mu(r*f+g)=r*\mu(f)+\mu(g)$ for $r:\tRR$ and $f,g:X\to\tRRat{[d,u]}$.
%	\item Positivity: $\mu(f)\geq 0$ whenever $f$ satisfies $\forall x\ldotp f(x)\geq 0$.
%\end{enumerate}
%Let $\const{Meas}_{[d,u]}(X)$ denote the type of measures on $X$ at $[d,u]$. A \emph{measure $\mu$ on $X$} consists of a measure $\mu_{[d,u]}\in\const{Meas}_{[d,u]}(X)$ for each $d,u:\tRR$ such that
%\[\forall(f:X\to\tRRat{[d',u']})\ldotp\See{[d,u]}\mu_{[d',u']}(f)=\mu_{[d,u]}(\See{[d,u]}f)\]
%holds for every $d\leq d'\leq u'\leq u$. Let $\const{Meas}(X)$ denote the type of measures on $X$.
%\end{definition}

\todo{Locally compact spaces as continuous posets}

\todo{Does at modality take locally compact spaces to locally compact spaces?}

\section{Domain-theoretic aspects of internal locales}

For now, this stuff is taking place in $\Cat{Set}$.

Let $X$ be a topological space with poset of opens $\Op(X)$. Then for $U\subseteq V$ in $\Op(X)$, what does it mean for $U$ to be way below $V$? There is a nice way to relate it to the finite subcover definition of compactness:

\begin{lemma}
$U\ll V$ if and only if every open covering of $V$ has a finite subfamily which covers $U$.
\end{lemma}

\begin{proof}
If the condition holds, then every directed set of opens that goes below $V$ also covers $V$, and therefore contains an element that already contains $U$.

Conversely, given a covering family, consider the directed set of finite unions of members of the cover.
\end{proof}

Without additional separation assumptions on $X$, it seems tricky to translate this into a condition involving only the usual concepts of point-set topology. In order to do so, we need one more auxiliary statement.

\newcommand{\cl}[1]{\overline{#1}} % topological closure
\newcommand{\intr}[1]{\mathrm{int}(#1)} % interior

\begin{lemma}
Let $X$ be regular and $D\subseteq X$ dense. Suppose that every open cover of $X$ has a finite subfamily which covers $D$. Then $X$ is compact.
\end{lemma}

This may be somewhat surprising, since in many cases a finite subfamily which covers $D$ does not yet cover $X$.

\begin{proof}(Due to Ramiro de las Vegas, MO.)
Let $\mathcal{A}$ be an open cover of $X$. For every $x\in X$, choose $U_x\ni x$ such that $\cl{U_x}\subseteq V_x$ for suitable $V_x\in\mathcal{A}$. Then $\{U_x\}$ is another open covering which has a finite subcover $\{U_{x_1},\ldots,U_{x_n}\}$ by assumption. Since $X = \cl{U_{x_1}\cup\ldots\cup U_{x_n}} = \cl{U_{x_1}}\cup\ldots\cup\cl{U_{x_n}} \subseteq V_{x_1}\cup\ldots\cup V_{x_n}$, we are done.
\end{proof}

Now we can characterize the way below relation in a nice way:

\begin{lemma}
Let $X$ be regular. Then $U\ll V$ if and only if $U$ is relatively compact in $V$, i.e.~if $\cl{U}\cap V$ is compact.
\end{lemma}

\begin{proof}
If $\cl{U}\cap V$ is compact, then clearly the condition of the first lemma holds as well, and we do not need regularity.

Conversely, suppose that the condition of the first lemma holds. Then by the previous lemma, it is enough to show that every open cover of $\cl{U}\cap V$ has a finite subfamily which covers $U$. But this is clear by assumption: throwing in $V\setminus\cl{U}$ to an open cover of $\cl{U}\cap V$ gives an open cover of $V$.
\end{proof}

\section{Locales and geometric morphisms}

My question is: given a geometric morphism $f : \mathcal{T}\to\mathcal{T}'$, do internal frames in $\mathcal{T}'$ pull back to internal frames in $\mathcal{T}$?

Note that there is a natural comparison map between $f^*\Prop'$ and $\Prop$. Indeed, since $f^*$ preserves monos by virtue of being left exact, there is a map $\classify{f^*\const{true}'}\colon f^*\Prop'\to\Prop$ classifying the image under $f^*$ of $\const{true}'\colon 1'\to \Prop'$.

\begin{lemma}
If $s:A\to B$ is an arbitrary subobject in $\mathcal{T}'$, then $f^*s : f^*A\to f^*B$ is again a subobject, and $\classify{f^*s}$ is given by $f^*\classify{s}$ post-composed with the comparison map $f^*\Prop'\to\Prop$.
\end{lemma}

\begin{proof}
 This is because
\[\begin{tikzcd}
	f^*A \ar{r} \ar{d} & f^*B \ar{d} \\
	f^*1 \ar{r} & f^*\Prop'
\end{tikzcd}\]
is again a pullback diagram, and likewise is
\[\begin{tikzcd}
	f^*1 \ar{r} \ar{d} & f^*\Prop' \ar{d} \\
	1 \ar{r} & \Prop
\end{tikzcd}\]
so that the two pullbacks compose.
\end{proof}

In this reasoning, we have only needed to use that $f^*$ is left exact. Thus everything applies likewise to $f_*$, and we e.g.~have a comparison map $\classify{f_*\const{true}}\colon f_*\Prop\to\Prop'$. But this is of less interest to us here.

So given an internal poset $P$ in $\mathcal{T}'$, we get a poset structure on $f^*P$ given by the subobject $f^*(\leq) \to f^*P\times f^*P$. Again using the fact that $f^*$ preserves finite limits, it's straightforward to see that if $P$ is a meet-semilattice in $\mathcal{T}'$, then $f^*P$ is a meet-semilattice in $\mathcal{T}$. However, it's less clear if the existence of arbitrary joins is preserved in the same way.

The existence of arbitrary joins for $P = \mathcal{O}(X)$ means that the down-closure map
\[
	\mathcal{O}(X)\to\Prop'^{\mathcal{O}(X)},\qquad U\mapsto \classify{ \{ V \leq U \} }
\]
has an internal left adjoint. Here, $\Prop'^{\mathcal{O}(X)}$ carries the usual pointwise ordering, i.e.~the one corresponding to inclusion of subobjects. What we would like to have is that the down-closure map of $f^*\mathcal{O}(X)$ similarly has a left adjoint. According to the Elephant (p.~580), this is not the case in general! However for an \emph{atomic} geometric morphism---or in other words if $f^*$ is a logical functor---we can apply Corollary B2.3.10 to conclude that $f^*\mathcal{O}(X)$ is indeed an internal frame. Concretely, in this case the sup map is the composite $\Prop^{f^*(\mathcal{O}(X))}\cong f^*\left(\Prop'^{\mathcal{O}(X)}\right)\to f^*(\mathcal{O}(X))$, where the first morphism comes from $f^*$ being logical and the second one is $f^*(\sup)$.

In conclusion, internal frames can be pulled back along atomic geometric morphisms\footnote{And also along general geometric morphisms, but this requires a different construction, as in Elephant p.~580.}. Again by Elephant p.~580, pushing frames forward along $f_*$ is even simpler, and it seems plausible that this results in an adjunction $f^* \dashv f_*$ between frames in $\mathcal{T}$ and frames in $\mathcal{T}'$. I will be a bit sloppy for now and just assume that this is true.

The next question is whether $f^*$ preserves properties of locales such as regularity or local compactness. Both are concerned with relaxed notions of ordering:

\begin{definition}
For $U,V\in\mathcal{O}(X)$, one says that
\begin{enumerate}
\item $V$ is \emph{well inside} $U$, written $V\subset\subset U$, if there is $G\in\mathcal{O}(X)$ such that $V\cap G = \emptyset$ and $U\cup G = X$.
\item $V$ is \emph{way below} $U$, written $U\ll V$, if for every directed $D:\mathcal{O}(X)\to\Prop$, $U\leq\sup D$ implies that there is $W\in D$ with $V\leq W$.
\end{enumerate}
Then $X$ is regular (locally compact) if every $U$ is the sup of the $V$ that are well inside (way below) it.
\end{definition}

Since these definitions make sense constructively, we can apply them to internal locales.

So the well-inside relation corresponds to the subobject of $\mathcal{O}(X)\times\mathcal{O}(X)$ that is the projection of the subobject
\[
	\{ \: (V,G,U) \:|\: V\wedge G = \emptyset, \; U\vee G = X \: \} \quad \subseteq \quad \mathcal{O}(X)\times\mathcal{O}(X)\times\mathcal{O}(X)
\]
to the first and third factor, and this subobject itself is an equalizer. Since $f^*$ preserves monos and epis, it also preserves image factorizations and therefore pushforwards of subobjects, such as this pushforward along the product projection. Hence the well-inside relation on $f^*(\mathcal{O}(X))$ coincides with $f^*(\subset\subset)$.

Regularity means that upon exponentiating the first factor in $\classify{\subset\subset} : \mathcal{O}(X)\times\mathcal{O}(X)\to\Prop'$ to $\mathcal{O}(X)\to\Prop'^{\mathcal{O}(X)}$ and composing with $\sup$, one obtains $1_{\mathcal{O}(X)}$. Again since $f^*$ is logical and $f^*(\sup)$ is the sup map of $f^*(\mathcal{O}(X))$, we can conclude that $f^*(\mathcal{O}(X))$ is regular is well.

In order to make the same argument for local compactness, we show similarly that $f^*(\ll)$ is the way-below relation on $f^*(\mathcal{O}(X))$. By similar reasoning as for well-inside, we obtain that $\const{Drct}(f^*(\mathcal{O}(X))) = f^*(\const{Drct}(\mathcal{O}(X)))$.

\chapter{Valuations and measures}



\begin{definition}
Suppose $X$ is a locale. A \emph{valuation} on $X$ is a function $\mu:\mathcal{O}(X)\to\tRRat{[d,u]}$ satisfying the following:
\begin{enumerate}
	\item $\mu(\varnothing)=0$.
	\item $\forall(x,x':X)\ldotp(x\leq x')\imp\mu(x)\leq\mu(x')$.
	\item $\forall(x,x':X)\ldotp\mu(x)+\mu(x')=\mu(x\vee x')+\mu(x\wedge x')$.
	\item $\forall(D:X\to\Prop)\ldotp\const{Drct}(D)\imp \mu(\sup(D))=\sup(\mu(D))$.
\end{enumerate}
Here, $\mu(D)$ is shorthand for the subtype $\mu(D)=\{\mu x\mid Dx\}$.%
\footnote{Completely formally, $\mu(D)\coloneqq\{r:\RR\mid\exists(x:\subtype{D})\ldotp r=\mu(x)\}$.}

Let $\VV(X)$ denote the type of valuations $\mu$, ordered by $(\mu\leq\mu')\iff\forall(x:X)\ldotp(\mu x\leq \mu'x)$.
\end{definition}

\begin{definition}
A valuation is a \emph{probability valuation} if $\mu(X) = 1$.
\end{definition}

\section{A simpler model}

How about considering only two instances of time first, so that we work in the presheaf topos over the discrete two-point space $\{a,b\}$? Here, we will only need three modalities, where $\pi$ corresponds to sheafification, and $\At{a}{}$ and $\At{b}{}$ correspond to behavior at $a$ and $b$, respectively. In this case, measures on types (or suitable locales) which satisfy $\pi$ should semantically correspond to pairs of random variables equipped with a joint distribution. This is a good test case where the essential structures already come up, but without the technical complexity of TTT.

This is the topos $\Span\set$, where $\Span$ is the category \fbox{$a\from ab\to b$}. The subobject classifier for $\Span\set$ has five global sections, which we can represent as follows:
\[\church{\Prop}(ab)=\{\bot,a,b,a\vee b,\top\}.\]
We have $a=(\neg b)=(b\imp a)$ and similarly $b=(\neg a)=(a\imp b)$.

Here is a type theory for $\Span\set$: no atomic types, no atomic terms, two atomic propositions $a,b:\Prop$, and two axioms: $a=\neg b$ and $b=\neg a$. Note that $a=\neg\neg a$ and similarly $b=\neg\neg b$, but not so for $a\vee b$; the logic is not boolean.

The analogous modalities to those used in TTT are:
\[
\begin{array}{c|c|rccc}
	\textbf{modality}&\textbf{definition on } P:\Prop&\textbf{values: }\bot&a&b&a\vee b \\\hline
	\In{a}&a\imp P&b&\top&b&\top\\
	\See{a}&b\vee P&b&a\vee b&b&a\vee b\\
	\At{a}&(P\imp b)\imp b&b&\top&b&\top\\\hline
	\In{b}&b\imp P&a&a&\top&\top\\
	\See{b}&a\vee P&a&a&a\vee b&a\vee b\\
	\At{b}&(P\imp a)\imp a&a&a&\top&\top\\\hline
	\pi&\At{a}P\wedge\At{b}P&\bot&a&b&\top
\end{array}
\]

\todo[inline]{T: do this for an arbitrary interval domain?}

\begin{remark}
Semantically we see that $\church{\In{a}}=\church{\At{a}}$, but in fact, our axioms may not be strong enough to prove that internally. It is easy to show $\forall(P:\Prop)\ldotp(a\imp P)\imp(P\imp b)\imp b$, but I do not see how to show $\forall(P:\Prop)\ldotp[(P\imp b)\imp b]\imp^? (a\imp P)$. Without additional axioms, we have to decide whether to work with $\At{a}$ or $\In{a}$ in our notion of measure; we use $\At{}$ so as to remain faithful to the TTT case. 
\end{remark}

Although defined as the topos on presheaves on the discrete two-point space $\{a,b\}$, our topos $\Span\set$ can also be viewed as the topos of \emph{sheaves} on a topological space $W$, with three points $a,b,ab$ and four open sets: $\emptyset$, $W$, $\{a\}$ and $\{b\}$. The type $\tRR$ corresponds to the constant sheaf, by general theory of real number objects in localic toposes.

\begin{theorem}
Given finite sets $A$ and $B$, valuations on the power object of the $\pi$-type given by the product projections span
\[\begin{tikzcd}
	& A \times B \ar{dl} \ar{dr} \\
	A & & B
\end{tikzcd}\]
are semantically in bijective correspondence with probability measures on $A\times B$.
\end{theorem}

Here, our valuations take values in the lower reals.

We also write $(A,B)\in\Span\set$ as shorthand for the above span. So the global elements of the object of valuations on $(A,B)$ are precisely the probability measures on $A\times B$.

\begin{proof}
The lower reals are given by the span
\[\begin{tikzcd}
	& \{ (x, y, z) \in\mathbb{R}^3 \:\mid\: x,y\geq z \} \ar[swap]{dl}{(x,y,z)\mapsto x} \ar{dr}{(x,y,z)\mapsto y} \\
	\mathbb{R} & & \mathbb{R}
\end{tikzcd}\]
The power object $\Prop^{(A,B)}$ is given by the span
\[\begin{tikzcd}
	& Nat(A,B) \ar{dl} \ar{dr} \\
	\{\bot,\top\}^A & & \{\bot,\top\}^B
\end{tikzcd}\]
where $Nat(A,B)\subseteq \{\bot,a,b,a\lor b,\top\}^{A\times B}$ is the subset consisting of those functions $\phi : A\times B \to \{\bot,a,b,a\lor b,\top\}$ with the property that $\At{a} \phi(x,y)$ is independent of $y$, and likewise $\At{b} \phi(x,y)$ is independent of $x$. Hence the elements of $Nat(A,B)$ can be identified with triples $(S,T,U)$ where $S\subseteq A$ and $T\subseteq B$ as well as $U\subseteq S\times T$; the truth value of $(x,y)$ is $\geq a$ iff $x\in S$; it is $\geq b$ iff $y\in T$; and finally it is $\top$ iff $(x,y)\in U$. In this picture, the maps on the two legs are simply $(S,T,U)\mapsto S$ and $(S,T,U)\mapsto T$. The connectives are given componentwise,
\begin{align*}
	(S_1,T_1,U_1) \land (S_2,T_2,U_2) & = (S_1\cap S_2,T_1\cap T_2,U_1\cap U_2),\\
	(S_1,T_1,U_1) \lor (S_2,T_2,U_2)  & = (S_1\cup S_2,T_1\cup T_2,U_1\cup U_2).
\end{align*}
By all this, a global element of the object of normalized valuations is a diagram
\[\begin{tikzcd}
	& \{(S,T,U) \:\mid\: S \subseteq A , \: T \subseteq B , \: U \subseteq S\times T \} \ar{dl} \ar{dr} \ar{dd}{\mu_{ab}} \\
	\{ S \subseteq A \} \ar{dd}{\mu_a} & & \{ T \subseteq B \} \ar{dd}{\mu_b} \\
	& \{ (x,y,z) \in \mathbb{R}^3 \:\mid\: x,y\geq z \} \ar{dl} \ar{dr} \\
	\mathbb{R} & & \mathbb{R}
\end{tikzcd}\]
satisfying in addition monotonicity and the inclusion-exclusion and normalization equations. The commutativity of the diagram expresses the requirement that the first two components of $\mu_{ab}(S,T,U)$ must be equal to $\mu_a(S)$ and $\mu_b(T)$, respectively; in particular, if we replace $\mu_{ab}$ by its third component, we have the inequalities
\[
	\mu_{ab}(S,T,U) \leq \mu_a(S), \qquad \mu_{ab}(S,T,U) \leq \mu_b(T).
\]
So from now on, we will write $\mu_{ab}$ for only the third component, which is an external real number. By monotonicity of the valuation, it is enough to postulate these inequalities only in the special case $T = B$ and $U = S\times T$,
\begin{equation}
\label{marginaldomination}
	\mu_{ab}(S,B,S\times B) \leq \mu_a(S), \qquad \mu_{ab}(A,T,A\times T) \leq \mu_b(T),
\end{equation}
as long as each of $\mu_a$, $\mu_b$ and $\mu_{ab}$ is monotone (which is the case). Furthermore, we have normalization, which states $\mu_a(A) = \mu_b(B) = \mu_{ab}(A,B,A\times B) = 1$, and the inclusion-exclusion relation, which states the obvious for $\mu_a$ and $\mu_b$, as well as
\begin{equation}
\label{abinclexcl}
	\mu_{ab}(S_1\cap S_2,T_1\cap T_2,U_1\cap U_2) + \mu_{ab}(S_1\cup S_2,T_1\cup T_2,U_1\cup U_2) = \mu_{ab}(S_1,T_1,U_1) + \mu_{ab}(S_2,T_2,U_2).
\end{equation}
Moreover, we claim that together with normalization, this forces the inequalities~\eqref{marginaldomination} to be equalities. Indeed, we have as an instance of inclusion-exclusion,
\[
	\mu_{ab}(A\setminus S,B,(A\setminus S)\times B) + \mu_{ab}(S,B,S\times B) = \mu_{ab}(\emptyset,B,\emptyset) + \mu_{ab}(A,B,A\times B).
\]
The first term on the right-hand side vanishes since $0 \leq \mu_{ab}(\emptyset,B,\emptyset) \leq \mu_a(\emptyset) = 0$, while the second term is $1$ by normalization. With $A\setminus S$ in place of $S$, the first inequality~\eqref{marginaldomination} therefore gives
\[
	1 - \mu_{ab}(S,B,S\times B) \leq \mu_a(A\setminus S) = 1 - \mu_a(S).
\]
\todo[inline]{These seem to be correspond to the point-determination axiom, which therefore follows from normalization. Is this correct?}
Combining this with~\eqref{marginaldomination}, we conclude that the first inequality in~\eqref{marginaldomination} must hold with equality; the same reasoning applies to the second inequality. Therefore $\mu_a$ is already determined by $\mu_{ab}$, and so is $\mu_b$.

So overall, a normalized valuation on $(A,B)$ is the same thing as a map $(S,T,U)\longmapsto \mu_{ab}(S,T,U)$ with values in classical $[0,1]$ that satisfies monotonicity, inclusion-exclusion in the form~\eqref{abinclexcl}, and normalization $\mu_{ab}(A,B,A\times B) = 1$.

What is missing is to show that $\mu_{ab}(S,T,U) = \mu_{ab}(A,B,U)$ for all $S,T,U$, so that $\mu_{ab}$ depends only on $U\subseteq A\times B$, making it into a probability measure in the standard sense. Again by inclusion-exclusion and monotonicity, this equation is equivalent to $\mu_{ab}(A,B,\emptyset) = 0$. But this equation is also automatic thanks to inclusion-exclusion,
\[
	\mu_{ab}(A\cap \emptyset, \emptyset \cap B, \emptyset) + \mu_{ab}(A\cup \emptyset, \emptyset \cup B, \emptyset) = \mu_{ab}(A, \emptyset, \emptyset) + \mu_{ab}(\emptyset, B, \emptyset).
\]
We have already shown that both terms on the right-hand side must vanish, and the first term on the left vanishes trivially. Therefore $\mu_{ab}(A,B,\emptyset) = 0$, as was to be shown.
\end{proof}

What David sees as the most interesting part of the above proof is the last step, that $\mu_{ab}(S,T,U) = \mu_{ab}(A,B,U)$ for all $S,T,U$. Here's how that looks logically.

Recall that $\See{[0,n]}P\coloneqq(t\apart [n,0])\vee P$, where $t\apart[a,b]$ means $(b+1\leq t)\vee(t\leq a-1)$. So $\See{[0,n]}P=(1\leq t)\vee(t\leq n-1)\vee P$. Recall also that $\mu(P)$ is formally a function on rationals, $\mu(P):\tQQ\to\Prop$; if $\mu(P)(q)$ holds, we think ``$q<\mu(P)$''. So for example, down-closure says $(q'<q\wedge\mu(P)(q))\imp\mu(P)(q')$. In $\tRR_{\SeeInline{[0,n]}}$, the $\See{[d,u]}$-(nonnegative lower reals), $\See{[d,u]}\bot$ is the unit for addition.

\begin{theorem}
\[\See{[0,n]}\mu(P)=\See{[0,n]}\mu(\See{[0,n]}P).\]
\end{theorem}
\begin{proof}
We have $\mu(P)+\mu(\See{[0,n]}\bot)=\mu((\See{[0,n]}\bot)\wedge P)+\mu(\See{[0,n]} P)$. Since $\See{[0,n]}$ commutes with addition, it suffices to show $\See{[0,n]}\mu(\See{[0,n]}\bot)=\See{[0,n]}\mu((\See{[0,n]}\bot)\wedge P)$. But $\See{[0,n]}\bot\leq\See{[0,n]}\mu(\See{[0,n]}\bot\wedge P)\leq\See{[0,n]}\mu(\See{[0,n]}\bot)$, so it suffices to show that $\See{[0,n]}\mu(\See{[0,n]}\bot)\leq\See{[0,n]}\bot$. We also have
\[\mu(\See{[0,n]}\bot)+\mu(1\leq t\leq n-1)=\mu(1\leq t)+\mu(t\leq n-1),\]
so it suffices to show that $\See{[0,n]}\mu(1\leq t)\leq\See{[0,n]}\bot$ and $\See{[0,n]}\mu(t\leq n-1)\leq\See{[0,n]}\bot$. 

These are similar, so we show the first, and since $\See{[0,n]}$ is a modality, it suffices to show that $\mu(1\leq t)(q)\imp\See{[0,n]}\bot$ for any $q\in\QQ_{\geq0}$. So suppose $\mu(1\leq t)(q)$.

By an axiom of discrete temporal type theory (analogous to Axiom 3a in TTT), we have $\neg(t\leq 0)\imp (1\leq t)$ [and similarly $\neg(n\leq t)\imp(t\leq n-1)$]. Since $(1\leq t)\imp\See{[0,n]}\bot$, it suffices to show $\neg(t\leq 0)$, so assume $t\leq 0$. Then $\mu(1\leq t)=\mu(\bot)$, so $\mu(1\leq t)(q)=\mu(\bot)(q)=\bot$. This completes the proof.\end{proof}

\todo[inline]{Do we generally expect it to be the case that $\mu(P) = P$, or at least $\mu(P) \leq P$, for every proposition $P$? Because then we would get
\[
	\mu(1 \leq t) \leq \mu(\See{[0,n]} \bot) \leq \See{[0,n]} \bot,
\]
and therefore directly $\See{[0,n]} \mu(1 \leq t) \leq \See{[0,n]} \bot$, since applying $\See{[0,n]}$ to a lower real is the internal left adjoint to $\RR \rightarrow \RR_{\SeeInline{[0,n]}}$. (Right?) Or is this argument begging the question?}


\section{What we can aim for}

Tentative setup, to be adjusted: let $B$ be a topological space (say, T1), $G$ a group that acts on $B$, and $K$ a $G$-invariant collection of compact sets in $B$ that includes all singletons and is closed in the upper Vietoris topology (that we equip $K$ with), and such that every compact set in $B$ is contained in some element of $K$. Whatever setup we use, it should cover the following two cases that are of main interest:

\begin{enumerate}
\item $B = \RR$ with $K = \mathbb{IR}$, where $G$ is either trivial or the translation group; this should give a topos-theoretic formulation of (stationary) stochastic processes.
\item $B$ a discrete finite space with $K = 2^B$, where $G$ is either trivial or the permutation group; this should give a topos-theoretic formulation of joint distributions of $|B|$ many random variables.
\end{enumerate}

If things go really well, we can also hope to cover one more case that is fundamental to statistical mechanics and quantum field theory:

\begin{enumerate}[resume]
\item $B = \RR^n$ with $K$ e.g.~all compact subsets, where $G$ is again the translation group.
\end{enumerate}

For now, let me formulate the conjecture in the case where $G$ is trivial:

\begin{conjecture}
Every space $p : X\to B$ over $B$ is an internal space in $\Shv{B}$, but also becomes an internal space in $\Shv{K}$. Global elements of the object of normalized continuous valuations on this space with values in the lower reals of $\Shv{K}$ are in bijection with external normalized continuous valuations on the space of global sections of $p$, equipped with (e.g.) the compact-open topology.
\end{conjecture}

Essentially, the problem is to find suitable hypotheses that make some version of this conjecture correct. Developing a result of this type is mostly a topos-theoretic problem and does not involve technical aspects of measure theory. However, in order to get to the traditional picture of stochastic processes, there is one more step to take:

\begin{conjecture}
Under suitable hypotheses, (external) continuous valuations on the space of global sections of $p : X\to \RR$ are in bijection with stochastic processes taking values in $X$.
\end{conjecture}



\newpage

\appendix

\chapter{Another (less satisfactory) attempt}

Tobias: I'm not sure if this is going in the right direction. My idea was that we'd have a sheaf $\tRR_{\EE}$ in which expectation values land, such that a section over $(a,b)$ is either an arbitrary function $\II(a,b)\to\II\RR$, or more specifically such a function which in addition takes maximal elements to maximal elements.

The things that we want to take expectation values of should be \emph{observables} on $X$. In the sheaf of observables, a section over $(a,b)$ should be a function $f:\prod_{(c,d)\subseteq(a,b)} X(c,d)\to\II\RR$ which is suitably monotone, i.e.~such that $(c,d)\sqsupseteq(c',d')$ implies $f(c,d)\sqsupseteq f(c',d')$.

Then taking expectation values should be an internal function $X\to $

\chapter{Riesz approach}

\todo[inline]{T: I now think that the valuations approach is superior, so this got relegated to the appendix}

One idea is to follow the spirit of the Riesz representation theorem (reference?). We could try to define a measure on a type $X$ to be a positive linear functional on the type $(X\to\tRR)$. However, there is a semantic problem with this idea, namely the Dedekind reals $\tRR$ are constant, so the value of a sheaf homomorphism $X\to\tRR$ on a section $x$ must remain constant as we restrict $x$. This is too strong.

One possibility is to replace $\tRR$ with $\tRRat{[d,u]}$ in the above formulation, where $d\leq u$ are elements of $\tRR$.%
\footnote{
It is shown in \cite[Prop 7.9]{Schultz.Spivak:2017a} that there is an isomorphism $\tRRat{[d,u]}\cong\tRR_{\AtInline{[d,u]}}$.
}
The semantics of the sheaf $\tRRat{[d,u]}$ are as follows. For any interval $(a,b)\ss\RR$, if $a<d\leq u<b$ then $\RR\cong\church{\tRRat{[d,u]}}(a,b)$, i.e.\ sections on intervals containing $[d,u]$ are constant reals. If $d\leq a$ or $b\leq u$, then $1\cong\church{\tRRat{[d,u]}}(a,b)$, i.e.\ on intervals missing either endpoint of $[d,u]$ there is exactly one section.

The semantics of an internal function $f:X\to\tRRat{[d,u]}$ is that of a function $\church{X}_{[d,u]}\to\RR$ from the stalk of $X$ at $[d,u]$ to $\RR$. This seems to be what Tobias wanted.

For any $d\leq d'\leq u'\leq u$ and any $P:\Prop$, we have $\See{[d',u']}P\imp\See{[d,u]}P$. This induces a morphism
\begin{equation}
\label{Rlocalize}
	\See{[d,u]}:\tRRat{[d',u']}\to\tRRat{[d,u]}.
\end{equation}

\begin{definition}
Let $X$ be a type. For $d,u\in\tRR$, a \emph{measure on $X$ at $[d,u]$} is defined to be a function $\mu:(X\to\tRRat{[d,u]})\to\tRRat{[d,u]}$%
\footnote{
I guess we want to consider continuous maps from a locale $X$ to the locale of opens in $\tRRat{[d,u]}$?
}
satisfying the following properties:
\begin{enumerate}
	\item Linearity: $\mu(r*f+g)=r*\mu(f)+\mu(g)$ for $r:\tRR$ and $f,g:X\to\tRRat{[d,u]}$.
	\item Positivity: $\mu(f)\geq 0$ whenever $f$ satisfies $\forall x\ldotp f(x)\geq 0$.%
	\footnote{The notation $a\leq b$ here is shorthand for $(b<a)\imp\At{[d,u]}\bot$. The correct notation is $a\leq_{\AtInline{[d,u]}}b$, but this is a bit heavy.
	}
\end{enumerate}
Let $\const{Meas}_{[d,u]}(X)$ denote the type of measures on $X$ at $[d,u]$. A \emph{measure $\mu$ on $X$} consists of a measure $\mu_{[d,u]}\in\const{Meas}_{[d,u]}(X)$ for each $d,u:\tRR$\todo{This quantifies over $u$ and $d$. So the modal operators $\See{[d,u]}$ are a family of functions $\Prop\to\Prop$ indexed internally by pairs $d\leq u$ from the (extended) Dedekind reals? Seems to be in line with TTT Sec 5.3},%
\footnote{Thus $\mu$ is a dependent product type.}
such that
\[\forall(f:X\to\tRRat{[d',u']})\ldotp\See{[d,u]}\mu_{[d',u']}(f)=\mu_{[d,u]}(\See{[d,u]}f)\]
holds for every $d\leq d'\leq u'\leq u$. Let $\const{Meas}(X)$ denote the type of measures on $X$.
\end{definition}

Here, $\See{[d,u]}f$ denotes the function obtained by composition of $f$ with~\eqref{Rlocalize}.

$X\to\tRRat{[d,u]}$ can be interpreted as the type of \emph{observables} supported on the interval $[d,u]$. Concretely, a section of $\Church{X\to\tRRat{[d,u]}}$ over an interval $(a,b)$ which contains $[d,u]$ assigns to every section between $(a,b)$ and $[d,u]$ a real number, in such a way that it is compatible with restriction, which means that the number assigned to a section must be a function of its germ at $[d,u]$. Over an interval $(a,b)$ not containing $[d,u]$, this function type has exactly one section, and the compatibility conditions are trivial. In total, $\Church{X\to\tRRat{[d,u]}}$ is the constant sheaf given by the set of functions\footnote{where $\Church{X}[d,u]$ denotes the stalk.} $\Church{X}[d,u]\to\RR$ on $\downarrow [d,u]$, but looks like the terminal sheaf outside of that. For $f:X\to\tRRat{[d',u']}$, the new function $\See{[d,u]}f$ corresponds to the trivial extension of $f$ to $[d,u]$.

Classically and in the case when $X$ is a sheaf on $\RR$, I'd expect these observables to be (up to continuity conditions) precisely all the random variables that are measurable with respect to the $\sigma$-algebra generated by the $X_t$ for $t\in [d,u]$.

Thus a measure at $[d,u]$ assigns to every observable on $[d,u]$ a real number, which is exactly what we'd expect.

\printbibliography

\end{document}
