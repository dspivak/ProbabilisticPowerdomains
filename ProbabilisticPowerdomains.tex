\documentclass[11pt, oneside, article]{memoir}

\settrims{0pt}{0pt} % page and stock same size
\settypeblocksize{*}{32pc}{*} % {height}{width}{ratio}
\setlrmargins{*}{*}{1} % {spine}{edge}{ratio}
\setulmarginsandblock{1in}{1in}{*} % height of typeblock computed
\setheadfoot{\onelineskip}{2\onelineskip} % {headheight}{footskip}
\setheaderspaces{*}{1.5\onelineskip}{*} % {headdrop}{headsep}{ratio}
\checkandfixthelayout



\usepackage{mathtools}
\usepackage{amsthm}
\usepackage{amssymb}
\usepackage{stmaryrd}
\usepackage{bbm}
\usepackage{accents}
\usepackage{newpxtext}
\usepackage[utf8]{inputenc}
\usepackage[varg,bigdelims]{newpxmath}
\usepackage[usenames,dvipsnames]{xcolor}
\usepackage{tikz}
\usepackage{graphicx}
\usepackage{enumitem}
\usepackage{mathpartir}
\usepackage[bookmarks=true, colorlinks=true, linkcolor=blue!50!red, citecolor=orange,
pdfencoding=unicode]{hyperref}
\usepackage[capitalize]{cleveref}
  \newcommand{\creflastconjunction}{, and\nobreakspace}%Make cleveref use serial comma
\usepackage[backend=biber,style = alphabetic]{biblatex}
  \addbibresource{Library20171206.bib}
\usepackage{todonotes}



\usetikzlibrary{
	cd,
	math,
	decorations.markings,
	positioning,
	arrows.meta,
	shapes,
	calc,
	fit,
	quotes,
	intersections}
\hypersetup{final}
\setlist{nosep}

\tikzset{
  tick/.style={postaction={
    decorate,
    decoration={markings, mark=at position 0.5 with {\draw[-] (0,.4ex) -- (0,-.4ex);}}}
  },
  tickx/.style={
    postaction={ decorate,
      decoration={markings,
        mark=at position 0.5 with {
          \fill circle [radius=.28ex];
        }
      }
    }
  }
}



\theoremstyle{plain}
\newtheorem{theorem}{Theorem}[chapter] %change [] to chapter if we want to change global numbering
\newtheorem{proposition}[theorem]{Proposition}
\newtheorem{corollary}[theorem]{Corollary}
\newtheorem{lemma}[theorem]{Lemma}
\newtheorem{conjecture}[theorem]{Conjecture}

\theoremstyle{definition}
\newtheorem{definition}[theorem]{Definition}
\newtheorem{construction}[theorem]{Construction}
\newtheorem{notation}[theorem]{Notation}
\newtheorem{axiom}{Axiom}
\newtheorem*{axiom*}{Axiom}

\theoremstyle{remark}
\newtheorem{example}[theorem]{Example}
\newtheorem{remark}[theorem]{Remark}
\newtheorem{warning}[theorem]{Warning}
\newtheorem{question}[theorem]{Question}

\setcounter{axiom}{-1}

% Renewed commands

\renewcommand{\ss}{\subseteq}

% Macros %
\DeclarePairedDelimiter{\church}{\llbracket}{\rrbracket}
\DeclarePairedDelimiter{\Church}{\llbracket}{\rrbracket}
\DeclarePairedDelimiter{\subtype}{[}{]}
\DeclarePairedDelimiter{\classify}{\ulcorner}{\urcorner}

\DeclareMathOperator{\id}{id}
\DeclareMathOperator{\Hom}{Hom}
\DeclareMathOperator{\Mor}{Mor}
\DeclareMathOperator*{\colim}{colim}
\DeclareMathOperator{\im}{im}
\DeclareMathOperator{\Ob}{Ob}


\newcommand{\const}[1]{\mathtt{#1}}
\newcommand{\Set}[1]{\mathrm{#1}}
\newcommand{\cat}[1]{\mathcal{#1}}
\newcommand{\Cat}[1]{\mathbf{#1}}
\newcommand{\fun}[1]{\mathit{#1}}
\newcommand{\Fun}[1]{\mathsf{#1}}

\newcommand{\smset}{\Cat{Set}}


\newcommand{\tickar}{\begin{tikzcd}[baseline=-0.5ex,cramped,sep=small,ampersand replacement=\&]{}\ar[r,tick]\&{}\end{tikzcd}}
\newcommand{\xtickar}[1]{\stackrel{#1}{\tickar}}
\newcommand{\cocolon}{:\!}
\newcommand{\iso}{\cong}
\newcommand{\To}[1]{\xrightarrow{#1}}
\newcommand{\Too}[1]{\xrightarrow{\;\;#1\;\;}}
\newcommand{\from}{\leftarrow}
\newcommand{\From}[1]{\xleftarrow{#1}}
\newcommand{\Fromm}[1]{\xleftarrow{\;\;#1\;\;}}
\newcommand{\surj}{\twoheadrightarrow}
\newcommand{\inj}{\rightarrowtail}
\newcommand{\wavyto}{\rightsquigarrow}

\newcommand{\tn}[1]{\textnormal{#1}}
\newcommand{\ol}[1]{\overline{#1}}
\newcommand{\ul}[1]{\underline{#1}}
\newcommand{\wt}[1]{\widetilde{#1}}
\newcommand{\ubar}[1]{\underaccent{\bar}{#1}}


\newcommand{\internal}[1]{\raisebox{-.03ex}{$\mathbbmtt{#1}$}}
\newcommand{\hs}{\hspace{1.1pt}}


\newcommand{\EE}{\mathbb{E}} % expectation value
\newcommand{\II}{\mathbb{II}} % interval domain
\newcommand{\IR}{\mathbb{IR}} % interval domain
\newcommand{\NN}{\mathbb{N}}
\newcommand{\PP}{\mathbb{P}}
\newcommand{\QQ}{\mathbb{Q}}
\newcommand{\RR}{\mathbb{R}}
\newcommand{\VV}{\mathbb{V}}
\newcommand{\ZZ}{\mathbb{Z}}
\newcommand{\LR}{\ul{\mathbb{R}}}

\newcommand{\tNN}{\internal{N}\hs}
\newcommand{\tQQ}{\internal{Q}\hs}
\newcommand{\tQQp}{\tQQ_{+}}
\newcommand{\tZZ}{\internal{Z}\hs}
\newcommand{\tQQub}{\QQ^\infty}
\newcommand{\tRR}{\internal{R}\hs}
\newcommand{\tIR}{\internal{I\hs R}\hs}
\newcommand{\tII}{\bar{\ubar{\tRR}}\hs}
\newcommand{\tLR}{\ubar{\tRR}\hs}
\newcommand{\tUR}{\bar{\tRR}\hs}
\newcommand{\tRRub}{\tRR^\infty}
\newcommand{\tIRub}{\internal{I\hs R}^\infty}
\newcommand{\tLRub}{\ubar{\tRR}^{\infty}}
\newcommand{\tURub}{\bar{\tRR}^{\infty}}
\newcommand{\tIIub}{\bar{\ubar{\tRR}}^{\infty}}

\newcommand{\tRRat}[1]{\tRR_{\SeeInline{#1}}}


\newcommand{\tConst}{\mathtt{C}}
\newcommand{\ShFun}[1]{\mathrm{Fn}(#1)}

\newcommand{\Ind}[1]{\Fun{Ind}\tn{-}#1}
\newcommand{\Psh}{\Fun{Psh}}
\newcommand{\Shv}{\Fun{Shv}}
\newcommand{\Cont}{\Fun{Cont}}
\newcommand{\Idl}{\Set{Idl}}

\newcommand{\Prop}{\const{Prop}}
\newcommand{\Time}{\const{Time}}
\newcommand{\unit}{\const{1}}
\newcommand{\Poset}{\Cat{Poset}}
\renewcommand{\Top}{\Cat{Top}}
\newcommand{\Op}{\Set{Op}}
\renewcommand{\C}{\Cat{C}}
\newcommand{\Sub}{\Set{Sub}}
\newcommand{\pt}{\Fun{pt}}

\newcommand{\op}{^\tn{op}}
\newcommand{\el}[1]{\tn{el}#1}
\newcommand{\asSh}{\Fun{sh}}

\newcommand{\apart}{\,\#\,}
\newcommand{\restrict}[2]{#1\big|\hspace{0in}_{#2}}
\newcommand{\restrictsm}[2]{#1|\hspace{0in}_{#2}}
\newcommand{\BaseTopos}{\mathcal{B}}
\newcommand{\BaseSpace}{B}

\newcommand{\Pointwise}{\pi}
\newcommand{\AtSymbol}{{@}}
\newcommand{\SeeSymbol}{{\down}}  % Old: \xi
\newcommand{\InSymbol}{{\upclose}}% Old: \iota
\newcommand{\At}[2][]{\AtSymbol^{#1}_{#2}}
\newcommand{\See}[2][]{\SeeSymbol^{#1}_{#2}}
\newcommand{\In}[2][]{\InSymbol^{#1}_{#2}}
\newcommand{\AtInline}[1]{@{#1}}
\newcommand{\SeeInline}[1]{\SeeSymbol{#1}}
\newcommand{\InInline}[1]{\InSymbol{#1}}


\newcommand{\sqss}{\sqsubseteq}
\newcommand{\specupclose}{{\uparrow}}
\newcommand{\specdownclose}{{\downarrow}}
\newcommand{\upclose}{{\rotatebox[origin=c]{90}{$\twoheadrightarrow$}}}
\newcommand{\downclose}{{\rotatebox[origin=c]{90}{$\twoheadleftarrow$}}}
\newcommand{\down}{\mathord{\downarrow}}
\newcommand{\up}{\mathord{\uparrow}}

\newcommand{\imp}{\Rightarrow}
\renewcommand{\iff}{\Leftrightarrow}
\newcommand{\true}{\const{true}}
\newcommand{\Bool}{\Set{Bool}}

\newcommand{\Span}{\Cat{Span}}
\newcommand{\set}{\text{--}\smset}


\newcommand{\erase}[1]{}

\linespread{1.2}
\setsecnumdepth{subsection}
\settocdepth{section}
\setlength{\parindent}{15pt}

%%%%%%%%%%%%% Document %%%%%%%%%%%%%
\begin{document}

\title{Stochastic Processes as Internal Probability Spaces}

\author{Tobias Fritz and David Spivak}

\maketitle

\todo[inline]{Tenative title. Internal ``probability spaces'' may be technically misleading, but has the advantage of being more recognizable}

\tableofcontents*


%%%%%%%%% Chapter %%%%%%%%%

\chapter{Introduction}

\chapter{Preliminaries}

\section{Internal posets}

\begin{notation}
We write $\tQQp\coloneqq\{q:\tQQ\mid q\geq0\}$. Given a function $P:X\to\Prop$, we write $\subtype{P}\ss X$ to denote the associated subtype, $\subtype{P}\coloneqq\{x:X\mid Px\}$.
\end{notation}

\begin{definition}
Let $X$ be a type. A \emph{poset structure on $X$} is a function $L:X\times X\to\Prop$ satisfying
\begin{enumerate}
	\item $\forall(x:X)\ldotp L(x,x)$.
	\item $\forall(x,y,z:X)\ldotp L(x,y)\imp L(y,z)\imp L(x,z)$.
\end{enumerate}
We usually denote $L(x,y)$ as $x L y$. We call $(X,L)$ a \emph{poset}.
\end{definition}

In terms of sheaf semantics on some site $(\C,J)$, an internal poset is the same thing as a sheaf with values in $\Poset$; since the theory of posets is essentially algebraic, this is a consequence of Diaconescu's theorem, but it is also instructive to check it by hand.

\begin{example}
For any type $Y$, the type $\Phi\coloneqq (Y\to\Prop)$ has a natural poset structure given by $\lambda(f,g:Y\to\Prop)\ldotp\forall(y:Y)\ldotp (fy\imp gy)$.
\end{example}

\begin{example}
The type $\tLR$ of nonnegative lower real numbers is defined as the type of functions $\delta:\tQQp\to\Prop$ satisfying the following:
\begin{description}
	\item[\quad\parbox{1in}{Down-closed:}] $\forall(q,q':\tQQp)\ldotp (q<q')\imp\delta q'\imp\delta q$.
	\item[\quad\parbox{1in}{Rounded:}] $\forall(q:\tQQp)\ldotp\delta q\imp\exists(q':\tQQ)\ldotp(q<q')\wedge\delta q'$.
\end{description}
The type $\tLR$ has the structure of an ordered semi-ring. That is, it has the structure of
\begin{itemize}
	\item a poset: $\delta\leq \delta'\iff\forall q\ldotp\delta q\imp\delta'q$,
	\item a commutative monoid $(0,+)$:
	\begin{itemize}
		\item identity $0$ given by $\lambda q\ldotp q < 0$,
		\item  addition given by $(\delta_1+\delta_2)q\iff\exists(q_1,q_2)\ldotp(q<q_1+q_2)\wedge\delta_1q_1\wedge\delta_2q_2$,
	\end{itemize}
	\item a commutative monoid $(1,*)$:
	\begin{itemize}
		\item identity $1$ given by $\lambda q\ldotp q<1$,
		\item multiplication given by $(\delta_1*\delta_2)q\iff\exists(q_1,q_2)\ldotp(q<q_1*q_2)\wedge\delta_1q_1\wedge\delta_2q_2$,
	\end{itemize}
\end{itemize}
where multiplication distributes over addition, and both preserve order.
\end{example}

\begin{definition}
Let $(X,\leq)$ be a poset. A subtype $D:X\to\Prop$ is called \emph{directed} if it satisfies the following:
\begin{enumerate}
	\item $\exists(x:X)\ldotp Dx$.
	\item $\forall(x,y:\subtype{D})\ldotp\exists(z:\subtype{D})\ldotp(x\leq z)\wedge (y\leq z)$.
\end{enumerate}
Denote the conjunction of these two conditions as $\const{Drct}:(X\to\Prop)\to\Prop$.
\end{definition}

\begin{definition}
Let $(X,\leq)$ be a poset and let $P:X\to\Prop$ be a subtype. A \emph{join} of $P$ is an element $s_P:X$ satisfying
\begin{enumerate}
	\item $\forall(x:\subtype{P})\ldotp x\leq s_P$.
	\item $\forall(s':X)\ldotp[\forall(x:\subtype{P})\ldotp x\leq s']\imp s_P\leq s'$.
\end{enumerate}
Similarly, a \emph{meet} of $P$ is an element satisfying the dual statements (the arguments to every $\leq$ symbol are swapped).

We say that $X$ has \emph{binary joins} (resp.\ \emph{binary meets}) if, for every $x_1,x_2:X$ the subtype $\lambda(x:X)\ldotp (x=x_1) \vee (x=x_2)$ has a join, in which case we denote it $x_1\vee x_2$ (resp.\ meet $x_1\wedge x_2$). 

We say that $X$ has a \emph{bottom element} if $\lambda(x:X)\ldotp \bot$ has a join, in which case we denote it $\varnothing:X$. We say that $X$ has \emph{finite joins} if $X$ has binary joins and a bottom element (resp.\ binary meets and a top element). We say that $X$ has \emph{directed joins} if, every directed $P$ has a join, denoted $\sup P$.
\end{definition}

\begin{example}
For any type $Y$, the poset $\Phi\coloneqq Y\to\Prop$ has all joins and meets. The join of $P:\Phi\to\Prop$ is $s_P\coloneqq\lambda(y:Y)\ldotp\exists(\phi:\subtype{P})\ldotp\phi y$. It is easy to check that this satisfies the conditions of being a join. The meet of $P$ is $\lambda(y:Y)\ldotp\forall(\phi:\subtype{P})\ldotp\phi y$.
\end{example}

\begin{example}
The poset $(\tLR,\leq)$ has arbitrary joins: the join of $P:\tLR\to\Prop$ is $\lambda q\ldotp\exists(\delta:\subtype{P})\ldotp\delta q$. Note that $0$ is the bottom element. It also has binary meets: $\min(\delta_1,\delta_2)q\iff(\delta_1 q\wedge \delta_2q)$.

In fact, it also has arbitrary meets, though I don't think we'll need that. The meet of $P:\tLR\to\Prop$ is $(\bigwedge P)q\iff\exists q'\ldotp (q<q')\wedge\forall(\delta:\subtype{P})\ldotp\delta q'$.
\end{example}

\section{Internal topological spaces and locales}

\todo[inline]{T: possibly except for the interactions with modalities, this stuff is all standard}

Here is a potential definition of topology:
\begin{definition}
Let $X$ be a type. A \emph{topology} on $X$ is a function $\Op:(X\to\Prop)\to\Prop$ satisfying the following conditions:
\begin{enumerate}
	\item $\Op(\lambda(x:X)\ldotp\top)$.
	\item $\forall(\phi_1,\phi_2:X\to\Prop)\ldotp(\Op(\phi_1)\wedge\Op(\phi_2))\imp\Op(\lambda(x:X)\ldotp\phi_1 x\wedge\phi_2 x)$.
	\item Suppose given $I:(X\to\Prop)\to\Prop$ satisfying $\forall(\phi:X\to\Prop)\ldotp I(\phi)\imp\Op(\phi)$. Then $\Op(\lambda(x:X)\ldotp\exists(\phi:X\to\Prop)\ldotp I(\phi)\wedge\phi (x))$.
\end{enumerate}
In other words, the whole space $X$ is open, the intersection of two opens is open, and the union of any $I$-indexed set of opens is open, for any open system $I$. It will be useful to define open systems: $\mathrm{OpSys}\coloneqq\{I:(X\to\Prop)\to\Prop\mid\forall \phi\ldotp I(\phi)\imp\Op(\phi)\}.$

We refer to a pair $(X,\Op)$, where $X$ is a type and $\Op$ is a topology on $X$, as an \emph{internal topological space}.
\end{definition}

\begin{example}[Discrete topology]
For any type $X$, the \emph{discrete topology} on $X$ is given by $\Op(\phi)=\top$.
\end{example}

\begin{example}[Topology on $\tRR_j$]\label{ex.usual_topology_R}
Let $j$ be a modality and define $\Op:(\tRR_j\to\Prop)\to\Prop$ by
\[\Op(\phi)\coloneqq\forall(r:\tRR_j)\ldotp\phi r\imp\exists(\epsilon:\tRR_j)\ldotp\epsilon>0\wedge\forall(r':\tRR_j)\ldotp(-\epsilon<r-r'<\epsilon)\imp\phi(r').\]
It is easy to check condition 1. For condition 2, we obtain $\epsilon_1$ and $\epsilon_2$ from $\phi_1$ and $\phi_2$, respectively; we can satisfy the requisite condition using their infimum, $\min(\epsilon_1,\epsilon_2)>0$.

It remains to check condition 3. Let $I:(\tRR_j\to\Prop)\to\Prop$ satisfy $\forall(\phi:\tRR_j\to\Prop)\ldotp I(\phi)\imp\Op(\phi)$, i.e.\ $I$ is an open system. We need to show $\Op(\lambda(r:\tRR_j)\ldotp\exists(\phi:\tRR_j\to\Prop)\ldotp I(\phi)\wedge\phi (r))$. In other words, we need to show
\begin{multline*}
  \forall(r:\tRR_j)\ldotp[\exists(\phi:\tRR_j\to\Prop)\ldotp I(\phi)\wedge\phi(r)]\imp\exists(\epsilon:\tRR_j)\ldotp\epsilon>0\wedge\\
  \forall(r':\tRR_j)\ldotp(-\epsilon<r-r'<\epsilon)\imp\exists(\phi':\tRR_j\to\Prop)\ldotp I(\phi')\wedge\phi'(r).
\end{multline*}
So take $r:\tRR_j$ and suppose given $\phi$ such that $I(\phi)$ and $\phi(r)$ hold. It follow by hypothesis that $\Op(\phi)$ holds, so by definition we obtain $\epsilon>0$ satisfying the requisite condition with $\phi'\coloneqq\phi$.

All we used about $\tRR_j$ was that it has a definition of comparison ($a<b$), subtraction ($a-b$), that binary min's exist, and that the additive inverse of a binary min is a binary max.
\end{example}

\begin{definition}\label{def.continuous}
Suppose that $(X,\Op_X)$ and $(Y,\Op_Y)$ are internal topological space. A function $f:X\to Y$ is called \emph{continuous} if it satisfies
\[\forall(\phi:Y\to\Prop)\ldotp\Op_Y(\phi)\imp\Op_X(\phi f).\]
We denote by $\Cont(X,Y)$ the type of all $f:X\to Y$ satisfying this condition.
\end{definition}

\begin{proposition}
The internal topological spaces in a topos $\cat{E}$ and continuous maps form an external category with products, and the forgetful functor to $\cat{E}$ preserves products.
\end{proposition}
\begin{proof}
It is easy to check directly from \cref{def.continuous} that if $f:X\to Y$ and $g:Y\to Z$ are continuous then so is $g\circ f$, and the identity is clearly continuous. To check the existence of products, we need to define a product topology $\Op_{X\times Y}$ on $X\times Y$, given topologies $\Op_X$ and $\Op_Y$. Given $\phi:X\times Y\to\Prop$, define $\Op_{X\times Y}(\psi)$ to be
\begin{multline*}
	\exists(I:\mathrm{OpSys}(X))\ldotp\\
	[\forall(\phi:I)\ldotp\exists(\phi_X:\Op(X))(\phi_Y:\Op(Y))\ldotp\phi(x,y)\iff(\phi_X(x)\wedge\phi_Y(y))]\\\wedge[\forall(x:X)(y:Y)\ldotp\psi(x,y)\iff\exists(\phi:I)\ldotp\phi(x,y)]
\end{multline*}
Check that this is a topology and that it has the universal property of a product. (Unfinished)
\end{proof}

\begin{example}
The functions $+:\tRR_j\times\tRR_j\to\tRR_j$ and $*:\tRR_j\times\tRR_j\to\tRR_j$ are continuous; see \cite[Theorems 4.44, 4.48]{Schultz.Spivak:2017a}. For any $j\to j'$ the map $\tRR_j\to\tRR_{j'}$ is also continuous; see \cite[Proposition 4.52]{Schultz.Spivak:2017a}.
\end{example}

%%% The following is the Riesz approach
% \begin{definition}[Measure on an internal topological space]
%Let $(X,\Op_X)$ be an internal topological space, and let $\tRR_{\SeeInline{[d,u]}}$ be the $[d,u]$-reals with the usual topology (see \cref{ex.usual_topology_R}). Then a $[d,u]$-measure on $X$ is a function $\mu:\Cont(X,\tRRat{[d,u]})\to\tRRat{[d,u]}$
%satisfying the following properties:
%\begin{enumerate}
%	\item Linearity: $\mu(r*f+g)=r*\mu(f)+\mu(g)$ for $r:\tRR$ and $f,g:X\to\tRRat{[d,u]}$.
%	\item Positivity: $\mu(f)\geq 0$ whenever $f$ satisfies $\forall x\ldotp f(x)\geq 0$.
%\end{enumerate}
%Let $\const{Meas}_{[d,u]}(X)$ denote the type of measures on $X$ at $[d,u]$. A \emph{measure $\mu$ on $X$} consists of a measure $\mu_{[d,u]}\in\const{Meas}_{[d,u]}(X)$ for each $d,u:\tRR$ such that
%\[\forall(f:X\to\tRRat{[d',u']})\ldotp\See{[d,u]}\mu_{[d',u']}(f)=\mu_{[d,u]}(\See{[d,u]}f)\]
%holds for every $d\leq d'\leq u'\leq u$. Let $\const{Meas}(X)$ denote the type of measures on $X$.
%\end{definition}

\todo{Locally compact spaces as continuous posets}

\todo{Does at modality take locally compact spaces to locally compact spaces?}

\chapter{The topos of sheaves on spaces of compacts}

\section{Topological and domain-theoretic properties of $C\BaseSpace$}

For $\BaseSpace$ a space, we denote by $C\BaseSpace$ is set of nonempty compacts, equipped with the topology with basis sets $\{ K \subseteq U \}$ indexed by the opens $U \subseteq B$. This is also known as the \emph{upper space} of $B$~\cite{Edalat:1995a}.

\begin{proposition}
If $\BaseSpace$ is any space, then $C\BaseSpace$ is regularly-based.
\end{proposition}

\begin{proof}
The basic opens in $C\BaseSpace$ are given by the opens $U\subseteq \BaseSpace$, where the associated open in $C\BaseSpace$ contains all those compacts $K\subseteq \BaseSpace$ with $K\subseteq U$. We first show that the closure of this basic open consists of all compacts $K$ with $K\cap\overline{U} \neq \emptyset$. Clearly the complement of this set is open, since it is the open associated to the complement of $\overline{U}$. Moreover, it is the largest open with this property: if $V\subseteq B$ is any open for which $K\subseteq V$ implies $K \not\subseteq U$, then $V$ must be disjoint from $U$, since any single point in $V\cap U$ is itself a nonempty compact set. This proves the first claim.

Next, we show that the interior of the above closure is $\{ K \mid K\subseteq U\}$ again. We need to show that it is not larger; so for a given $K$ in this interior, we need to prove $K\subseteq U$. Being in the interior of the above closure means that there is an open $V$ with $K\subseteq V$ such that every $K' \subseteq V$ is in the closure, which means $K' \cap \overline{U} \neq \emptyset$. Again since points are compact, we get $V \subseteq U$, and therefore $K \subseteq U$, as was to be shown.

Since forming the interior of the closure is an idempotent operation (corresponding to double negation), the claim follows.
\end{proof}

Therefore all of the results from the previous section apply here as well.

If $\BaseSpace$ is Hausdorff, then the closure of a point $K\in C\BaseSpace$ is $\downarrow K=\{K'\in C\BaseSpace\mid K\ss K'\}$. It is closed since any $K'\not\supseteq K$ can be separated from a chosen $b\in K\setminus K'$ by an open, and it is clearly the smallest closed set containing $K$. It follows that the specialization preorder is reverse containment\footnote{The Sierpinski space shows that this is not true in general.}, and it is directed complete~\cite[Proposition~3.1]{Edalat:1995a}.

\todo[inline]{I'm not sure if the topology necessarily coincides with the Scott topology. Prop 3.1(iii) of Edalat suggests that it doesn't. But perhaps in the locally compact case?}

From now on, we assume that we have these properties:

\begin{axiom}
$\BaseSpace$ is Hausdorff.
\end{axiom}

For any $K\in CB$, we write $\At{K} := ((- \imp (\downarrow K)^c) \imp (\downarrow K)^c)$ for the associated quasi-closed modality, where $(\downarrow K)^c$ is the (open) complement of $K$. Since $\downarrow K$ is an irreducible closed set, it can be shown (along the lines of Lemma 5.37 of TTT) that we have:

\begin{lemma}\label{AtBoolean}
For every $P : \Prop$,
\[
	\At{K} P \lor (P \imp \At{K} \bot)
\]
\end{lemma}

Hence the topos of $\At{K}$-sheaves is Boolean.

\todo[inline]{T: Is it necessarily a copy of Set? D: I'm not sure, but I think so. One proof strategy might be to show that any inclusion of locales factors uniquely as a dense map followed by a closed map, that the same is true for inclusions of toposes, and that the sheaves-functor from locales to toposes preserves that factorization system.}

\begin{lemma}
For $K\in C\BaseSpace$, the complement $(\downarrow K)^c$ of $\downarrow K$ is a prime open.
\label{lem:prime}
\end{lemma}

\begin{proof}
Suppose that we have opens $P,Q\subseteq C\BaseSpace$ such that $(P\cap Q)\cap \downarrow K = \emptyset$. This implies $K\not\in P$ or $K\not\in Q$; suppose the former. Since an open is up-closed in the domain order, we have $P\cap \downarrow K = \emptyset$, as was to be shown.
\end{proof}

\begin{proposition}
If $(S,\sqss)$ is a domain, then it has posite structure whose covering families are the way-up-closures.

Suppose that these families are directed, i.e.\ that if $s\ll s'_1$ and $s\ll s'_2$ then there exists $s\ll s'$ with $s'\sqss s'_1$ and $s'\sqss s'_2$. Then the Kripke-Joyal semantics for $\vee$ degenerates: $s\Vdash\phi\vee\psi$ iff $s\Vdash\phi$ or $s\Vdash\psi$.
\end{proposition}
\begin{proof}
The fact that $(S,\sqss)$ has the structure of a posite whose covering families are way-up closures is \cite[Remark 2.21]{Schultz.Spivak:2017a}.

The Kripke-Joyal semantics for $\vee$ is that $s\Vdash\phi\vee\psi$ iff there exists a covering family $\{s_i\to s\}_{i\in I}$ such that $s_i\Vdash\phi$ or $s_i\Vdash\psi$ for each $i\in I$. Here we have only one covering family, namely $\{s'\mid s\ll s'\}$ for each $s$. Suppose that $\upclose s$ is filtered and that $s\Vdash\phi\vee\psi$. Arguing classically, if $s\not\Vdash\phi$ and $s\not\Vdash\psi$ then there is some $s'_1,s'_2\in\upclose s$ such that $s'_1\not\Vdash\phi$ and $s'_2\not\Vdash\psi$. Let $s\ll s'\sqss \{s_1,s_2\}$. Then by monotonicity $s'\not\Vdash\phi$ and $s'\not\Vdash\psi$, a contradiction.
\end{proof}


\section{Properties of modalities on $C\BaseSpace$}

\begin{lemma}\label{lem:at_disjunction}
For every $K\in C\BaseSpace$ and $P,Q : \Prop$, 
\[
	\At{K} ( P \vee Q ) \: \Leftrightarrow \: \At{K} P \vee \At{K} Q.
\]
\end{lemma}

\begin{proof}
The nontrivial implication is left to right, so assume $((P \vee Q) \imp (\downarrow K)^c ) \imp (\downarrow K)^c$, or equivalently $((P \imp (\downarrow K)^c) \wedge (Q \imp (\downarrow K)^c)) \imp (\downarrow K)^c$. By \cref{lem:prime}, this means that one of $P \imp (\downarrow K)^c$ or $Q \imp (\downarrow K)^c$ implies $(\downarrow K)^c$, as was to be shown.
\end{proof}

\begin{definition}
An object $X$ is \emph{flabby} if
\[
	\forall P : X\to\Prop \ldotp \forall U \ldotp (\In{U} \exists x. P(x) ) \imp \exists x. \In{U} P(x).
\]
\end{definition}

Since the other implication is trivial, flabbiness thus means that the modalities $\In{U}$ commute with existential quantifiers.

\begin{lemma}
$\Prop$ is flabby.
\end{lemma}

\begin{proof}
\todo[inline]{???}
\end{proof}

\begin{lemma}
Let $X$ be flabby and $P : X \to \Prop$ a predicate. Then for all $K \in C\BaseSpace$,
\[
	\exists x\ldotp \At{K} P(x) \: \Leftrightarrow \: \At{K} \exists x\ldotp P(x).
\]
\end{lemma}

\begin{proof}
The nontrivial direction is from right to left.
\todo[inline]{???}
\end{proof}


\chapter{Internal valuations}



\begin{definition}
Suppose $X$ is a locale. A \emph{valuation} on $X$ is a function $\mu:\mathcal{O}(X)\to\tRRat{[d,u]}$ satisfying the following:
\begin{enumerate}
	\item $\mu(\varnothing)=0$.
	\item $\forall(x,x':X)\ldotp(x\leq x')\imp\mu(x)\leq\mu(x')$.
	\item $\forall(x,x':X)\ldotp\mu(x)+\mu(x')=\mu(x\vee x')+\mu(x\wedge x')$.
	\item $\forall(D:X\to\Prop)\ldotp\const{Drct}(D)\imp \mu(\sup(D))=\sup(\mu(D))$.
\end{enumerate}
Here, $\mu(D)$ is shorthand for the subtype $\mu(D)=\{\mu x\mid Dx\}$.%
\footnote{Completely formally, $\mu(D)\coloneqq\{r:\RR\mid\exists(x:\subtype{D})\ldotp r=\mu(x)\}$.}

Let $\VV(X)$ denote the type of valuations $\mu$, ordered by $(\mu\leq\mu')\iff\forall(x:X)\ldotp(\mu x\leq \mu'x)$.
\end{definition}

\begin{definition}
A valuation is a \emph{probability valuation} if $\mu(X) = 1$.
\end{definition}

\section{The valuations profunctor}

If $\cat{C}$ is a category with finite limits and small colimits then one can define frames and symmetric monoidal DCPOs internal to $\cat{C}$. From here, one can define normalized complete valuations (probability valuations) as a profunctor
\[V_{\cat{E}}\colon\Fun{Frm}(\cat{E})\tickar\Fun{SMonDCPO}(\cat{E})\]
In other words, one can precompose a probability valuation with a frame morphism on the left or post-compose with a monoidal DCPO map on the right. We will usually refer to this profunctor more simply as the \emph{valuations profunctor}.

The question is how direct image functors $f_*\colon\cat{E}\to\cat{E}'$ interact with the valuations profunctor. What we want is a 2-cell in the double category of categories, functors, and profunctors:
\begin{equation}\label{eqn.direct_image_valuations}
\begin{tikzcd}
	\Fun{Frm}(\cat{E})\ar[r, tick, "V_{\cat{E}}"]\ar[d, "\Fun{Frm}(f_*)"']&\Fun{SMonDCPO}(\cat{E})\ar[d, "\Fun{SMonDCPO}(f_*)"]\\
	\Fun{Frm}(\cat{E}')\ar[r, tick, "V_{\cat{E}'}"']&\Fun{SMonDCPO}(\cat{E}')\ar[ul, phantom, "?\Downarrow"]
\end{tikzcd}
\end{equation}
where the functors on the left and right were (hopefully) established in \cref{sec.preserve_loc_frame}. Intuitively, given a valuation $\mu\colon F\to R$ upstairs, we want to define a valuation $\mu'\colon f_*F\to f_*R$ downstairs. There is an obvious candidate, namely $\mu'\coloneqq f_*\mu$. The question is whether this preserves the various structures.

It should be obvious that $\mu'$ is monotonic. We believe that $\mu'$ will commute with directed joins by the work in \cref{sec.preserve_loc_frame}. Both the top and bottom element of an internal frame can be characterized by an equational theory, so they should be preserved by left-exact functors such as $f_*$. It remains to show that $\mu'$ satisfies inclusion-exclusion.

To begin with, we need to know that $f_*$ commutes with binary joins; but what does this mean? We want to define binary joins equationally on a frame $F$ as $\vee\colon F\times F\to F$, and then ask that $f_*(\vee_F)=\vee_{f_*F}$, but then the question becomes ``in what sense is the binary join operation the same as the actual binary join?'' In other words, what if we're only preserving a structure, not the universal property it is supposed to satisfy?

For any pair of objects $A^B$ in a topos there is a map $\im\colon A^B\to\Prop^A$, that ``sends a map to its image''. Namely, use the predicate $I\colon A\times A^B\to\Prop$ given by $I(a,f)=\exists(b:B)\ldotp f(b)=a$. Thus we get a diagram, and the above questions are whether it commutes:
\[
\begin{tikzcd}
	F\times F\ar[d, equal]\ar[r, "\vee"]&F\\
	F^{1+1}\ar[r, "I"']&\Prop^F\ar[u, "\bigvee"']\ar[ul, phantom, "?"]
\end{tikzcd}
\]
The goal then is to encode the universal property itself in an equational way. Take the graph of the function $\vee\colon F\times F\to F$ and call it $G(\vee)\ss F\times F\times F$. There are two equations that characterize it as the graph of a function, so we know that $f_*$ will send it to the graph of a function, which must again be $f_*(\vee_F)$. We want to characterize its universal property. We thought it is roughly the following:
\[
\begin{tikzcd}
	\{w,x,y,z:F\mid x\leq z, y\leq z, w=x\vee y\}\ar[r]\ar[d]\ar[dd, shift right=40pt, bend right=60pt, dotted]
	&\{w,x,y,z:F\mid (x,y,w)\in G(\vee)\}\ar[d]\\
	\{w,x,y,z:F\mid x\leq z, y\leq z\}\ar[r]&\{w,x,y,z:F\}\ar[ul, phantom, very near end, "\lrcorner"]\ar[d]\\
	\{w,z\mid w\leq z\}\ar[r]&\{w,z:F\}
\end{tikzcd}
\]

Now we have that the direct image map $f_*$ preserves everything that's equationally defined, so we are willing to bet on the following.
\begin{proposition}
A direct image functor $f_*\colon\cat{E}\to\cat{E'}$ preserves valuations in the sense that it induces a 2-cell as shown in \cref{eqn.direct_image_valuations}.
\end{proposition}

\newpage
\chapter{Properties of internal valuations}

\begin{definition}
Say that a topos $\cat{E}$ is \emph{regularly-based} if the following statement holds internally:
\[\forall(P:\Prop)\ldotp P\imp\exists(Q:\Prop)\ldotp (Q\imp P)\wedge(\neg\neg Q\imp Q)\wedge Q.\]
\end{definition}

Equivalently, we could have said that every $P:\Prop$ must be the supremum of all $Q:\Prop$ with $Q\imp P$ and $\neg\neg Q\imp Q$. For topological spaces, recall that an open set $U$ in a topological space is called \emph{regular} if it is the interior of its closure, or in other words $\neg\neg U=U$. Because $\neg\neg$ is a dense modality, the set of regular opens contains the whole space, the empty set, and is closed under finite intersections. So for the topos of sheaves on a space, our condition expresses the requirement that the regular opens form a basis, i.e.\ for all $P\in\Op$, we have $P=\bigcup {\{Q\ss P\mid \neg\neg Q=Q\}}$.

\begin{remark}
In the book \emph{Counterexamples in Topology} they define semi-regular spaces to be Hausdorff spaces that are regularly-based in our sense above. We are certainly interested in cases where the space is not Hausdorff, e.g.\ $\IR$.

It is not hard to show however that any regular space is regularly-based in our sense. 
\end{remark}

\section{Valuations on $\Prop$}

Consider the function $i\colon\Prop\to\tLR$ defined as follows
\[i(P)(q)\coloneqq(q<0)\vee((q<1)\wedge P).\]
We next show that it is a probability valuation (probability valuation). Later we will show that, under some conditions, it is unique such.

\begin{proposition}\label{prop.sandwich}
The function $i\colon\Prop\to\tLR$ defined above is indeed a probability valuation on $\Prop$, and for any probability valuation $\mu\colon\Prop\to\tLR$, we have $i\leq\mu\leq i\neg\neg$.
\end{proposition}
\begin{proof}[Sketch]
It's not hard to show that $i$ is a probability valuation. The proof of the inclusion-exclusion formula for $i$ involved using $\max$ and $\min$ in one direction, and using case analysis in the other direction. To show that $i\leq\mu$, one uses monotonicity and normality of $\mu$. To show that $\mu\leq i\neg\neg$, take $P:\Prop$ and $q:\tQQ$ with $0\leq q$; we need to show $\mu(P)(q)\imp\neg\neg P$. Assume $\mu(P)(q)$ and $\neg P$. Then by monotonicity applied to $P \imp \bot$ we have $\mu(\bot)(q)$, and by $\mu(\bot)=0$, this means $q<0$, a contradiction.
\end{proof}

\begin{proposition}\label{prop.unique_probability_valuation_on_prop}
Suppose that $\cat{E}$ is regularly-based. Then $i\colon\Prop\to\tLR$ is the unique probability valuation on $\Prop$. 
\end{proposition}
\begin{proof}
Let $\mu$ be an arbitrary valuation; we want to show $\mu=i$. Define a subtype $T\coloneqq\{P:\Prop\mid\mu(P)=i(P)\}$, where $T$ stands for target; we want to show that $T=\Prop$. If $Q = \neg\neg Q$, then by \cref{prop.sandwich} we have $i(Q)\leq\mu(Q)\leq i(\neg\neg Q)=i(Q)$, so that $Q\in T$.

Next suppose that we are given $Q_1,Q_2\in T$. It is not hard to show that $i(Q_1\vee Q_2)=\max(i(Q_1),i(Q_2))$ and $i(Q_1\wedge Q_2)=\min(i(Q_1),i(Q_2))$ by definition of $i$. Thus
\begin{align*}
	i(Q_1\vee Q_2)+i(Q_1\wedge Q_2)
	&\leq\mu(Q_1\vee Q_2)+i(Q_1\wedge Q_2)\\
	&\leq \mu(Q_1\vee Q_2)+\mu(Q_1\wedge Q_2)\\
	&=\mu(Q_1)+\mu(Q_2)\\
	&=i(Q_1)+i(Q_2)
\end{align*}
Since $i(Q_1\vee Q_2)+i(Q_1\wedge Q_2)=i(Q_1)+i(Q_2)$, it follows that all the above inequalities must be equalities, resulting in $\mu(Q_1\vee Q_2)=i(Q_1\vee Q_2)$ and $\mu(Q_1\wedge Q_2) = i(Q_1\wedge Q_2)$. Therefore $(Q_1 \vee Q_2) \in T$ and $(Q_1\wedge Q_2)\in T$.

Since every join can be decomposed into a directed join of finite joins, by assumption an arbitrary proposition $P:\Prop$ is a directed join of elements in $T$. Thus it suffices to show that $T$ is closed under directed joins, but this is clear: if $(Q_d)_{d\in D}$ is a directed system where $Q_d\in T$ for all $d$, then
\[\mu(\sup_{d\in D}Q_d)=\sup_{d\in D}\mu(Q_d)=\sup_{d\in D} i(Q_d)=i(\sup_{d\in D}Q_d).\qedhere\]
\end{proof}

\begin{example}
The assumption that $\cat{E}$ is regularly based is necessary. For example, consider the topological space where $\NN$ is the set of points and a subset $U\ss\NN$ is open $U\in \Op$ iff it is either empty or cofinite. This space is not regularly-based because the only regular opens are $\emptyset$ and $\NN$; for any other $U$, we have $\neg\neg U=\NN$. Consider the function $\mu\colon\Op\to\LR$ given by
\[\mu(U)=\begin{cases}0&\tn{ if }U=\emptyset\\1&\tn{ if }U\neq\emptyset\end{cases}\]
Then $\mu$ is monotonic, normalized, and commutes with directed joins. It satisfies inclusion exclusion because (three out of four cases are clear and) the intersection of cofinite sets is cofinite, and in particular nonempty.
\todo[inline]{We should check that this external reasoning internalizes}
\end{example}

\section{Interaction of valuations with modalities}

The following holds for any open modality $\In{U}\coloneqq (U\imp -)$.
\begin{proposition}\label{prop.In_probability_valuation}
\[\In{U}\mu(\In{U}P)=\In{U}\mu(P).\]
\end{proposition}
Semantically, this is just naturality of $\mu$ as a morphism of sheaves.
\begin{proof}
One direction is obvious, so suppose $U\imp\mu(U\imp P)$; we want to show $U\imp\mu(P)$. But assuming $U$ we have $\mu(U\imp P)$ which is the same as $\mu(P)$.
\end{proof}

For any nonnegative lower real $x:\tLR$, let $\bar{x}\coloneqq\min(x,1)$.

\begin{proposition}\label{prop.valuations_OR}
Suppose $P:\Prop$ and $Q:X\to\Prop$ for some $X$. Then
\begin{enumerate}
\item \[\mu(P\vee Q)=\ol{P\vee\mu(Q)}.\]
\item \[\mu(P\wedge Q) = P \wedge \mu(Q).\]
\end{enumerate}
\end{proposition} 
\begin{proof}
\begin{enumerate}
\item The $\geq$ direction is trivial, so we want to show the $\leq$ direction, that $\mu(P\vee Q)(q)\leq P\vee\mu(Q)(q)$ for all $q:\tQQ$.

It is enough to show $P\vee\mu(P\vee Q)\leq P\vee\mu(Q)$. By inclusion-exclusion we have $\mu(P\vee Q)+\mu(P\wedge Q)=\mu(P)+\mu(Q)$ and any modality, including $(P\vee-)$, commutes with addition. Hence, by order-cancellativity \cref{lem.order_canc}, it is enough to show $P\vee\mu(P)\leq P\vee\mu(P\wedge Q)$.
For this it suffices to show $\mu(P)\leq P\vee\mu(P\wedge Q)$, but by \cref{prop.unique_probability_valuation_on_prop}, the left-hand side is just $P$.
\item Using inclusion-exclusion, \cref{prop.unique_probability_valuation_on_prop}, and the fact that $\min(a,b)+\max(a,b)=a+b$ for any lower reals, $a,b:\tLR$, we have
\begin{align*}
	\mu(P\wedge Q)+\mu(P\vee Q)=\mu(P)+\mu(Q)
	&=(P\vee\mu(Q))+(P\wedge\mu(Q))\\
	&=\mu(P\vee Q)+(P\wedge\mu(Q)).
\end{align*}
Thus we are done by order-cancellativity \cref{lem.order_canc}.
\end{enumerate}
\end{proof}

\chapter{Properties of internal valuations on spaces of compacts}

\section{Properties of the lower reals}

\begin{lemma}\label{enough_points_prop}
For any $P : \Prop$,
\[ P = \forall K \ldotp \At{K} P. \]
\end{lemma}

From the internal perspective, it may be more reasonable to consider this as an axiom---stating that our topos has enough points---since it cannot be proven purely internally.

\begin{proof}
\todo[inline]{TBW}
\end{proof}

\begin{proposition}\label{enough_points_LR}
For any $r:\tLR$,
\[r = \inf_{K} \At{K} r.\]
\end{proposition}
\begin{proof}
The right-hand side, applied to some $q:\tQQ$, is translated to
\[\forall K. \At{K}(q<r),\]
which is $q<r$ by \cref{enough_points_prop}.
\end{proof}

\begin{lemma}\label{lem.order_canc}
The lower reals are order-cancellative: if $a+b\leq a+c$ then $b\leq c$.
\end{lemma}

\begin{proof}
\todo[inline]{Derive this from \cref{enough_points_LR}, together with the $\At{K}$-decidability.}
\end{proof}

\section{Interaction of valuations with modalities}

\begin{proposition}\label{prop:double_at}
Let $K\in C\BaseSpace$ be a point, let $X\in\Shv(C\BaseSpace)$, and let $\mu\colon\Prop^X\to\tLR$ be a valuation. Then for any $P \in \Prop^X$,
\[\mu(\At{K}P)=\ol{\At{K}\mu(\At{K}P)}.\]
\end{proposition}
\begin{proof}
We have ; this and the fact that $\At{K}$ commutes with addition, are the only assumptions we use.

Clearly $\mu(\At{K}P)\leq\At{K}\mu(\At{K}P)$ and $\mu(P\imp\At{K}\bot)\leq\At{K}\mu(P\imp\At{K}\bot)$. By inclusion-exclusion we have
\[\mu(\At{K}P)+\mu(P\imp\At{K}\bot)=\mu(\At{K}\bot)+\mu(\top),\]
where we have used $(\At{K}P\vee(P\imp\At{K}\bot)) = \top$ for the second term on the right-hand side.
Since $\At{K}\bot$ is a constant predicate, we have $\mu(\At{K}\bot)=i(\At{K}\bot)=\ol{\At{K}0}$, by \cref{prop.unique_probability_valuation_on_prop}. Therefore we have 
\begin{align*}
	\ol{\At{K}0}+1
	&=\mu(\At{K}P)+\mu(P\imp\At{K}\bot)\\
	&\leq\At{K}\mu(\At{K}P)+\At{K}\mu(P\imp\At{K}\bot)\\
	&=\ol{\At{K}0}+\ol{\At{K}1}=\ol{\At{K}0}+1
\end{align*}
where in the third step, we have applied to same inclusion-exclusion relation again, together with the fact that,$\At{K}$ commutes with addition. Since the very first and the very last expression are the same, we conclude (by order-cancellativity) that both inequalities  $\mu(\At{K}P) \leq \At{K}\mu(\At{K}P)$ and $\At{K}\mu(P\imp\At{K}\bot) \leq \At{K}\mu(P\imp\At{K}\bot)$ are in fact equalities.
\end{proof}


\begin{lemma}\label{lem.In_At_logic}
If $K\ss U$ then $\In{U}P\imp\At{K}P$, for all $P$.
\end{lemma}
\begin{proof}
If $K\ss U$ then $\At{K}U$, i.e.\ $(U\imp(\down K)^c)\imp(\down K)^c$. Thus if $U\imp P$ and $P\imp(\down K)^c$ then $(\down K)^c$.
\end{proof}

\begin{proposition}
For all $K\subseteq U$ and $P\colon X\to\Prop$ we have
\[\At{K}\mu(P)=\At{K}\mu(\In{U}P).\]
\end{proposition}
\begin{proof}
One direction is trivial. For any $q:\tQQ$ we have
\begin{align*}
	\At{K}\mu(\In{U}P)(q)
	&\imp\At{K}\In{U}\mu(\In{U}P)(q)\\
	&=\At{K}\In{U}\mu(P)(q)&\text{\cref{prop.In_probability_valuation}}\\
	&\imp\At{K}\At{K}\mu(P)(q)&\text{\cref{lem.In_At_logic}}\\	
	&=\At{K}\mu(P)(q).
\end{align*}
\end{proof}

Here, the equation $\At{K}\In{U} = \At{K}$ follows straightforwardly from the definitions of the modalities, together with the fact that the assumption $K\subseteq U$ is equivalent to $U \lor (\downarrow K)^c = \top$.

We say that $U$ is coprime if it satisfies the following for all $P,Q$:
\[(U\imp (P\vee Q))\iff((U\imp P)\vee(U\imp Q)).\]
The interval domain $\IR$ has a basis $\upclose[d',u']$ of coprime opens. 







\chapter{Semantics of valuations on spaces of compacts}

While the results of the previous sections were completely internal, we now use them in order to analyze the semantics of probability valuation's in $\Shv(C\BaseSpace)$.

An internal probability valuation $\mu\colon\Prop^X\to\tLR$ on $\cat{E}$ gives rise to an external monotonic map
\[|\mu|\colon\cat{E}(X,\Omega)\times\pt(\cat{E})\to\LR\]
that is Scott continuous (at least in each variable) and a probability valuation for each point $a\in\pt(\cat{E})$.

\todo[inline]{I don't see this at this level of generality. Are we trying to transport the valuation along $a^*$ here?}

Consider the case where $\BaseSpace$ is a compact space, $C\BaseSpace$ is its space of compacts, and $\cat{E}=\Shv(C\BaseSpace)$. In this case, if $X\in\cat{E}$ is a sheaf, then evaluation at $\BaseSpace$ is the same thing as taking global sections, $X(\BaseSpace)\cong\Gamma(X)$; we denote it by $|X|$. If $r\in\tLR$ is a lower real, then we also write $|r|$ for the associated lower semi-continuous function on $C\BaseSpace$. For example, we have $|\mu(\top)|(K) = 1$ by normalization for every $K\in C\BaseSpace$.

\begin{lemma}\label{lemma.inequality_rand9865}
Let $\cat{E}$ be as above. For any point $K\in\pt(\cat{E})$ and predicate $P\colon X\to \Prop$, we have
\[
\sup_{U\ni K} \At{\BaseSpace} \mu(\At{\BaseSpace}\In{U}P) \leq \At{\BaseSpace} \At{K} \mu(P),
\]
where $U$ ranges over all (basic) neighborhoods of $K$.
\end{lemma}
\begin{proof}
The proof uses a few facts:
\begin{enumerate}
	\item The fact that $\BaseSpace$ is Scott-minimal is internally expressed as an equivalence of modalities, $\At{\BaseSpace}=\See{\BaseSpace}$.
	\item $\See{\BaseSpace}\mu(P)=\mu(\See{\BaseSpace}P)$ by \cref{prop.valuations_OR}
	\item If $K\in U$, then $\At{K}\In{U} = \At{K}$.
\end{enumerate}
We have now established the following:
\begin{align}
\nonumber
	\sup_{U\ni K}\mu(\At{\BaseSpace}\In{U}P)
	&=\sup_{U\ni K}\mu(\At{\BaseSpace}\In{U}P)&\text{\cref{prop:double_at}} \\\nonumber
	&=\sup_{U\ni K}\mu(\See{\BaseSpace}\In{U}P)&\text{item 1}\\\nonumber
	&=\sup_{U\ni K}\See{\BaseSpace}\mu(\In{U}P)&\text{item 2}\\\nonumber
	&=\sup_{U\ni K}\At{\BaseSpace}\mu(\In{U}P)&\text{trivial}\\\nonumber
	&\leq\sup_{U\ni K}\At{\BaseSpace}\At{K}\mu(\In{U}P)&\text{increasing}\\\nonumber
	&=\sup_{U\ni K}\At{\BaseSpace}\At{K}\In{U}\mu(\In{U}P)&\text{item 3}\\\nonumber
	&=\sup_{U\ni K}\At{\BaseSpace}\At{K}\In{U}\mu(P)&\text{\cref{prop.In_probability_valuation}}\\\nonumber
	&=\At{\BaseSpace}\At{K}\mu(P)&\text{item 3}
\end{align}
\end{proof}


We are ready to prove that this inequality is actually an equality. This shows that we can recover the action of $\mu$ on arbitrary (global) predicates from its action on global sections of the very special $\At{B}$ form.

\begin{theorem}\label{thm.discrete_internal_space}
Let $\BaseSpace$ be a compact Hausdorff space, $C\BaseSpace$ is its space of compacts, $X\in \Shv(C\BaseSpace)$ and $\mu : \Prop^X \to \tLR$ a probability valuation. For any predicate $P:X\to\Prop$ and $K\in C\BaseSpace$, we have
\[
\At{B} \At{K} \mu(P) = \sup_{U\ni K} \At{B} \mu(\At{B}\In{U}P).
\]
\end{theorem}
\begin{proof}
Using \cref{lemma.inequality_rand9865} and replacing the right-hand side by a constant sup, we have the inequality
\[
	\sup_{U\ni K} \At{\BaseSpace} \mu(\At{\BaseSpace}\In{U}P) \leq \sup_{U\ni K} \At{\BaseSpace}\At{K} \mu(P).
\]
These are directed sups, so by Scott continuity, we have equivalently \todo{$\At{K}$ commutes with existential quantifiers?}
\[
	\At{\BaseSpace} \mu(\exists U\ldotp \At{K}U\wedge\In{U}P) \leq \At{\BaseSpace} \At{K} \mu(\exists U\ldotp \At{K}U\wedge\In{U}P).
\]
Now we use one of our favorite tricks: we apply the above inequality to both $P$ and $P\imp\At{a}\bot$, and then add them and use inclusion-exclusion.
We obtain something of the form $\At{\BaseSpace}\mu(X) + \At{\BaseSpace}\mu(Y) \leq \At{\BaseSpace}\At{K} \mu(X) + \At{\BaseSpace}\At{K} \mu(Y)$, where
\begin{align*}
	X\coloneqq(\exists U\ldotp \At{K}U\wedge\In{U}P)\wedge\big(\exists U\ldotp \At{K}U\wedge\In{U}(P\imp\At{K}\bot)\big), \\
	Y\coloneqq(\exists U\ldotp \At{K}U\wedge\In{U}P)\vee\big(\exists U\ldotp \At{K}U\wedge\In{U}(P\imp\At{K}\bot)\big).	
\end{align*}
We will show that $Y=\top$ and that $X\imp\At{K}\bot$. This will complete the proof because $\At{K}\mu(\At{K}\bot) = \At{B}\mu(\At{K}\bot) = 0$.

First we show $X\imp\At{K}\bot$. We claim $X\imp\exists U\ldotp \At{K}U\wedge\In{U}(P\wedge P\imp\At{K}\bot)$; indeed, take $U$ to be the conjunction of the existentials from $X$ and use the fact that $\At{K}$ and $\In{U}$ commute with $\wedge$. From here we get $\exists U\ldotp\At{K}U\wedge\In{U}\At{K}\bot$. Since $\In{U}P$ means $U\imp P$, we obtain $\At{K}\bot$ by monotonicity of $\In{U}$ and idempotence of $\At{K}$.

We now show $Y=\top$. By cases we have $\exists U\ldotp\At{K}U\wedge(\In{U}P\vee\In{U}(P\imp\At{K}\bot))\imp Y$. Thus to prove $Y$, it is enough to show that the following existential statement holds:
\[\exists U\ldotp\At{K}U\wedge(\In{U}P\vee(P\imp\At{K}\bot)).\]
By \cref{AtBoolean}, we have $\At{K}P\vee (P\imp\At{K}\bot)$. In the first case, take $U=P$ and the existential holds. In the second case, take $U$ to be any open for which $\At{K}U$ holds. This completes the proof.
\end{proof}


\section{Main theorem: correspondence with external valuations}


\begin{theorem}\label{conj.may8}
Let $\BaseSpace$ be a compact Hausdorff space and $X\in\Shv(C\BaseSpace)$. Then there is a bijection
\begin{multline*}
  \{\tn{internal probability valuations } \mu\colon \Prop^X \to\tLR\}
	\cong\\[4pt]
	\{\tn{external probability valuations } \mu'\colon 2^{X(B)} \to\LR\}
\end{multline*}
\end{theorem}

One special case is when $X$ has no global sections, so that the external set is empty. Another special case is \cref{prop.unique_probability_valuation_on_prop}, namely for $X = 1$ the terminal sheaf.

The proof crucially relies on \cref{thm.discrete_internal_space}.

\begin{proof}
Starting with $\mu$ and given $S \subseteq X(B)$, the subsheaf of $S$ generated by $X$ is a global section of $\Prop^X$.
\end{proof}

\begin{proposition}
\cref{conj.may8} holds in the case that $p\colon U\ss CB$ is the inclusion of an open set.
\end{proposition}
\begin{proof}
If $U=CB$ then there is exactly one section, so there is exactly one external valuation, and the result follows from \cref{prop.unique_probability_valuation_on_prop}.

So suppose that $U\neq CB$. Then there are no external probability valuations because the set $\Gamma(p)$ is empty. We suppose for contradiction that $\mu\colon p_*\Omega_U\to\tLR$ is an internal valuation. Then composing with the unique internal frame homomorphism $!\colon\Prop\to p_*\Omega_U$, we have an internal valuation $\mu\circ !$ on $\Prop$. By \cref{prop.unique_probability_valuation_on_prop}, we have $\mu\circ!=i$, where $i\colon\Prop\to\tLR$ is the indicator function.

Clearly $\church{i}(U)\neq \church{i}(CB)$, because these functions differ on points in the complement of $U$. But $\church{!}(U)=U\cap U=U\cap CB=\church{!}(CB)$, so $\church{\mu\circ !}(U)=\church{\mu\circ!}(CB)$, a contradiction.
\end{proof}


\chapter{Correspondence with stochastic processes}

Here, we will investigate how probability valuation's on spaces of sections can be identified with stochastic processes in the conventional sense.

\chapter{Open questions}

Do probability valuations internal to some topos $\cat{E}$ give rise to a probability monad?



\newpage

\appendix


\appendix

\chapter{Unsorted material}

\section{Modalities preserve infima}

For any predicate $f:\Prop\to\Prop$, the infimum is $\forall(P:\Prop)\ldotp(fP\imp P)$.

\begin{lemma}
For any modality $j$, the type $\Prop_j$ is closed under infima. That is, for any $f:\Prop_j\to\Prop$
\[(j\forall(P:\Prop_j)\ldotp fP\imp P)\imp\forall(P:\Prop_j)\ldotp fP\imp P.\]
\end{lemma}
\begin{proof}
Assume $j\forall P\ldotp fP\imp P$, and move the $j$ inside the $\forall$ and the implication, to obtain $\forall P\ldotp fP\imp jP$. To prove $\forall(P:\Prop_j)\ldotp fP\imp P$, take any $P:\Prop_j$. Then we have $jP$ by assumption, which implies $P$ by $j$-closure.
\end{proof}

\section{Internalizing sups}
 
The (internalized) sup is just shorthand: $\sup_{U\ni K}X(U)\coloneqq \exists U\ldotp \At{K}U\wedge X(U)$.

One issue is ``internalizing the sup''. We think that works, but it's not technically proven. The argument is basically that we can check the following external fact holds about points contained in opens:
\[\big(K\in\church{\exists(U)\ldotp\At{K}U\wedge\In{U}P}\big)\iff\big(\text{there exists $U$ such that $K\in U$ and }K\in\church{\In{U}P}\big).\]

\section{Preservation of internal adjunctions}

All left exact functors $F$ preserve internal adjunctions $L\dashv R$. The finite limit preservation ensures that the $F$-image of a category object is a category object, and similarly for functors. But once you have that, the idea is to construct the unit and counit and see that they're preserved. Write down the diagram
\[
\begin{tikzcd}
	\Ob(C)\ar[drr, bend left, "RL"]\ar[ddr, bend right, equal]\ar[dr, "\eta"]\\
	&\Mor(C)\ar[r, "cod"]\ar[d, "dom"]&\Ob(C)\\
	&\Ob(C)
\end{tikzcd}
\]
and similarly for $\epsilon$, and assert the triangle identities; all of this structure will be preserved by $F$.

\chapter{Toy example}

\todo[inline]{We can recycle some of the following to use as our running example for illustration}

How about considering only two instances of time first, so that we work in the presheaf topos over the discrete two-point space $\{a,b\}$? Here, we will only need three modalities, where $\pi$ corresponds to sheafification, and $\At{a}{}$ and $\At{b}{}$ correspond to behavior at $a$ and $b$, respectively. In this case, measures on types (or suitable locales) which satisfy $\pi$ should semantically correspond to pairs of random variables equipped with a joint distribution. This is a good test case where the essential structures already come up, but without the technical complexity of TTT.

This is the topos $\Span\set$, where $\Span$ is the category \fbox{$a\from ab\to b$}. The subobject classifier for $\Span\set$ has five global sections, which we can represent as follows:
\[\church{\Prop}(ab)=\{\bot,a,b,a\vee b,\top\}.\]
We have $a=(\neg b)=(b\imp a)$ and similarly $b=(\neg a)=(a\imp b)$.

Here is a type theory for $\Span\set$: no atomic types, no atomic terms, two atomic propositions $a,b:\Prop$, and two axioms: $a=\neg b$ and $b=\neg a$. Note that $a=\neg\neg a$ and similarly $b=\neg\neg b$, but not so for $a\vee b$; the logic is not boolean.

The analogous modalities to those used in TTT are:
\[
\begin{array}{c|c|rccc}
	\textbf{modality}&\textbf{definition on } P:\Prop&\textbf{values: }\bot&a&b&a\vee b \\\hline
	\In{a}&a\imp P&b&\top&b&\top\\
	\See{a}&b\vee P&b&a\vee b&b&a\vee b\\
	\At{a}&(P\imp b)\imp b&b&\top&b&\top\\\hline
	\In{b}&b\imp P&a&a&\top&\top\\
	\See{b}&a\vee P&a&a&a\vee b&a\vee b\\
	\At{b}&(P\imp a)\imp a&a&a&\top&\top\\\hline
	\pi&\At{a}P\wedge\At{b}P&\bot&a&b&\top
\end{array}
\]

\begin{remark}
Semantically we see that $\church{\In{a}}=\church{\At{a}}$, but in fact, our axioms may not be strong enough to prove that internally. It is easy to show $\forall(P:\Prop)\ldotp(a\imp P)\imp(P\imp b)\imp b$, but I do not see how to show $\forall(P:\Prop)\ldotp[(P\imp b)\imp b]\imp^? (a\imp P)$. Without additional axioms, we have to decide whether to work with $\At{a}$ or $\In{a}$ in our notion of measure; we use $\At{}$ so as to remain faithful to the TTT case. 
\end{remark}

Although defined as the topos on presheaves on the discrete two-point space $\{a,b\}$, our topos $\Span\set$ can also be viewed as the topos of \emph{sheaves} on a topological space $W$, with three points $a,b,ab$ and four open sets: $\emptyset$, $W$, $\{a\}$ and $\{b\}$. The type $\tRR$ corresponds to the constant sheaf, by general theory of real number objects in localic toposes.

\begin{theorem}
Given finite sets $A$ and $B$, valuations on the power object of the $\pi$-type given by the product projections span
\[\begin{tikzcd}
	& A \times B \ar{dl} \ar{dr} \\
	A & & B
\end{tikzcd}\]
are semantically in bijective correspondence with probability measures on $A\times B$.
\end{theorem}

Here, our valuations take values in the lower reals.

We also write $(A,B)\in\Span\set$ as shorthand for the above span. So the global elements of the object of valuations on $(A,B)$ are precisely the probability measures on $A\times B$.

\begin{proof}
The lower reals are given by the span
\[\begin{tikzcd}
	& \{ (x, y, z) \in\mathbb{R}^3 \:\mid\: x,y\geq z \} \ar[swap]{dl}{(x,y,z)\mapsto x} \ar{dr}{(x,y,z)\mapsto y} \\
	\mathbb{R} & & \mathbb{R}
\end{tikzcd}\]
The power object $\Prop^{(A,B)}$ is given by the span
\[\begin{tikzcd}
	& Nat(A,B) \ar{dl} \ar{dr} \\
	\{\bot,\top\}^A & & \{\bot,\top\}^B
\end{tikzcd}\]
where $Nat(A,B)\subseteq \{\bot,a,b,a\lor b,\top\}^{A\times B}$ is the subset consisting of those functions $\phi : A\times B \to \{\bot,a,b,a\lor b,\top\}$ with the property that $\At{a} \phi(x,y)$ is independent of $y$, and likewise $\At{b} \phi(x,y)$ is independent of $x$. Hence the elements of $Nat(A,B)$ can be identified with triples $(S,T,U)$ where $S\subseteq A$ and $T\subseteq B$ as well as $U\subseteq S\times T$; the truth value of $(x,y)$ is $\geq a$ iff $x\in S$; it is $\geq b$ iff $y\in T$; and finally it is $\top$ iff $(x,y)\in U$. In this picture, the maps on the two legs are simply $(S,T,U)\mapsto S$ and $(S,T,U)\mapsto T$. The connectives are given componentwise,
\begin{align*}
	(S_1,T_1,U_1) \land (S_2,T_2,U_2) & = (S_1\cap S_2,T_1\cap T_2,U_1\cap U_2),\\
	(S_1,T_1,U_1) \lor (S_2,T_2,U_2)  & = (S_1\cup S_2,T_1\cup T_2,U_1\cup U_2).
\end{align*}
By all this, a global element of the object of normalized valuations is a diagram
\[\begin{tikzcd}
	& \{(S,T,U) \:\mid\: S \subseteq A , \: T \subseteq B , \: U \subseteq S\times T \} \ar{dl} \ar{dr} \ar{dd}{\mu_{ab}} \\
	\{ S \subseteq A \} \ar{dd}{\mu_a} & & \{ T \subseteq B \} \ar{dd}{\mu_b} \\
	& \{ (x,y,z) \in \mathbb{R}^3 \:\mid\: x,y\geq z \} \ar{dl} \ar{dr} \\
	\mathbb{R} & & \mathbb{R}
\end{tikzcd}\]
satisfying in addition monotonicity and the inclusion-exclusion and normalization equations. The commutativity of the diagram expresses the requirement that the first two components of $\mu_{ab}(S,T,U)$ must be equal to $\mu_a(S)$ and $\mu_b(T)$, respectively; in particular, if we replace $\mu_{ab}$ by its third component, we have the inequalities
\[
	\mu_{ab}(S,T,U) \leq \mu_a(S), \qquad \mu_{ab}(S,T,U) \leq \mu_b(T).
\]
So from now on, we will write $\mu_{ab}$ for only the third component, which is an external real number. By monotonicity of the valuation, it is enough to postulate these inequalities only in the special case $T = B$ and $U = S\times T$,
\begin{equation}
\label{marginaldomination}
	\mu_{ab}(S,B,S\times B) \leq \mu_a(S), \qquad \mu_{ab}(A,T,A\times T) \leq \mu_b(T),
\end{equation}
as long as each of $\mu_a$, $\mu_b$ and $\mu_{ab}$ is monotone (which is the case). Furthermore, we have normalization, which states $\mu_a(A) = \mu_b(B) = \mu_{ab}(A,B,A\times B) = 1$, and the inclusion-exclusion relation, which states the obvious for $\mu_a$ and $\mu_b$, as well as
\begin{equation}
\label{abinclexcl}
	\mu_{ab}(S_1\cap S_2,T_1\cap T_2,U_1\cap U_2) + \mu_{ab}(S_1\cup S_2,T_1\cup T_2,U_1\cup U_2) = \mu_{ab}(S_1,T_1,U_1) + \mu_{ab}(S_2,T_2,U_2).
\end{equation}
Moreover, we claim that together with normalization, this forces the inequalities~\eqref{marginaldomination} to be equalities. Indeed, we have as an instance of inclusion-exclusion,
\[
	\mu_{ab}(A\setminus S,B,(A\setminus S)\times B) + \mu_{ab}(S,B,S\times B) = \mu_{ab}(\emptyset,B,\emptyset) + \mu_{ab}(A,B,A\times B).
\]
The first term on the right-hand side vanishes since $0 \leq \mu_{ab}(\emptyset,B,\emptyset) \leq \mu_a(\emptyset) = 0$, while the second term is $1$ by normalization. With $A\setminus S$ in place of $S$, the first inequality~\eqref{marginaldomination} therefore gives
\[
	1 - \mu_{ab}(S,B,S\times B) \leq \mu_a(A\setminus S) = 1 - \mu_a(S).
\]
\todo[inline]{These seem to be correspond to the point-determination axiom, which therefore follows from normalization. Is this correct?}
Combining this with~\eqref{marginaldomination}, we conclude that the first inequality in~\eqref{marginaldomination} must hold with equality; the same reasoning applies to the second inequality. Therefore $\mu_a$ is already determined by $\mu_{ab}$, and so is $\mu_b$.

So overall, a normalized valuation on $(A,B)$ is the same thing as a map $(S,T,U)\longmapsto \mu_{ab}(S,T,U)$ with values in classical $[0,1]$ that satisfies monotonicity, inclusion-exclusion in the form~\eqref{abinclexcl}, and normalization $\mu_{ab}(A,B,A\times B) = 1$.

What is missing is to show that $\mu_{ab}(S,T,U) = \mu_{ab}(A,B,U)$ for all $S,T,U$, so that $\mu_{ab}$ depends only on $U\subseteq A\times B$, making it into a probability measure in the standard sense. Again by inclusion-exclusion and monotonicity, this equation is equivalent to $\mu_{ab}(A,B,\emptyset) = 0$. But this equation is also automatic thanks to inclusion-exclusion,
\[
	\mu_{ab}(A\cap \emptyset, \emptyset \cap B, \emptyset) + \mu_{ab}(A\cup \emptyset, \emptyset \cup B, \emptyset) = \mu_{ab}(A, \emptyset, \emptyset) + \mu_{ab}(\emptyset, B, \emptyset).
\]
We have already shown that both terms on the right-hand side must vanish, and the first term on the left vanishes trivially. Therefore $\mu_{ab}(A,B,\emptyset) = 0$, as was to be shown.
\end{proof}

What David sees as the most interesting part of the above proof is the last step, that $\mu_{ab}(S,T,U) = \mu_{ab}(A,B,U)$ for all $S,T,U$. Here's how that looks logically.

Recall that $\See{[0,n]}P\coloneqq(t\apart [n,0])\vee P$, where $t\apart[a,b]$ means $(b+1\leq t)\vee(t\leq a-1)$. So $\See{[0,n]}P=(1\leq t)\vee(t\leq n-1)\vee P$. Recall also that $\mu(P)$ is formally a function on rationals, $\mu(P):\tQQ\to\Prop$; if $\mu(P)(q)$ holds, we think ``$q<\mu(P)$''. So for example, down-closure says $(q'<q\wedge\mu(P)(q))\imp\mu(P)(q')$. In $\tRR_{\SeeInline{[0,n]}}$, the $\See{[d,u]}$-(nonnegative lower reals), $\See{[d,u]}\bot$ is the unit for addition.

\begin{theorem}\label{thm.logical_reformulation}
\[\See{[0,n]}\mu(P)=\See{[0,n]}\mu(\See{[0,n]}P).\]
\end{theorem}
\begin{proof}
We have $\mu(P)+\mu(\See{[0,n]}\bot)=\mu((\See{[0,n]}\bot)\wedge P)+\mu(\See{[0,n]} P)$. Since $\See{[0,n]}$ commutes with addition, it suffices to show $\See{[0,n]}\mu(\See{[0,n]}\bot)=\See{[0,n]}\mu((\See{[0,n]}\bot)\wedge P)$. But $\See{[0,n]}\bot\leq\See{[0,n]}\mu(\See{[0,n]}\bot\wedge P)\leq\See{[0,n]}\mu(\See{[0,n]}\bot)$, so it suffices to show that $\See{[0,n]}\mu(\See{[0,n]}\bot)\leq\See{[0,n]}\bot$. We also have
\[\mu(\See{[0,n]}\bot)+\mu(1\leq t\leq n-1)=\mu(1\leq t)+\mu(t\leq n-1),\]
so it suffices to show that $\See{[0,n]}\mu(1\leq t)\leq\See{[0,n]}\bot$ and $\See{[0,n]}\mu(t\leq n-1)\leq\See{[0,n]}\bot$. 

These are similar, so we show the first, and since $\See{[0,n]}$ is a modality, it suffices to show that $\mu(1\leq t)(q)\imp\See{[0,n]}\bot$ for any $q\in\QQ_{\geq0}$. So suppose $\mu(1\leq t)(q)$.

By an axiom of discrete temporal type theory (analogous to Axiom 3a in TTT), we have $\neg(t\leq 0)\imp (1\leq t)$ [and similarly $\neg(n\leq t)\imp(t\leq n-1)$]. Since $(1\leq t)\imp\See{[0,n]}\bot$, it suffices to show $\neg(t\leq 0)$, so assume $t\leq 0$. Then $\mu(1\leq t)=\mu(\bot)$, so $\mu(1\leq t)(q)=\mu(\bot)(q)=\bot$. This completes the proof.\end{proof}

\todo[inline]{Do we generally expect it to be the case that $\mu(P) = P$, or at least $\mu(P) \leq P$, for every proposition $P$? Because then we would get
\[
	\mu(1 \leq t) \leq \mu(\See{[0,n]} \bot) \leq \See{[0,n]} \bot,
\]
and therefore directly $\See{[0,n]} \mu(1 \leq t) \leq \See{[0,n]} \bot$, since applying $\See{[0,n]}$ to a lower real is the internal left adjoint to $\RR \rightarrow \RR_{\SeeInline{[0,n]}}$. (Right?) Or is this argument begging the question?}

\chapter{Domain-theoretic aspects of internal locales}

For now, this stuff is taking place in $\smset$.

Let $X$ be a topological space with poset of opens $\Op(X)$. Then for $U\subseteq V$ in $\Op(X)$, what does it mean for $U$ to be way below $V$? There is a nice way to relate it to the finite subcover definition of compactness:

\begin{lemma}
$U\ll V$ if and only if every open covering of $V$ has a finite subfamily which covers $U$.
\end{lemma}

\begin{proof}
If the condition holds, then every directed set of opens that goes below $V$ also covers $V$, and therefore contains an element that already contains $U$.

Conversely, given a covering family, consider the directed set of finite unions of members of the cover.
\end{proof}

Without additional separation assumptions on $X$, it seems tricky to translate this into a condition involving only the usual concepts of point-set topology. In order to do so, we need one more auxiliary statement.

\newcommand{\cl}[1]{\overline{#1}} % topological closure
\newcommand{\intr}[1]{\mathrm{int}(#1)} % interior

\begin{lemma}
Let $X$ be regular and $D\subseteq X$ dense. Suppose that every open cover of $X$ has a finite subfamily which covers $D$. Then $X$ is compact.
\end{lemma}

This may be somewhat surprising, since in many cases a finite subfamily which covers $D$ does not yet cover $X$.

\begin{proof}(Due to Ramiro de las Vegas, MO.)
Let $\mathcal{A}$ be an open cover of $X$. For every $x\in X$, choose $U_x\ni x$ such that $\cl{U_x}\subseteq V_x$ for suitable $V_x\in\mathcal{A}$. Then $\{U_x\}$ is another open covering which has a finite subcover $\{U_{x_1},\ldots,U_{x_n}\}$ by assumption. Since $X = \cl{U_{x_1}\cup\ldots\cup U_{x_n}} = \cl{U_{x_1}}\cup\ldots\cup\cl{U_{x_n}} \subseteq V_{x_1}\cup\ldots\cup V_{x_n}$, we are done.
\end{proof}

Now we can characterize the way below relation in a nice way:

\begin{lemma}
Let $X$ be regular. Then $U\ll V$ if and only if $U$ is relatively compact in $V$, i.e.~if $\cl{U}\cap V$ is compact.
\end{lemma}

\begin{proof}
If $\cl{U}\cap V$ is compact, then clearly the condition of the first lemma holds as well, and we do not need regularity.

Conversely, suppose that the condition of the first lemma holds. Then by the previous lemma, it is enough to show that every open cover of $\cl{U}\cap V$ has a finite subfamily which covers $U$. But this is clear by assumption: throwing in $V\setminus\cl{U}$ to an open cover of $\cl{U}\cap V$ gives an open cover of $V$.
\end{proof}

\chapter{Locales and geometric morphisms}

My question is: given a geometric morphism $f : \mathcal{T}\to\mathcal{T}'$, do internal frames in $\mathcal{T}'$ pull back to internal frames in $\mathcal{T}$?

Note that there is a natural comparison map between $f^*\Prop'$ and $\Prop$. Indeed, since $f^*$ preserves monos by virtue of being left exact, there is a map $\classify{f^*\const{true}'}\colon f^*\Prop'\to\Prop$ classifying the image under $f^*$ of $\const{true}'\colon 1'\to \Prop'$.

\begin{lemma}
If $s:A\to B$ is an arbitrary subobject in $\mathcal{T}'$, then $f^*s : f^*A\to f^*B$ is again a subobject, and $\classify{f^*s}$ is given by $f^*\classify{s}$ post-composed with the comparison map $f^*\Prop'\to\Prop$.
\end{lemma}

\begin{proof}
 This is because
\[\begin{tikzcd}
	f^*A \ar{r} \ar{d} & f^*B \ar{d} \\
	f^*1 \ar{r} & f^*\Prop'
\end{tikzcd}\]
is again a pullback diagram, and likewise is
\[\begin{tikzcd}
	f^*1 \ar{r} \ar{d} & f^*\Prop' \ar{d} \\
	1 \ar{r} & \Prop
\end{tikzcd}\]
so that the two pullbacks compose.
\end{proof}

In this reasoning, we have only needed to use that $f^*$ is left exact. Thus everything applies likewise to $f_*$, and we e.g.~have a comparison map $\classify{f_*\const{true}}\colon f_*\Prop\to\Prop'$. But this is of less interest to us here.

So given an internal poset $P$ in $\mathcal{T}'$, we get a poset structure on $f^*P$ given by the subobject $f^*(\leq) \to f^*P\times f^*P$. Again using the fact that $f^*$ preserves finite limits, it's straightforward to see that if $P$ is a meet-semilattice in $\mathcal{T}'$, then $f^*P$ is a meet-semilattice in $\mathcal{T}$. However, it's less clear if the existence of arbitrary joins is preserved in the same way.

The existence of arbitrary joins for $P = \mathcal{O}(X)$ means that the down-closure map
\[
	\mathcal{O}(X)\to\Prop'^{\mathcal{O}(X)},\qquad U\mapsto \classify{ \{ V \leq U \} }
\]
has an internal left adjoint. Here, $\Prop'^{\mathcal{O}(X)}$ carries the usual pointwise ordering, i.e.~the one corresponding to inclusion of subobjects. What we would like to have is that the down-closure map of $f^*\mathcal{O}(X)$ similarly has a left adjoint. According to the Elephant (p.~580), this is not the case in general! However for an \emph{atomic} geometric morphism---or in other words if $f^*$ is a logical functor---we can apply Corollary B2.3.10 to conclude that $f^*\mathcal{O}(X)$ is indeed an internal frame. Concretely, in this case the sup map is the composite $\Prop^{f^*(\mathcal{O}(X))}\cong f^*\left(\Prop'^{\mathcal{O}(X)}\right)\to f^*(\mathcal{O}(X))$, where the first morphism comes from $f^*$ being logical and the second one is $f^*(\sup)$.

In conclusion, internal frames can be pulled back along atomic geometric morphisms\footnote{And also along general geometric morphisms, but this requires a different construction, as in Elephant p.~580.}. Again by Elephant p.~580, pushing frames forward along $f_*$ is even simpler, and it seems plausible that this results in an adjunction $f^* \dashv f_*$ between frames in $\mathcal{T}$ and frames in $\mathcal{T}'$. I will be a bit sloppy for now and just assume that this is true.

The next question is whether $f^*$ preserves properties of locales such as regularity or local compactness. Both are concerned with relaxed notions of ordering:

\begin{definition}
For $U,V\in\mathcal{O}(X)$, one says that
\begin{enumerate}
\item $V$ is \emph{well inside} $U$, written $V\subset\subset U$, if there is $G\in\mathcal{O}(X)$ such that $V\cap G = \emptyset$ and $U\cup G = X$.
\item $V$ is \emph{way below} $U$, written $U\ll V$, if for every directed $D:\mathcal{O}(X)\to\Prop$, $U\leq\sup D$ implies that there is $W\in D$ with $V\leq W$.
\end{enumerate}
Then $X$ is regular (locally compact) if every $U$ is the sup of the $V$ that are well inside (way below) it.
\end{definition}

Since these definitions make sense constructively, we can apply them to internal locales.

So the well-inside relation corresponds to the subobject of $\mathcal{O}(X)\times\mathcal{O}(X)$ that is the projection of the subobject
\[
	\{ \: (V,G,U) \:|\: V\wedge G = \emptyset, \; U\vee G = X \: \} \quad \subseteq \quad \mathcal{O}(X)\times\mathcal{O}(X)\times\mathcal{O}(X)
\]
to the first and third factor, and this subobject itself is an equalizer. Since $f^*$ preserves monos and epis, it also preserves image factorizations and therefore pushforwards of subobjects, such as this pushforward along the product projection. Hence the well-inside relation on $f^*(\mathcal{O}(X))$ coincides with $f^*(\subset\subset)$.

Regularity means that upon exponentiating the first factor in $\classify{\subset\subset} : \mathcal{O}(X)\times\mathcal{O}(X)\to\Prop'$ to $\mathcal{O}(X)\to\Prop'^{\mathcal{O}(X)}$ and composing with $\sup$, one obtains $1_{\mathcal{O}(X)}$. Again since $f^*$ is logical and $f^*(\sup)$ is the sup map of $f^*(\mathcal{O}(X))$, we can conclude that $f^*(\mathcal{O}(X))$ is regular is well.

In order to make the same argument for local compactness, we show similarly that $f^*(\ll)$ is the way-below relation on $f^*(\mathcal{O}(X))$. By similar reasoning as for well-inside, we obtain that $\const{Drct}(f^*(\mathcal{O}(X))) = f^*(\const{Drct}(\mathcal{O}(X)))$.

\section{$f_*$ preserves internal locales and frames?}\label{sec.preserve_loc_frame}

\todo[inline]{Probably more correct discussion from the meeting:}

We want to understand why $f_*$ preserves internal locales---the proof in Johnstone is opaque---and similarly for internal frames. An internal poset $A$ has all sups if it is equipped with an adjunction
\[
\begin{tikzcd}
	A\ar[r, shift left, "\down"]&\Prop^A\ar[l, shift left, "\bigvee"]
\end{tikzcd}
\]
So suppose $A$ is an internal locale in $\cat{E}$ and that we have a geometric morphism $f_*\colon\cat{E}\to\cat{F}$. Applying our work above, we get an adjunction
\[
\begin{tikzcd}
	f_*A\ar[r, shift left, "f_*\down"]&f_*(\Prop^A)\ar[l, shift left, "f_*\bigvee"]
\end{tikzcd}
\]
in $\cat{F}$. We also have a map $e\colon f_*(\Prop^A)\to\Prop^{f_*A}$ given by $f_*$ of evaluation followed by the characteristic map for $f_*\true\colon 1\to f_*\Prop$. Thus it suffices to find a left adjoint for $e$.

We produced a candidate left adjoint $e'$ for $e$, but we did not prove it works. However, it seems to work when $f_*$ is a geometric inclusion, i.e.\ when $\cat{E}$ is the category of sheaves for some modality on $\cat{F}$. In that case, we think of $U\coloneqq f_*$ as the underlying presheaf map and $\asSh\coloneqq f^*$ as sheafification. The desired map $e'\colon\Sub_p(UA)\to U\Sub_s(A)$ sends a subpresheaf $X\ss UA$ to the sheaf-theoretic image of its adjunct $\asSh(X)\surj\bullet\inj A$. In other words, $e'$ takes a sub-presheaf to its sheaf-theoretic image; this construction should be left adjoint to $e$.

For an arbitrary $f$, we attempt to repeat this idea. To obtain a map $\Prop^{f_*A}\to f_*(\Prop^A)$, we need a map $A\times f^*(\Prop^{f_*A})\to\Prop$, i.e.\ a subobject of the domain. Form the following diagram, and take the subobject shown on the bottom row:
\[
\begin{tikzcd}
	&\bullet\ar[r]\ar[d, tail]\ar[dr, phantom, very near start, "\lrcorner"]\ar[dddl, two heads, bend right]&1\ar[d]\\
	&f^*(f_*A\times\Prop^{f_*A})\ar[r, "f_*(ev)"]\ar[d, "\cong"']&f^*\Prop\\
	&f^*f_*A\times f^*\Prop^{f_*A}\ar[d, "\epsilon"']\\
	\bullet\ar[r, tail]&A\times f^*\Prop^{f_*A}
\end{tikzcd}
\]
Note that in the subtopos case above, $f^*f_*A\to A$ is an iso, so there is no need for the epi-mono factorization.

We believe that direct image functors $f_*$ preserve the internal structures of DCPOs, complete sup-lattices, and frames. For example, rather than consider $\Prop^P$ we consider $\Idl(P)$ and try to lift the previously (semi-)defined adjunction, as shown:
\[
\begin{tikzcd}
	f_*(\Idl P)\ar[r, shift left, dotted]\ar[d, tail]&\Idl(f_*P)\ar[l, shift left, dotted]\ar[d, tail]\\
	f_*(\Prop^P)\ar[r, shift left]&\Prop^{f_*P}\ar[l, shift left]
\end{tikzcd}
\]


\printbibliography

\end{document}
