\documentclass[reqno,11pt]{amsproc}
\usepackage{amssymb}
\usepackage{amsmath}
\usepackage{amsfonts}
\usepackage{microtype}
\usepackage[canadian]{babel}
\usepackage{xcolor}
\usepackage{geometry}
\usepackage{tikz-cd}
\usepackage{enumitem}
\usepackage{hyphenat}
\usepackage{mathtools}	% provides \declarepaireddelimiter
\usepackage{bbm}
\usepackage{stmaryrd}
\usepackage{mathrsfs}  
\usepackage{accents}

%%%% draft stuff
\usepackage{todonotes}
\usepackage{showkeys}
\newcommand{\tob}[1]{\todo[color=blue!40,inline]{\tn{\textbf{T:} #1}}\noindent}
\newcommand{\dis}[1]{\todo[color=red!40,inline]{\tn{\textbf{D:} #1}}\noindent}

% color of links
\definecolor{myurlcolor}{rgb}{0,0,0.3}
\definecolor{mycitecolor}{rgb}{0,0.3,0}
\definecolor{myrefcolor}{rgb}{0.3,0,0}
\usepackage[pagebackref,draft=false]{hyperref}
\hypersetup{colorlinks,
linkcolor=myrefcolor,
citecolor=mycitecolor,
urlcolor=myurlcolor}
\renewcommand*{\backref}[1]{$\uparrow$\,#1}
\usepackage[capitalize]{cleveref}




\usetikzlibrary{
	cd,
	math,
	decorations.markings,
	positioning,
	arrows.meta,
	shapes,
	calc,
	fit,
	quotes,
	intersections}
\hypersetup{final}
\setlist{nosep}

\tikzset{
  tick/.style={postaction={
    decorate,
    decoration={markings, mark=at position 0.5 with {\draw[-] (0,.4ex) -- (0,-.4ex);}}}
  },
  tickx/.style={
    postaction={ decorate,
      decoration={markings,
        mark=at position 0.5 with {
          \fill circle [radius=.28ex];
        }
      }
    }
  }
}

% adjunction notation
\newcommand{\adj}[5][30pt]{%[size] Cat L, Left, Right, Cat R.
\begin{tikzcd}[ampersand replacement=\&, column sep=#1]
  #2\ar[r, shift left=5pt, "{#3}"]\ar[r, phantom, "\Rightarrow" yshift=-.4pt]\&
  #5\ar[l, shift left=5pt, "{#4}"]
\end{tikzcd}
}

\swapnumbers
\theoremstyle{plain}
\newtheorem{dummy}{Dummy}[section]
\newtheorem{theorem}{Theorem}[section]
\newtheorem{proposition}[theorem]{Proposition}
\newtheorem{corollary}[theorem]{Corollary}
\newtheorem{lemma}[theorem]{Lemma}
\newtheorem{conjecture}[theorem]{Conjecture}
\newtheorem{definition}[theorem]{Definition}
\newtheorem{notation}[theorem]{Notation}
\newtheorem{axiom}[theorem]{Axiom}\crefname{axiom}{Axiom}{Axioms}
\newtheorem{assumption}[theorem]{Assumption}
\newtheorem{question}[theorem]{Question}

\theoremstyle{definition}
\newtheorem{example}[theorem]{Example}
\newtheorem{remark}[theorem]{Remark}

% environment for soundness proofs
\newenvironment{soundproof}{\begin{proof}[soundness proof]}{\end{proof}}

% custom paired delimiter
\DeclarePairedDelimiter{\church}{\llbracket}{\rrbracket}
\DeclarePairedDelimiter{\classify}{\ulcorner}{\urcorner}
\DeclarePairedDelimiter{\floor}{\lfloor}{\rfloor}

% custom operators
\DeclareMathOperator{\id}{id}
\DeclareMathOperator{\mor}{mor}
\DeclareMathOperator*{\colim}{colim}
\DeclareMathOperator{\im}{im}
\DeclareMathOperator{\ob}{ob}
\DeclareMathOperator{\interior}{int}

\newcommand{\Const}[1]{\mathtt{#1}}
\newcommand{\set}[1]{\mathrm{#1}}
\newcommand{\cat}[1]{\mathsf{#1}}
\newcommand{\fun}[1]{\mathsf{#1}}
\newcommand{\sheaf}[1]{\fun{#1}}
\newcommand{\op}{^\mathrm{op}}

% categories
\newcommand{\Set}{\cat{Set}}
\newcommand{\Poset}{\cat{Poset}}
\newcommand{\Top}{\cat{Top}}

\newcommand{\tickar}{\begin{tikzcd}[baseline=-0.5ex,cramped,sep=small,ampersand replacement=\&]{}\ar[r,tick]\&{}\end{tikzcd}}
\newcommand{\xtickar}[1]{\stackrel{#1}{\tickar}}
\newcommand{\cocolon}{:\!}
\newcommand{\iso}{\cong}
\renewcommand{\to}[1][]{\xrightarrow{#1}}
\newcommand{\too}[1]{\xrightarrow{\;\;#1\;\;}}
\newcommand{\from}[1]{\xleftarrow{#1}}
\newcommand{\fromm}[1]{\xleftarrow{\;\;#1\;\;}}
\newcommand{\surj}{\twoheadrightarrow}
\newcommand{\inj}{\hookrightarrow}
\newcommand{\wavyto}{\rightsquigarrow}

\newcommand{\tn}[1]{\textnormal{#1}}
\newcommand{\ol}[1]{\overline{#1}}
\newcommand{\ul}[1]{\underline{#1}}
\newcommand{\wt}[1]{\widetilde{#1}}
\newcommand{\wh}[1]{\widehat{#1}}
\newcommand{\ubar}[1]{\underaccent{\bar}{#1}}
\newcommand{\subsing}[1]{\mathrm{subsing}(#1)}	% subsingleton predicate
\newcommand{\conn}[1]{\mathrm{conn}(#1)}	% connectedness predicate
\newcommand{\ind}[1]{1_{#1}}			% indicator function
\newcommand{\inc}{\ind{-}}			% inclusion of prop in lower reals

\newcommand{\internal}[1]{\raisebox{-.03ex}{$\mathbbmtt{#1}$}}


\newcommand{\ee}{\mathbb{E}} % expectation value
\newcommand{\ii}{\mathbb{II}} % interval domain
\newcommand{\ir}{\mathbb{IR}} % interval domain
\newcommand{\nn}{\mathbb{N}}
\newcommand{\qq}{\mathbb{Q}}
\newcommand{\rr}{\mathbb{R}}
\newcommand{\zz}{\mathbb{Z}}
\newcommand{\lr}{\ul{\mathbb{R}}}

\newcommand{\hs}{\hspace{1pt}}
\newcommand{\tnn}{\internal{N}\hs}
\newcommand{\tqq}{\internal{Q}\hs}
\newcommand{\tqqint}{\internal{Q}\hs_{[0,1)}}
\newcommand{\tqqp}{\tqq_{+}}
\newcommand{\tzz}{\internal{Z}\hs}
\newcommand{\tqqub}{\qq^\infty}
\newcommand{\trr}{\internal{R}}
\newcommand{\tii}{\ubar{\internal{I\hs\hs}}\!\hs}
\newcommand{\tlrr}{\ubar{\trr}\hs}

\newcommand{\cast}{\textit{cast}}
\newcommand{\germs}[2]{\mathsf{germs}_{#2}({#1})}
\newcommand{\vals}{\mathcal{V}}	% type of valuations

\newcommand{\trrat}[1]{\trr_{\seeinline{#1}}}

\newcommand{\pow}{\mathcal{P}}

\newcommand{\tconst}{\mathtt{C}}
\newcommand{\shfun}[1]{\mathrm{fn}(#1)}

\newcommand{\psh}{\cat{Psh}}
\newcommand{\shv}{\cat{Shv}}

\newcommand{\prop}{\Const{Prop}}
\newcommand{\pt}{x}
\newcommand{\cc}{\Const{cc}}
\newcommand{\unit}{\Const{1}}
\newcommand{\Op}[1][undef]{\ifthenelse{\equal{#1}{undef}}{\mathcal{O}}{\mathcal{O}(#1)}}
\newcommand{\sub}{\set{sub}}
\newcommand{\lsc}{\fun{lsc}}

\newcommand{\el}[1]{\tn{el}#1}
\newcommand{\assh}{\fun{Sh}} % sheafified object
\newcommand{\tosh}{\fun{sh}} % sheafification map from object to sheafified object

\newcommand{\cpct}[1]{\set{cpct}_{#1}}
\newcommand{\pointwise}{\mathrm{ptw}}		% subscript indicating ``pointwise''
\newcommand{\pts}{\mathtt{Pts}}		% internal type of points (for indexing the at-modalities)
\newcommand{\modts}{\mathtt{Mod}}		% internal type of modalities
\newcommand{\decmod}{\mathtt{DecMod}}	% internal type of decidable modalities
\newcommand{\ptmod}{\mathtt{PtMod}}	% internal type of decidable modalities
\newcommand{\bas}[1]{\wh{#1}}


\newcommand{\apart}{\,\#\,}
\newcommand{\rest}[2]{#1\big|\hspace{0in}_{#2}}
\newcommand{\restsm}[2]{#1|\hspace{0in}_{#2}}
\newcommand{\basetopos}{\cat{T}}
\newcommand{\basespace}{B}
\newcommand{\cb}{c\basespace}
\newcommand{\const}{\fun{const}}
\newcommand{\sky}{\fun{sky}}

\newcommand{\atsymbol}{{@}}
\newcommand{\at}[1][\pt]{\atsymbol_{#1}}
\newcommand{\atinline}[1]{@{#1}}
\newcommand{\seeinline}[1]{\seesymbol{#1}}
\newcommand{\ininline}[1]{\insymbol{#1}}


\newcommand{\sqss}{\sqsubseteq}
\newcommand{\specupclose}{{\uparrow}}
\newcommand{\specdownclose}{{\downarrow}}
\newcommand{\upclose}{{\rotatebox[origin=c]{90}{$\twoheadrightarrow$}}}
\newcommand{\downclose}{{\rotatebox[origin=c]{90}{$\twoheadleftarrow$}}}
\newcommand{\down}{\mathord{\downarrow}}
\newcommand{\up}{\mathord{\uparrow}}

\newcommand{\imp}{\Rightarrow}
\renewcommand{\iff}{\Leftrightarrow}
\newcommand{\bool}{\set{bool}}
\newcommand{\ev}{\fun{ev}}

% fix the usual spacing issues with \left and \right
\let\originalleft\left
\let\originalright\right
\renewcommand{\left}{\mathopen{}\mathclose\bgroup\originalleft}
\renewcommand{\right}{\aftergroup\egroup\originalright}

% numbered equations
\newcommand{\beq}{\begin{equation}}
\newcommand{\eeq}{\end{equation}}

% vertical spacing in multiline equations
\setlength{\jot}{6pt}

% enumerate and itemize
\usepackage{enumitem}
\setlist[enumerate]{label=(\alph*),itemsep=5pt,topsep=8pt}
\setlist[itemize]{label=$\triangleright$,itemsep=5pt,topsep=6pt}
\renewcommand{\labelenumi}{(\alph{enumi})}
\renewcommand{\theenumi}{(\alph{enumi})}
\Crefformat{enumi}{#2#1#3}

% roman numerals for parts and large font for heading
\usepackage[explicit]{titlesec}
\renewcommand{\thepart}{\Roman{part}}
\titleformat{\part}[block]{\bfseries\huge\filcenter}{\underline{Part \thepart{}} \\[5pt]}{0pt}{#1}
\titlespacing{\part}{0pt}{0pt}{3pc}
\titleformat{\section}[block]{\bfseries\large\filcenter}{\thesection.}{6pt}{#1}
\titlespacing{\section}{0pt}{18pt}{12pt}
\titleformat{\subsection}[runin]{\bfseries}{\noindent}{0.4em}{#1.}

% table of contents entries style
\usepackage{titletoc}
\titlecontents{part}[0em]
	{\vspace{1pc}}
        {\bfseries\normalsize\contentslabel[\thecontentslabel]{2em}}
	{\bfseries\underline}
	{}
\titlecontents{section}[2em]
	{\vspace{0pt}}
        {\normalfont\normalsize\contentslabel[\thecontentslabel]{2em}}
	{}
	{\titlerule*[.75em]{}\contentspage}

% numbering depth
\numberwithin{equation}{section}
\setcounter{tocdepth}{1}
\setcounter{secnumdepth}{1}

\title{Stochastic Processes as Internal Probability Valuations}
\author{Tobias Fritz and David I.\ Spivak}

\begin{document}

\begin{abstract}
	topos
\end{abstract}

\maketitle

\tableofcontents

\newpage

\section{Introduction}

\tob{mention Lawvere's work on toposes of laws of motion, which also formalize dynamical systems?}

\tob{check out \href{http://tesi.cab.unipd.it/64414/1/tesi\_\_CapucciDef.pdf}{http://tesi.cab.unipd.it/64414/1/tesi\_\_CapucciDef.pdf} in more detail}

Entities we observe---either casually or as scientists---exhibit time-varying behavior that we may wish to model. We may be able to monitor the entity with respect to a collection of variables whose values change as the entity performs various actions. The variables we monitor for a weather system are quite different than those we monitor for a mouse, but in each case we notice that the variables take on certain characteristic patterns as they change through time. The better we can understand and model the entity's behavior patterns, the better we are able to predict and have some degree of control when we interact with the entity.

The characteristic patterns of an entity can be formalized using a stochastic process \cite{doob1934stochastic}. For example Brownian motion as developed by Albert Einstein to model the random movement of pollen particles in water \cite{einstein1956investigations}, was later formalized by Norbert Weiner as a stochastic process. Given a measurable space $S$ (the \emph{state space}) and a set $T$ (the \emph{time line}), a stochastic process can be defined as a probability distribution $p$ on $S^T$, the measurable space of functions $s\colon T\to S$. Each such $s$ is a behavior, and the stochastic process tells us the probability that any given measurable set of behaviors will occur.

A version of the Kolmogorov extension theorem (KET) roughly says that we can reconstruct such a stochastic process $p$ from its finite marginals. That is, for each finite subset $F\subseteq T$ there is a measurable function $\pi^{T\from F}\colon S^T\to S^F$, and we can push forward $p$ to a probability measure $\pi^{T\from F}_*(p)$ on $S^F$. Given $F'\subseteq F$, we of course have compatibility $\pi^{T\from F'}_*(p)=\pi^{T\from F}_*\circ\pi^{F\from F'}_*(p)$. The KET says that if we instead have a compatible family of probability measures $p_F$ on $S^F$ for all finite $F\subseteq T$, then there is a unique probability measure $p$ on $S^T$ such that $p_F=\pi^{T\from F}_*(p)$. Here is a more category-theoretic version.

\begin{theorem}[Kolmogorov extension theorem]
The functor of Radon measures on a suitable category of spaces (completely regular Hausdorff) commutes with cofiltered limits.
\end{theorem}
\begin{proof}
\cite[Theorem 2.5]{danos2015dirichlet}
\tob{this should go back much further to Schwartz's book}
\end{proof}



The authors were led to this subject by considering the same guiding question---that of understanding characteristic patterns of behavior---within a different mathematical model. In particular, \emph{temporal type theory} \cite{schultz2019temporal} studies various types of behavior category theoretically, using sheaves on a space of time intervals. Such sheaves form a topos $\cat{B}$ and one can use the internal language of the topos to make statements, written in a logical style, about how various entities will behave. We were interested in the question of whether probabilistic statements could also be made within that internal language. In particular, we asked the question: do internal valuations on $\cat{B}$ coincide with stochastic processes?

In attempting to answer that question, we found it helpful to generalize the statement, in particular the spaces on which it holds. 


\subsection{Relation to existing work}

\dis{In Bas Spitters' paper, but also in Topos quantum theory and AQFT, there is a common idea. Roughly speaking, one looks within a complicated space and finds those contexts at which things simplify. Then one makes those contexts the \emph{points} of a new space, and topologizes around them so that the poset of contexts becomes the specialization order on points (or its opposite). Now, all geometric implications can be checked pointwise, meaning at precisely those contexts where things simplify. This allows one to actually get to work, but without being reductionist. In our case, the ``contexts at which things simplify'' are taken to be the compacts, but that's perhaps not essential.}

It is known that (continuous) valuations form a construction in geometric logic~\cite[Proposition~5]{vickers_integrals}. This implies that they behave well with respect to pullback along geometric morphisms. In terms of \cref{main_external}, this means that every internal valuation defines a family of external valuations $(\mu_\pt)_{\pt \in \pts}$, and it may (or may not) be possible to argue from geometricity alone that these satisfy the compatibility and lower semicontinuity conditions of \cref{main_external}. However, as far as we know, currently available methods in geometric logic do not give us a purely abstract way of getting from the family $(\mu_\pt)_{\pt \in \pts}$ to the internal valuation $\mu$~\cite[Section~5]{vickers_geometric_logic}.

\tob{still make use of the fact that geometric formulas (with external infinities only!) can be checked pointwise}

\subsection{Plan of the paper}

In \cref{chap.background}

\subsection{Notation}

We try to consistently use different kinds of font for different purposes:

\begin{itemize}
	\item We use \texttt{\textbackslash{}mathtt} font to denote fixed ``structure'' objects in a topos, such as the subobject classifier $\prop$.
	\item We use \texttt{\textbackslash{}mathsf} font to denote categories, such as the category of sheaves $\shv(T)$ on a topological space $T$.
\end{itemize}

\subsection{Acknowledgements}

David Spivak acknowledges the support from Honeywell and from AFOSR grants FA9550-17-1-0058 and FA9550-19-1-0113.

We thank Bas Spitters for pointing out the relevance of geometric logic to us. 
We also benefited very much from conversations with Nelson Niu; in particular he developed an early form of \cref{vals_vs_modalities}.




\part{Constructive theory of valuations and modalities}

In this part, we develop aspects of the theory of (continuous) valuations constructively.
While the first two sections serve as an introduction to the existing constructive theory of valuations as developed by Vickers~\cite{vickers_integrals,vickers_valuation_locales} as well as by Coquand and Spitters~\cite{coquandspitters2009integrals}.
The latter two sections then develop aspects of the interaction of valuations with modalities, which as far as we know is new. The central results here are \Cref{vals_vs_modalities}, a criterion for when a valuation commutes with a decidable modality, and \Cref{main_internal}, stating that 

We assume familiarity with constructive reasoning, modalities, geometric formulas as well as with the systems of point modalities from \Cref{axioms_soundness}.

\section{Background on modalities}

\subsection{Modalities}

Modalities operate on propositions to give new propositions that hold more generally. More precisely, we have the following definition. 

\begin{definition}[Modality]
	\label{def.modality}
	A \emph{modality} is a map $j \colon \prop \to \prop$ satisfying the following three axioms for all $P,Q \in \prop$:
	\begin{enumerate}
		\item $P\imp jP$.
		\item $jjP \imp jP$.
  		\item If $P \imp Q$, then also $jP \imp jQ$.
	\end{enumerate}
\end{definition}

In other words, a modality is a closure operator on truth values. Note that the first condition alone is equivalent to $j\top = \top$. For if this holds, and $P$ holds, then we can conclude $jP$ from $jP = j\top = \top$.

A modality automatically satisfies the following additional properties for all $P,Q \in \prop$,
\begin{enumerate}
	\setcounter{enumi}{3}	% somehow using [resume] results in a label off by 1
	\item\label{j_useful} If $jP$ and $P\imp jQ$, then also $jQ$.
	\item If $j(P\imp Q)$ and $jP$, then also $jQ$.
	\item If $jP$ and $jQ$, then also $j(P\wedge Q)$.
\end{enumerate}
See e.g.~\cite[Lemma~4.6]{schultz2019temporal} for the proof. Property \ref{j_useful} will turn out to be especially useful in our proofs: when proving a statement of the form $jQ$, it lets us strengthen an assumption of the form $jP$ to assuming $P$.

It turns out that modalities in the internal logic of a topos correspond one-to-one with its subtoposes, although we will not need that here.

We now give three concrete examples of modalities, called \emph{open}, \emph{closed}, and \emph{quasi-closed}, associated to truth values $U \in \prop$. The quasi-closed ones will be the most central ones to us.

\begin{definition}
	\label{open_closed_qc}
	Let $U \in \prop$ be a truth value. We have the following modalities, defined in terms of $U$:
	\begin{itemize}
		\item Open:
			\[
				jP \, \coloneqq \, (U \imp P).
			\]
		\item Closed:
			\[
				jP \, \coloneqq \, U \lor p.
			\]
		\item Quasi-closed:
			\[
				jP \, \coloneqq \left( (P \imp U) \imp U \right).
			\]
	\end{itemize}
\end{definition}

We leave it to the reader to verify that these maps are indeed modalities.

A truth value $P$ is \emph{$j$-closed} if $jP = P$. We denote the set of $j$-closed truth values by $\prop_j$. This extends to predicates pointwise as follows.

\begin{definition}[$j$ acting on predicates]\label{def.j_closed_props}
	Let $X$ be a set and $P \colon X \to \prop$ a predicate.
	\begin{enumerate}
		\item We write $jP$ for the predicate $X \to \prop$ given by
			\[
				(jP)(x) \coloneqq jP(x).	
			\]
		\item $P$ is \emph{$j$-closed} if $P = jP$. 
	\end{enumerate}
\end{definition}

Clearly $jP$ is the smallest $j$-closed predicate satisfying $P \imp jP$. Note also that the set of $j$-closed predicates on $X$ is $\prop_j^X$.

Upon identifying predicates on $X$ with subsets of $X$, we also obtain an action of $j$ on subsets $S \subseteq X$. In terms of set comprehension notation, this can be written as
\[
	jS = \{ x \in X \mid j(x \in S) \}.
\]

A set $X$ is canonically isomorphic to the set of predicates $P \colon X \to \prop$ which are \emph{singleton}, by which they mean that they satisfy
\[
	\exists x \in X \, . \, \forall x' \in X \, . \, P(x') \Leftrightarrow (x' = x).
\]
The following definition is based on localizing this definition with respect to $j$.

\begin{definition}
	For a set $X$, the \emph{$j$-sheafification} $jX$ is the set of predicates $P \colon X \to \prop_j$ satisfying 
	\beq
		\label{j_singleton}
		j \, \exists x \in X \, . \, \forall x' \in X \, . \, P(x) \Leftrightarrow j(x' = x).
	\eeq
\end{definition}

There is a canonical map
\[
	X \longrightarrow jX, \qquad x \longmapsto j(x = \_).
\]
We say that $X$ is a \emph{$j$-sheaf} if this map is an isomorphism. The $j$-sheaves form a subtopos, and in particular a reflective subcategory. Hence $j$ acts functorially on sets, and the canonical maps $X \to jX$ make up the unit of this reflector.

As we show now, the $j$-sheafification of $\prop$ is exactly the set of $j$-closed truth values.

\begin{lemma}
	The map
	\[
		\prop_j \longrightarrow j \prop, \qquad P \longmapsto j(P = \_)
	\]
	is injective.
\end{lemma}

\tob{Not sure if this statement has any significance at all. Surjectivity apparently not provable, and probably semantically false}

Note that this map is exactly the composite of the inclusion $\prop_j \hookrightarrow \prop$ with the above unit component $\prop \to j\prop$.

\begin{proof}
	Suppose that $P_1, P_2 \in \prop$ are such that
	\[
		j(P_1 = Q) \quad \Leftrightarrow \quad j(P_2 = Q)
	\]
	for all $Q \in \prop$. Then in particular $j(P_1 = P_2)$ holds. But this implies $jP_1 \imp jP_2$, or equivalently $P_1 \imp P_2$ by the assumed $j$-closedness. But then $P_2 \imp P_2$ follows analogously, and we can conclude $P_1 = P_2$ by propositional extensionality.
\end{proof}

\subsection{Decidable modalities}


A truth value $P \in \prop$ is decidable if it is true or false,
\[
	P \, \lor (P \imp \bot).
\]
The axiom of excluded middle holds if and only if every truth value is decidable.

\begin{definition}
	\label{def.decidable_modality}
	A modality $j$ is \emph{decidable} if 
	\[
		jP \, \lor \, (P\imp j\bot)
	\]
	for all $P \in \prop$. We write $\decmod$ for the set of decidable modalities.
\end{definition}

We now make a few elementary but useful observation on decidable modalities.

\begin{lemma}[Decidable modalities commute with $\lor$]
	\label{prop.dec_mod_or}
	Suppose $j$ is decidable. Then for all $P,Q:\prop$ we have
	\[
		j (P \lor Q) = j P \lor j Q.
	\]
\end{lemma}

\begin{proof}
	The direction $(j P \lor j Q)\imp j (P \lor Q)$ is obvious. For the converse, assume $j (P \lor Q)$. By decidability we may assume $P\imp j \bot$ and $Q\imp j \bot$. But then we get $j \bot$, which in particular proves $j P$.
\end{proof}

\begin{lemma}[$j \bot$ is prime for decidable $j$]
Suppose $j$ is decidable. Then for all $P,Q:\prop$, we have
\[\big((P\wedge Q)\imp j \bot\big)\imp\big((P\imp j \bot)\lor(Q\imp j \bot)\big)\]
\end{lemma}

\begin{proof}
Assume $(P\wedge Q)\imp j \bot$. By decidability we may assume also that $j P$ and $j Q$, since otherwise the consequent already holds. But then also $j (P\wedge Q)$, and finally $j \bot$ upon using the assumption.
\end{proof}

We now show that if $j$ is a decidable modality, then the values $jP$ as $P \in \prop$ are already determined by $j\bot$ alone.

\begin{lemma}[Decidable $j$ is quasi-closed]
	Suppose $j$ is decidable. Then for all $P:\prop$ we have
	\[
		j P=\big((P\imp j\bot)\imp j\bot\big).
	\]
\end{lemma}

\begin{proof}
	The forward direction $\Rightarrow$ holds for any modality, and the backward direction $\Leftarrow$ follows directly from decidability.
\end{proof}

We now turn to the $j$-local existential quantifier.

\begin{lemma}
	Let $j$ be a decidable modality, $X$ any set, and $P : X \to \prop$ a predicate. Then
	\[
		j \exists (x : X) . P(x) \quad \Longleftrightarrow \quad \left( \forall (x : X). (P(x) \imp j \bot) \right) \imp j \bot.
	\]
\end{lemma}

\begin{proof}
	From left to right, we can assume $j \left( \exists x. P(x)\right)$ and $\forall x. P(x) \imp j\bot$ to prove $j\bot$. Since the goal is $j$-closed, we can strengthen the first assumption to $\exists x. P(x)$. Choosing $x$ with $P(x)$ and applying $P(x) \imp j\bot$ therefore results in $j\bot$. In particular, this implication holds regardless of whether $j$ is decidable.

	From right to left, suppose by $j$-decidability that $\left( \exists x. P(x) \right) \imp j\bot$. Therefore $\forall x. (P(x) \imp j\bot)$. Plugging this into the assumption on the right shows $j\bot$, which is enough.
\end{proof}

\subsection{Countably coherent modalities}

Throughout the paper, we will work with decidable modalities which satisfy an additional condition closely related to coherent and geometric logic.

\begin{definition}
	\label{countably_coherent}
	A modality $j$ is \emph{countably coherent} if for all predicates $P : \tnn \to \prop$,
	\[
		j \exists n \in \tnn . P(n) \quad \Longrightarrow \quad \exists n \in \tnn . jP(n).
	\]
\end{definition}

Note that the converse implication from right to left holds for every modality $j$. Thus a countably coherent modality is one for which preserves countable existential quantification, or equivalently is such that the existential quantification of a $j$-closed predicate on $\tnn$ is again $j$-closed. It is easy to see that a countably coherent modality in particular must commute with $\lor$ by taking $P(n) \coloneqq \bot$ for all $n \ge 2$.

Our application of countable coherence will use the commutation of $j$ and $\exists$ for predicates on $\tqq$, for which it holds likewise since $\tnn$ and $\tqq$ are in canonical bijection.

\subsection{Systems of point modalities}
\label{axioms_soundness}

We use the term \emph{point modality} to refer to a decidable and countably coherent modality, and write $\ptmod$ for the set of point modalities. 
In this subsection, we introduce \emph{systems of point modalities}, which are collections of decidable and countably coherent modalities which express the idea that a given topos has enough points internally.

\begin{definition}
	\label{system_defn}
	A \emph{system of point modalities} consists of a set $\pts$ together with a map
	\[
		\at[] \colon \pts \to \ptmod		
	\]
	such that for all for all $P \in \prop$,
	\beq
		\label{enough_pts}
		\left( \forall \pt \in \pts . \at P \right) \: \Rightarrow \: P.
	\eeq
\end{definition}

Note that again the converse implication of \eqref{enough_pts} is immediate, so that we actually have a logical equivalence between $P$ and $\forall \pt . \at P$. The idea of the definition is that $\pts$ is an object which (internally) indexes points, and for every $\pt \in \pts$, the modality $\at : \prop \to \prop$ maps a given truth value to its value at $\pt$. Condition~\eqref{enough_pts} then can be interpreted as saying that there are enough points.
However, we will discuss the primary intended semantics of systems of point modalities at a technical level only in \Cref{points_semantics}.

While a setup like this is conceptually reminiscent of Garner's \emph{ionads}~\cite{garner2012ionads}, we currently do not know what the technical relation is, but note that the recent results of Di Liberti~\cite{diliberti2020topology} may possibly shed some light on this.

\section{Background on lower reals}

We spell out some additional more specific background in this section and the following section.

\subsection{Definition and basic properties}

The number system in which valuations land is the lower reals. We therefore introduce them here and discuss their relevant properties. For the following considerations, recall first that the rationals $\tqq$ form a number system with decidable equality and decidable ordering, so that we can work with $\tqq$ just as we do in classical mathematics.

\begin{definition}[Lower reals]\label{def.lower_nn_reals}
A \emph{lower real} is a function $r\colon\tqq\to\prop$ satisfying the following axioms:%
\begin{itemize}
	\item Inhabited: there is $q:\tqq$ such that $r(q)$.
	\item Down-closed: if $q_1,q_2:\tqq$ are such that $r(q_1)$ and $q_1 > q_2$, then also $r(q_2)$.
	\item Rounded: if $q_1 \in \tqq$ is such that $r(q_1)$, then there is $q_2 \in \tqq$ with $q_2 > q_1$ and $r(q_2)$.
\end{itemize}
Accordingly, the set of lower reals, denoted $\tlrr$, is
\[
	\tlrr\coloneqq\{r_>\colon\tqq\to\prop\mid r \textrm{ is down-closed and rounded}\}.
\]
\end{definition}

The value $r(q)$ is to be thought of as synonymous with $r > q$.
Correspondingly, we often abuse notation and write $r > q$ or $q < r$ to mean the proposition $r(q)$. Note that $\infty$ is a lower real, defined as $\infty(q) \coloneqq \top$ for all $q$.

For example, every rational $p \in \tqq$ itself defines a lower real, with
\[
	p(q) \:\::\iff\:\: p > q,
\]
where $>$ now denotes the usual ordering on $\tqq$. Leaving type casting implicit, we therefore have both $p : \tqq$ and $p : \tlrr$, resulting in the canonical inclusion $\tqq \subseteq \tlrr$.

We now want to define order and some algebraic structure on $\tlrr$, as well as the inclusion of rational numbers and propositions as special lower nonnegative reals.

\begin{definition}[Order on lower reals]
Given lower reals $r_1,r_2$,
we write $r_1 \ge r_2$ as shorthand for the following proposition,
\begin{equation}\label{eqn.real_order}
	r_1 \ge r_2 \:\:\coloneqq\:\: \forall q:\tqq \, . \, r_2 > q \imp r_1 > q.
\end{equation}
We also write $r_2 \le r_1$ as synonymous with $r_1 \ge r_2$.
\end{definition}

It is straightforward to show that $\ge$ is indeed a partial order relation on $\tlrr$, and that it extends the usual order on $\tqq \subseteq \tlrr$. We consider $\tlrr$ as a partially ordered set from now on, noting that totality of this partial ordering is not provable constructively.

\begin{definition}[Addition of lower reals]\label{def.sum_lr}
Let $r_1,r_2:\tlrr$ be lower reals. Define their \emph{sum} $r_1 + r_2 : \tqq\to\prop$ to be the lower real with
\begin{equation}\label{eqn.sum_lr}
r_1+r_2 > q \:\::\iff\:\: \exists (q_1,q_2:\tqq) \,.\, (r_1>q_1)\wedge (r_2> q_2)\wedge (q=q_1+q_2).
\end{equation}
\end{definition}

We leave it to the reader to verify that $r_1 + r_2$ indeed is a lower real, that this definition extends the usual addition of rational numbers, and that it makes $\tlrr$ into a partially ordered commutative monoid.

\begin{remark}
	\label{rational_ineq_move}
	For $p,q : \tqq$ and $r : \tlrr$, we have $p + r > q$ iff $r > q - p$, where $p + r$ denotes addition of lower reals.
\end{remark}

\begin{definition}[Pairwise minima, arbitrary suprema]\label{def.min_sup}
Let $r_1,r_2:\tlrr$. We define their \emph{minimum} $\min(r_1,r_2)$ by
\[
	\min(r_1, r_2) > q \:\::\iff\:\: r_1 > q \,\wedge\, r_2 > q.
\]
Let $S \subseteq \tlrr$ be a subset of lower reals.
Its \emph{supremum} $\sup S$ is the lower real defined  by 
\[
	\sup S > q \:\::\iff\:\: \exists r : S \,.\, r > q.
\]
\end{definition}

In other words, binary minima and arbitrary suprema of lower reals can be computed pointwise in $q$. We again leave it to the reader to verify that these prescriptions indeed define lower reals. It is then obvious that these lower reals are, as our terminology suggests, the binary meets (greatest lower bounds) and arbitrary joins (least upper bounds) in $\tlrr$ as a partially ordered set. In other words, we have identified $\tlrr$ with a subframe of $\prop^{\tqq}$.

Our next goal is to prove that addition is not only monotone, but conversely that bounded lower reals can also be subtracted from inequalities (\Cref{cancellative_bounds}). This uses a sequence of arguments communicated to us by Simon Henry~\cite{henry2012simplification}.

\begin{lemma}
	\label{cancel_rationals}
	For all $q:\tqq$ and $r_1,r_2:\tlrr$, if $p + r_1\le p + r_2$ then $r_1 \le r_2$.
\end{lemma}

\begin{proof}
	Suppose $q < r_1$. Then also $p + q < p + r_1$ by \Cref{rational_ineq_move}, and therefore $p + q < p + r_2$ by assumption and transitivity of order. But then we get the desired $q < r_2$, again from \Cref{rational_ineq_move}.
\end{proof}

For any proposition $P : \prop$, we have the \emph{indicator lower real} $\ind{P}$ defined by
\beq
	\label{indicator_lower_real}
	q < 1_P \:\::\iff\:\: (q < 0) \lor (P \land (q < 1)).
\eeq
The assignment $P \mapsto \ind{P}$ defines an order embedding $\prop \hookrightarrow \tlrr$ with $\ind{\bot} = 0$ and $\ind{\top} = 1$.

\begin{lemma}\label{order_cancel_props}
For any $P:\prop$ and $r_1,r_2:\tlrr$, if $\ind{P}+r_1\le \ind{P}+r_2$ then $r_1\le r_2$.
\end{lemma}

\begin{proof}
Suppose $q < r_1$. Then trivially $q < \ind{P} + r_1$, so by assumption $q_1<\ind{P}+r_2$. By \cref{def.sum_lr}, this means that there exist $q_1 < \ind{P}$ and $q_2 < r_2$ with $q = q_1 + q_2$.

Now $q_1 < \ind{P}$ gives us two cases: $q_1 < 0$ or $P \land (q_1 < 1)$. If $q_1 < 0$, then $q = q_1 + q_2 < q_2 < r_2$, as desired. If $P \land (q_1 < 1)$ instead, then we have in particular $1_P = 1$, and therefore the claim follows by \Cref{cancel_rationals}.
\end{proof}

Following Henry, we show next that the order cancellative lower reals are dense.

\begin{lemma}[\cite{henry2012simplification}]
\label{cancellative_bounds}
	Let $r:\tlrr$ be bounded by some $N:\tnn$, i.e. $r<N$. For any $n:\tnn$ with $n\ge 1$, there exists $r_n:\tlrr$ satisfying the following:
	\begin{enumerate}
		\item $r_n\le r\le r_n + \frac{1}{n}$.
		\item For any $a,b:\tlrr$, if $r_n+a\le r_n+b$ then $a\le b$.
	\end{enumerate}
\end{lemma}

\begin{proof}
	Since multiplying by $n$ implements an automorphism of $\tlrr$ as a partially ordered commutative monoid, it is enough to consider the case $n = 1$ without loss of generality.

	Then define $r_n:\tlrr$ to be the following linear combination of indicator lower reals,
	\begin{equation}
		\label{eqn.cancellative_bounds}
		r_1 \coloneqq \sum_{i=1}^{N} \ind{i < r}.
	\end{equation}
	For the claim that $r_1\le r$, take $q < r_1$; we will show $q < r$. By \cref{def.sum_lr}, we have $q = q_1 + \ldots + q_N$ with $q_i < 0$ or $(i < r) \land (q_i < 1)$ for each $i$. But then also
	\[
		q = q_1 + \ldots + q_N < \#\{ i \le N \mid i < r \} \le r,
	\]
	as was to be shown.

	For the claim that $r\le r_1+1$, take likewise $q<r$; we will show $q < r_1 + 1$. Let $k \coloneqq \floor{q}$.  Then $q < k + 1$ and it suffices to show that $k \le r_1 = \sum_{i=1}^{N} \ind{i < r}$. Since $q < r$ we have $i < r$, and hence $\ind{i < r} = 1$, for all integers $1\le i\le k$. This gives $n\le r_1$, as desired

	Finally, suppose $r_1 + a \le r_1 + b$. Then the desired $a \le b$ follows by induction on $N$ using \cref{order_cancel_props} that $a\le b$, as desired.
\end{proof}

\begin{proposition}[Order cancellativity, \cite{henry2012simplification}]\label{cor.order_cancel}
	Suppose $r,s_1,s_2:\tlrr$ are lower reals, and that $r<N$ for some $N:\tnn$. Then
	\[
		s_1 + r \le s_2 + r \quad \Longrightarrow \quad s_1 \le s_2.
	\]
\end{proposition}

\begin{proof}
	Assuming $s_1 + r \le s_2 + r$, to conclude $s_1 \le s_2$ we take rational $q < s_1$ and wish to prove $q < s_2$. By roundedness, we can find $n \in \tnn$ such that even
	\[
		q + \frac{1}{n} < s_1.
	\]
	Now let $r_n$ be as in \eqref{eqn.cancellative_bounds}, which in particular results in
	\[
		s_1 + r_n \le s + r \le s_2 + r \le s_2 + \frac{1}{n} + r_n,
	\]
	so that we can conclude $s_1 \le s_2 + \frac{1}{n}$ by \Cref{cancellative_bounds}. But then
	\[
		q + \frac{1}{n} < s_1 \le s_2 + \frac{1}{n},
	\]
	and the claim $q < s_2$ follows upon cancelling $\frac{1}{n}$ from both sides.
\end{proof}

\begin{corollary}\label{cor.favorite}
	Suppose that $r_1,r_2,s_1,s_2:\tlrr$ are such that $r_1 + r_2 = s_1 + s_2$ and $r_1, r_2 \le N$ for some natural $N$. Then
	\[
		r_1\le s_1, \quad r_2\le s_2 \quad \Longrightarrow \quad r_1 = s_1, \quad r_2 = s_2.
	\]
\end{corollary}

\begin{proof}
	If $r_1 \le s_1$, then $r_1 + s_2 \le s_1 + s_2 = r_1 + r_2$, so $s_2 \le r_2$ by \cref{cor.order_cancel} and $r_1 \le N$. The second assumption $r_2 \le s_2$ then implies $r_2 = s_2$. Similarly we find $r_1 = s_1$.
\end{proof}

\subsection{Interaction with modalities}

We now investigate the interaction between lower reals and modalities, also referring to~\cite[Section~4.3]{schultz2019temporal} for related considerations. Throughout this subsection, $j$ is a modality.

\begin{definition}
	A lower real $r \in \tlrr$ is \emph{$j$-closed} if it is $j$-closed as a predicate $\tqq \to \prop$, meaning that if
	\[
		\forall q \in \tqq \, . \, j(q < r) \imp (q < r).
	\]
\end{definition}

\begin{lemma}
	Suppose that $j$ is countably coherent. For $r \in \tlrr$, the predicate $jr$ is a $j$-closed lower real with
	\[
		q < jr \quad \Longleftrightarrow \quad j(q < r),
	\]
	and it is the smallest $j$-closed lower real with $r \le jr$.
\end{lemma}

\begin{proof}
	The only nontrivial part is to show that $jr$ is indeed a lower real. The inhabitedness is obvious. For down-closure, suppose that $q_1 < q_2 < jr$, where the second inequality by definition means $j(q_2 < r)$. But since $r$ itself is down-closed, we also have
	\[
		j(q_2 < r) \: \imp \: j(q_1 < r),
	\]
	and therefore the desired $j(q_1 < r)$.

	Roundedness is where countable coherence comes in. Indeed the assumption $j(q_1 < r)$ lets us prove that there $j$-locally exists $q_2 \in \tqq$ with $q_2 > q_1$ and $q_2 < r$. But then by the commutation of $j$ and existential quantification, as well as the commutation with and, we obtain $q_2 \in \tqq$ such that $j(q_2 > q_1)$ and $j(q_2 < r)$. Now we are done if $q_2 > q_1$; while if $q_2 \le q_1$, then together with $j(q_2 > q_1)$ we conclude $j\bot$, and therefore again $j(q_2 < r)$.
\end{proof}

Thus for countably coherent $j$, we also consider $j$ as a map $j \colon \tlrr \to \tlrr$, which is is a closure operator on $\tlrr$ as a partially ordered set. Correspondingly, we also say that $r \in \tlrr$ is \emph{$j$-closed} if $jr = r$, which is equivalent to $r$ being $j$-closed as a predicate on $\tqq$.

\begin{lemma}
	\label{commute_exists_commute_addition}
	Suppose that $j$ is countably coherent. Then $j$ commutes with addition of lower reals: for all $r_1, r_2 \in \tlrr$,
	\[
		jr_1+jr_2=j(r_1+r_2).
	\]
\end{lemma}

\begin{proof}
	If $q < jr_1 + jr_2$, then by definition of addition there are $q_1, q_2 \in \tqq$ satisfying
	\[
		q = q_1 + q_2, \qquad j(q_1 < r_1), \qquad j(q_2 < r_2).
	\]
	But then since the goal $j(q < r_1 + r_2)$ is $j$-closed, we can strengthen these properties to $q_1 < r_1$ and $q_2 < r_2$. This is enough for then we already get $q = q_1 + q_2 < r_1 + r_2$.
	
	Conversely, suppose that $j(q < r_1 + r_2)$. This means that there $j$-locally exists a rational decomposition $q = q_1 + q_2$ with $q_1 < r_1$ and $q_2 < r_2$. But by countable coherence and the commutation of $j$ with conjunction, we obtain that there are $q_1, q_2 \in \tqq$ with $j(q = q_1 + q_2)$ as well as $j(q_1 < r_1)$ and $j(q_2 < r_2)$. But now the claim follows upon distinguishing the cases $q = q_1 + q_2$ and $q \neq q_1 + q_2$, using that $\tqq$ has decidable equality.
\end{proof}

We then have the following immediate consequence.

\begin{corollary}
	\label{closed_sum}
	Suppose that $j$ is countably coherent. Then the sum of two $j$-closed lower reals is again $j$-closed.
\end{corollary}

There is also a simple interaction between a modality $j$ and the formation of indicator lower reals as in \eqref{indicator_lower_real}.

\begin{lemma}
	\label{lemma.j_indicator}
	Let $j$ be a modality. Then for any $P \in \prop$ we have $j\ind{P}=j\ind{jP}$.
\end{lemma}

\begin{proof}
	Clearly $j\ind{P}\le j\ind{jP}$, so we only have to prove the other inequality. Given $q \in \tqq$ with $j(q < \ind{jP})$, we want to prove $j(q<\ind{P})$, so we may strengthen the hypothesis to $q < \ind{jP}$. Thus $q < 0$ or $(q < 1) \land jP$. If $q < 0$, then $q < \ind{P}$ and we are done. If $(q < 1) \land jP$, then we can again strengthen the hypothesis and get $(q<1)\wedge P$, giving $q<\ind{P}$ and hence $j(q<\ind{P})$ as desired.
\end{proof}

We now consider the interaction of lower reals with systems of point modalities (\Cref{system_defn}).

\begin{definition}
	A family of lower reals $(r_\pt)_{\pt \in \pts}$ is \emph{lower semicontinuous} if for every $q \in \tqq$ there exists a $U \in \prop$ such that for all $\pt \in \pts$,
	\beq
		\label{lsc_lr}
		q < r_\pt \: \Longleftrightarrow \: \at U.
	\eeq
\end{definition}

In particular, this implies that every $r_x$ is $\at$-closed. Moreover, a lower semicontinuous family automatically satisfies the following monotonicity condition: for all $\pt,\pt' : \pts$, we have
\begin{equation}
	\label{r_pt_monotone}
	r_\pt \le \at r_{\pt'},
\end{equation}
since $\at U \imp \at \at[\pt'] U$.

\begin{proposition}[{$\at[]$-Locality of lower reals}]
	\label{LR_locality}
	The maps
	\[
		r \longmapsto (\at r)_{\pt\in\pts}
	\]
	and
	\beq
		\label{lr_from_family}
		(r_\pt)_{\pt\in\pts} \longmapsto \forall(\pt \in \pts).r_\pt
	\eeq
	are mutually inverse bijections between $\tlrr$ and the lower semicontinuous families of lower reals.
\end{proposition}

\begin{proof}
	For every $r : \tlrr$, the family with $r_\pt\coloneqq \at r$ for each $k\in\pts$ satisfies lower semicontinuity; indeed for any $q$ we can take $U \coloneqq (q < r)$ itself and \eqref{lsc_lr} holds by definition.

	Similarly, we need to show that \eqref{lr_from_family} indeed defines a lower real.
	\tob{continue here: inhabitedness does not yet need to hold} 
	Downward closure is obvious, since the downward closure property of an $\at[]$-lower real is exactly the usual one which then transfers to $r$ (see \cref{def.j_loc_lower_reals}). Thus it remains to prove roundedness, which by the enough points property amounts to showing that if $r(q)$, then 
	\[
		\at \exists q'. (q' > q) \wedge r(q')
	\]
	for any $\pt : \pts$. But then by \Cref{ax.N_flabby}, this is equivalent to $\exists q'. (q' > q)\wedge \at r(q')$, and the claim now follows by $\at r(q') = r_\pt(q')$.

	Finally, we prove that the above two constructions are inverses. Starting with $r \in \tlrr$, we need to prove that
	\[
		r(q) = \forall (\pt : \pts) . \at r(q),
	\]
	which is an instance of the enough points condition. Starting with a lower semicontinuous family $(r_\pt)$, the relevant property is the equation
	\[
		\at \forall (\pt' : \pts) . \at[\pt'] r_{\pt'}(q) = r_\pt(q),
	\]
	i.e.\ \eqref{eqn.round_trip}, which was proven above.

	We next show that the map from lower semicontinuous families $(r_\pt)_{\pt\in\pts}$ back to lower reals by putting
	\begin{equation}
		r(q) := \forall (\pt : \pts) . r_\pt(q).
	\end{equation}
	We first show that $\at r = r_\pt$ for every $\pt$, or equivalently
	\[
		\at \forall (\pt':\pts) . r_{\pt'}(q) \quad \Longleftrightarrow \quad r_\pt(q)
	\]
	for every $q$. So given $q$, take $U$ as in \eqref{eqn.witness} and the problem is reduced to showing that
	\begin{equation}\label{eqn.round_trip}
		\at \forall (\pt':\pts) . \at[\pt'] U \quad \Longleftrightarrow \quad \at U,
	\end{equation}
	which is now obvious since $\forall \pt' . \at[\pt'] U$ is equivalent to $U$.
\end{proof}

\section{Background on topological spaces}

We recall the definition of topological space mainly to set up notation and to emphasize that it works constructively the same way as classically. We subsequently discuss the interaction of topological spaces with modalities.

\begin{definition}\label{def.internal_space}
	Let $X$ be a set. A \emph{topology} on $X$ is a subset $\Op[X] \subseteq \prop^X$ such that:
	\begin{enumerate}
		\item $\emptyset, X \in \Op[X]$.
		\item If $U,V \in \Op[X]$, then also $U \cap V \in \Op[X]$.
		\item For any $S \subseteq \Op[X]$, we also have $\bigcup S \in \Op[X]$.
	\end{enumerate}
\end{definition}

As usual, the elements of $\Op[X]$ are called \emph{open}. It may also be worth noting that upon identifying subsets of $X$ with predicates on $X$, the subset $\bigcup S$ in the third condition corresponds to the predicate given by $\exists P \in S . P$.

For example, every set $X$ can be equipped with the \emph{discrete topology}, given by $\Op[X] \coloneqq \prop^X$, so that every set is open.

As usual, the morphisms of topological spaces are the maps $f \colon X \to Y$ which are continuous, meaning that $f^{-1}(U) \in \Op[X]$ for all $U \in \Op[Y]$.

\subsection{Interaction with modalities}

The closure of $\Op[X]$ under arbitrary unions has powerful consequences for the interaction with modalities.

\begin{lemma}
	\label{props_open}
	Let $X$ be a topological space. Then:
	\begin{enumerate}
		\item For every open $U \in \Op[X]$ and every modality $j$, also $jU$ is open.
		\item For every truth value $P \in \prop$, the constant predicate $x \mapsto P$ is open.
	\end{enumerate}
\end{lemma}

\begin{proof}
	\begin{enumerate}
		\item Consider the collection of opens given by 
			\[
				S \coloneqq \left\{ Q \in \Op[X] \mid j(Q \subseteq U) \right\}.
			\]
			It remains to be shown that $\bigcup S$ is exactly $jU$. 

			In one direction, we have $jU \subseteq \bigcup S$ since $jU \in S$, which in turn holds because of $j(jU = U)$.

			In the other direction, $x \in \bigcup S$ means exactly that $x \in Q$ for some $Q \in \Op[X]$ with $j(Q \subseteq U)$. But then to prove the goal $j(x \in U)$, we can strengthen this assumption to $Q \subseteq U$, thereby resulting even in $x \in U$.

		\item Apply the previous statement to the open $U \coloneqq \emptyset$ and the closed modality $j \coloneqq P \lor -$ (\Cref{open_closed_qc}). \qedhere
	\end{enumerate}
\end{proof}

\begin{corollary}
	\label{top_on_one}
	The only topology on the singleton set $1$ is the discrete one.
\end{corollary}

\begin{proof}
	Every predicate on $1$ is constant, and therefore every subset of $1$ must be open by \Cref{props_open}.
\end{proof}

\section{Basic theory of valuations}

Valuations on topological spaces are a constructively well-behaved variant of probability measures. If $X$ is a topological space, then we generically write $\Op[X]$ for its partially ordered set of opens, considered as a subset of 

\begin{definition}[Probability valuation]\label{def.prob_valuation}
Let $(X,\Op[X])$ be an internal topological space. A \emph{probability valuation} on $(X,\Op[X])$ is a function $\mu\colon\Op[X]\to\tii$ satisfying the following conditions:
\begin{enumerate}
	\item $\mu(\bot)=0$ and $\mu(\top)=1$;
	\item $(U\imp V)\imp\mu(U)\le\mu(V)$; and
	\item $\mu(U)+\mu(V)=\mu(U\cup V)+\mu(U\cap V)$.
	\item If $D\subseteq\Op[X]$ is a directed subposet (\cref{def.directed}), then
\[
	\mu\big(\exists(U:D).U\big)= \sup_{U: D}\mu(U).
\]
\end{enumerate}
\end{definition}

Let $\tii$ be the unit interval as in \cref{def.unit_interval}, and recall the inclusion $\inc : \prop \to \tii$, given by the constant function $\ind{P}(q)\coloneqq P$. When we discuss the modularity condition, we will implicitly use $\cast\colon\tii\to\tlrr$, sending $r\mapsto (q<0)\lor ((q<1)\wedge (q<r))$ as discussed in \cref{sec.valuations}. Recall also from \cref{top_on_one} that $\prop$ is the unique topology on the one-point space $\{*\}$.

\begin{proposition}
	\label{prop.existence_val_on_1}
	There exists a valuation on the one-point space $\{*\}$, namely the indicator function $\inc : \prop \to \tii$.
\end{proposition}

\tob{Comment on the way in how the internal reasoning looks absurd at first look?}

\begin{proof}
	We first show that $\inc$ is indeed valuation. The normalization conditions and monotonicity follow directly from \cref{lemma.ind_monotonic}. 	Concerning modularity, for $P,Q : \prop$ we prove both inequality directions of the claimed equation
	\[
		\ind{P \lor Q} + \ind{P \land Q} = \ind P + \ind Q.
	\]
	First suppose $q < \ind{P \lor Q} + \ind{P \land Q}$. Thus there are $q_\lor$ and $q_\land$ such that $q = q_\lor + q_\land$ and
	\[
		q_\lor < \ind{P \lor Q}, \qquad q_\land < \ind{P \land Q}.
	\]
	There are three cases.
	\begin{enumerate}[label=(\arabic*)]
		\item If $q_\lor<0$ and $q_\wedge<0$ then $q=q_\lor+q_\wedge<0<\ind P + \ind Q$.
		\item If  $(q_\lor<1)\wedge(P\lor Q)$ and $q_\wedge<0$, then we have two similar subcases, either $P$ or $Q$. Assuming $P$ we have $q_\lor<\ind P$ and $q_\wedge<\ind Q$, so $q<\ind P+\ind Q$.
		\item If $(q_\wedge<1)\wedge(P\wedge Q)$, then both $P$ and $Q$ (and also $q_\lor<1$), so $q_\lor<\ind P$ and $q_\wedge<\ind Q$, and thus $q<\ind P + \ind Q$.
	\end{enumerate}
	
	For the other direction, assume $q < \ind{P} + \ind{Q}$. This means that we have $q_P$ and $q_Q$ with $q = q_P + q_Q$ as well as $q_P < \ind{P}$ and $q_Q < \ind{Q}$. Again we have cases. (1) If $q_P<0$ and $q_Q<0$ then $q=q_P + q_Q<0<\ind{P \lor Q} + \ind{P \land Q}$. (2) If $q_P<0$ and $(q_Q<1)\wedge Q$ then $q_Q<\ind{P\lor Q}$ and $q_P<\ind{P\wedge Q}$; similarly if $q_Q<0$ and $(q_P<1)\wedge P$. (3) If $(q_P<1)\wedge P$ and $(q_Q<1)\wedge Q$ then $q_P<\ind{P\lor Q}$ and $q_Q<\ind{P\wedge Q}$.
	
	

	Concerning Scott continuity \eqref{eqn.scott_continuity}, for any subtype $D \subseteq \prop$, directed or otherwise, both sides of the desired continuity equation
	\[
		\sup_{P : D} \ind{P} = \ind{\exists (P:D) P},
	\]
	are identical; both sides are the constant predicate $\exists(P:D).P$ (see \cref{def.sup_unit_interval,prop.inc_const,prop.cast_sups}). Thus $\inc : \prop \to \tii$ is indeed a valuation.
\end{proof}

\begin{proposition}\label{prop.uniqueness_val_on_1}
	There is precisely one valuation on $\{*\}$, namely the indicator function $\inc : \prop \to \tii$.
\end{proposition}
\begin{proof}
By \cref{prop.existence_val_on_1} it suffices to show that an arbitrary valuation $\mu : \prop \to \tii$ on $\{*\}$ satisfies $\mu(P) = \ind{P}$ for all $P : \prop$. One direction is easy, namely
	\begin{equation}\label{eqn.ind_less_val}
		\ind{P} \le \mu(P).
	\end{equation}
	for all $P:\prop$. Indeed if $q<\ind{P}$ for some $0 \le q<1$ then $P$, in which case $\mu(P)=\mu(\top)=1$. 
	
	The other inequality requires more work. For $P:\prop$, consider the predicate
	\[
		d_P(Q) := \left( \mu(Q) = \ind{Q} \right) \land (Q \Rightarrow P).
	\]
	We claim that $D_P\coloneqq\{Q:\prop\mid d_P(Q)\}$ defines a directed subtype of $\prop$. Since $d_P(\bot)$ holds we have $\exists(Q:D_P).\top$. Now suppose that $d_P(Q_1)$ and $d_P(Q_2)$ for $Q_1, Q_2 : \prop$; we then claim that also $d_P(Q_1 \lor Q_2)$. Since $Q_1 \Rightarrow P$ and $Q_2 \Rightarrow P$, the part $(Q_1 \lor Q_2) \Rightarrow P$ is clear, so we need to show that also $\mu(Q_1 \lor Q_2) = \ind{Q_1 \lor Q_2}$. Using \eqref{eqn.ind_less_val} and the assumed modularity equation, we have
	\begin{align*}
		\ind{Q_1 \lor Q_2} + \ind{Q_1 \land Q_2}	& \le \mu(Q_1 \lor Q_2) + \mu(Q_1 \land Q_2)	\\
								& = \mu(Q_1) + \mu(Q_2) \\
								& = \ind{Q_1} + \ind{Q_2},
	\end{align*}
	where the last step uses the assumptions $d_P(Q_1)$ and $d_P(Q_2)$. But since $\inc$ is a valuation by \cref{prop.existence_val_on_1}, the left-hand side and the right-hand side of this chain of inequalities are equal, so $\ind{Q_1 \lor Q_2} = \mu(Q_1 \lor Q_2)$ by \cref{cor.favorite}. We have now proved our claim that $d_P(Q_1 \lor Q_2)$, making $D_P$ directed.

	A straightforward logical argument shows that
	\begin{equation}
		\label{PfromDQ}
		\exists (Q : D_P). Q \qquad \Longleftrightarrow \qquad P,
	\end{equation}
	where the implication from left to right combines the assumptions $Q$ and $Q \Rightarrow P$ to $P$, while the implication from right to left becomes trivial with $Q := \top$. Since $\mu$ is Scott continuous \eqref{eqn.scott_continuity}, we have
	\[
		\mu(P) = \mu\big( \exists (Q : D_P) . Q \big) = \sup_{Q : D_P} \mu(Q).
	\]
	But now since $d_P(Q)$ implies $\mu(Q) = \ind{Q}$ by definition, we have by the Scott continuity of the valuation $\inc$ that
	\[
		\sup_{Q : D_P} \mu(Q) = \sup_{Q : D_P} \ind{Q} = \ind{\exists(Q:D_P).Q}.
	\]
Now we can conclude using \eqref{PfromDQ} that $\mu(P)=\ind{P}$ as desired.
\end{proof}

Recall from \Cref{props_open} that for every $P : \prop$, the associated constant predicate $\_ \mapsto P$ is open in any topological space $(X,\Op[X])$. 

\begin{corollary}\label{cor.val_const_indicator}
	Let $(X,\Op[X])$ be a topological space and $\mu : \Op[X] \to [0,1]$ any valuation. Then $\mu(\,\_\mapsto P) = \ind{P}$ for all $P : \prop$.
\end{corollary}

\begin{proof}
	By \cref{top_on_one,prop.pushforward,prop.uniqueness_val_on_1}, we can take the pushforward of $\mu$ along the unique continuous map $!\colon X\to (*,\prop)$ and find $\mu(\_\mapsto P)=!_*\mu(P)=\ind{P}$.
\end{proof}

From now on we abuse notation, simply writing $P$ to denote the predicate $(\_\mapsto P)\colon X\to\prop$ on any type $X$.

\section{Interaction of valuations and modalities}


Recall modalities and decidable modalities from \cref{def.modality,def.decidable_modality}. 
\begin{theorem}
	\label{vals_vs_modalities}
	Let $j$ be a decidable modality and $\mu$ a valuation on an internal space $(X,\Op[X])$. Then for all $P : \Op[X]$,
	\[
		\mu(jP) = j \mu(P).	
	\]
\end{theorem}

Note that if $P$ is open then so is $jP$ by \Cref{props_open}, which is necessary in order for $\mu$ to be applicable to $jP$ above.

\begin{proof}
	We first prove two auxiliary statements, both of which are special cases of the overall result.
	\begin{itemize}
		\item If $Q$ is any $j$-closed open, then $\mu(Q):\tii$ is $j$-closed.
			
			To begin the proof, we have the equivalences
			\begin{align*}
				Q \land (Q \Rightarrow j\bot) \quad & \Longleftrightarrow \quad j\bot, \\
				Q \lor (Q \Rightarrow j\bot) \quad & \Longleftrightarrow \quad \top,
			\end{align*}
			where the second one is an instance of the decidability assumption on $j$. Hence applying the modularity law to $Q$ and $Q \Rightarrow j\bot$ results in the equation
			\begin{align}
				\label{j_modularity}
				\begin{split}
					\mu(Q) + \mu(Q \Rightarrow j\bot)	& = \mu(j\bot) + \mu(\top) \\
										& = \ind{j \bot} + 1,
				\end{split}
			\end{align}
			where the second equality is by \cref{cor.val_const_indicator}.
			By \cref{cor.closed_sum},\dis{Need $j$ to commute with $\exists (q:\tqq)$ for this ($j$ decidable is not enough).} a sum of lower reals is $j$-closed if and only if each summand is. Since $j\bot$ and $\top$ are $j$-closed, the associated constant predicates $\ind{j\bot}$ and $1=\ind{\top}$ are too, and hence the right-hand side of \eqref{j_modularity} is $j$-closed. Hence the left-hand side is too, and it follows that $\mu(Q) = j \mu(Q)$, as was to be shown.
		\item If $R$ is any open with $jR$, then $j\mu(R) = j1$.

			The proof is simple: since $R$ implies $\mu(R) = 1$, clearly also $jR$ implies $j(\mu(R) = 1)$. But then also $j\mu(R) = j1$.
	\end{itemize}

	Getting to the proof of the main claim, we apply the modularity law to a very similar pair of opens as in the first item, namely $P$ and $P \Rightarrow j\bot$ (where the difference is that $P$ need not be $j$-closed). This gives
	\[
		\mu(P) + \mu(P \Rightarrow j\bot) = \mu(P \land (P \Rightarrow j\bot)) + \mu(P \lor (P \Rightarrow j\bot)).
	\]
	We now evaluate the second to fourth expressions in this equation with $j$ applied. The argument of the second is already $j$-closed, and therefore $\mu(P \Rightarrow j\bot)$ is also $j$-closed as per the first item above. For the third expression, we consider
	\[
		j \mu(\bot) \le j \mu(P \land (P \Rightarrow j\bot)) \le j \mu(j\bot).
	\]
	By \cref{lemma.j_indicator,cor.val_const_indicator} we have $j \ind{\bot}=j \mu(\bot)=j\mu(j\bot)$ and thus $j \mu(P \land (P \Rightarrow j\bot)) =  j \ind{\bot}$. Finally, we have $j \mu(P \lor (P \Rightarrow j\bot)) = j 1$ by the second item above, since $j$ is decidable; indeed, we have $jP\lor(P\imp j\bot)$ and $j(P \lor (P \Rightarrow j\bot))$ clearly holds in either case. Overall, we therefore get
	\[
		j \mu(P) + \mu(P \Rightarrow j\bot) = j \ind{\bot} + j 1.
	\]
	Since $P \Rightarrow j\bot$ is equivalent to $jP \Rightarrow j\bot$ and the right-hand side is independent of $j$, applying this equation with $jP$ in place of $P$ and cancelling $\mu(P \Rightarrow j\bot)$ results in $j \mu(P) = j \mu(jP)$. But since also $j \mu(jP) = \mu(jP)$ by the first item above, we therefore obtain the overall $\mu(jP) = j \mu(P)$.
\end{proof}

Recall from \Cref{space_localize} that the object of $j$-closed opens, $j \Op[X]$, is a $j$-local internal topological space.

\begin{proposition}
	\label{val_localize}
	Suppose that $j$ is a decidable modality and that $\mu : \Op[X] \to \tlrr$ is a valuation. Then the restriction of $\mu$ to the $j$-closed opens,
	\[
		j \Op[X] \longrightarrow j \tlrr, \qquad P \longmapsto \mu(P)
	\]
	produces a $j$-local valuation.
\end{proposition}

Note that this lands indeed in $j \tlrr$ because of \Cref{vals_vs_modalities}.

\begin{proof}
	The normalization conditions and monotonicity are obvious. The modularity equation holds because $j$ commutes with both $\land$ and $\lor$ (see \cref{prop.dec_mod_or}).

	Now let $D \subseteq j \Op[X]$ be a $j$-locally directed $j$-closed subposet. We want to prove that \eqref{eqn.local_scott_continuity} holds, i.e.\
	\[
		\mu\left( j \exists (P : D) . P \right) \le j \exists (P : D). \mu(P).
	\]
To see this, consider the predicate
	\[
		d' \: : \: \Op[X] \longrightarrow \prop, \qquad Q \longmapsto j \exists (P : D) . (Q \imp P)
	\]
	and let $D'\subseteq\Op[X]$ be the corresponding subobject. We claim that $D'$ is directed. Inhabitedness follows with $Q \coloneqq\bot$ from $j$-local inhabitedness of $D$. Now suppose that $d'(Q_1)$ and $d'(Q_2)$. Then a straightforward argument using the $j$-local directedness of $D$ implies $d'(Q_1 \lor Q_2)$. Hence $D'$ is indeed directed.

	The assumed Scott continuity of $\mu$ applied to $D'$ thus gives
	\begin{equation}\label{eqn.my_scott1}
		\mu\left( \exists (Q : D') . Q \right) = \exists (Q : D') . \mu(Q).
	\end{equation}
	Furthermore, we have
	\[
		j \exists (P : D) . P \quad \Longrightarrow \quad \exists (Q : D') . Q
	\]
	by taking $Q \coloneqq \top$, as well as
	\[
		\exists (Q : D') . \mu(Q) \quad \Longrightarrow \quad j \exists (P : D) . \mu(P)
	\]
	by unfolding the definition of $D'$ and using monotonicity of $\mu$. Applying $\mu$ to the both sides of the former implication and combining the result with \eqref{eqn.my_scott1} proves the desired
	\[
		\mu\left( j \exists (P : D) . P \right) \: \le \: j \exists (P : D) . \mu(P).
\qedhere
	\]
\end{proof}


\section{Valuations and systems of point modalities}

We now want to consider the relation between valuations and an internal space and families of $\at[]$-locally defined valuations.

We start by considering an analogous question for lower reals. For any $r : \tlrr$ and any $\pt : \pts$, we get the $\at$-lower real $r_\pt := \at r$. Thus overall we have the family $(r_\pt)_{\pt \in \pts}$. We now show which families arise in this way, and at the same time how a lower real can be pieced together from a family of $\at[]$-lower reals.

Recall from \cref{def.at_prob_val} that an \emph{$\at$-local valuation} on an internal space $(X,\Op[X])$ is defined to be a map $\at \Op[X] \to \at \tlrr$ satisfying the $\at$-local versions of the conditions in the definition of valuation. To be clear, when we speak of families of $\at[]$-local valuations $(\mu_\pt)_{\pt : \pts}$, we mean that $\mu_\pt$ is $\at[\pt]$-local.

\begin{definition}\label{def.valuations_compatible_lowersemi}
	A family of $\at[]$-local valuations $(\mu_\pt)_{\pt : \pts}$ is
	\begin{enumerate}
		\item \emph{compatible} if for all $\pt, \pt' : \pts$ and $P : \at[\pt'] \Op[X]$,
			\[
				\mu_{\pt}(\at[\pt] P) = \at[\pt] \mu_{\pt'}(P).
			\]
		\item \emph{lower semicontinuous} if for every $P : \Op[X]$, the family of $\at[]$-lower reals
			\[
				\left( \mu_\pt(\at P) \right)_{k\in\pts}
			\]
			is lower semicontinuous.
	\end{enumerate}
\end{definition}

By \cref{ax.local_dec,prop.specialization}, for any two points $\pt,\pt'\in\pts$ either $\at[\pt']\bot\imp\at[\pt]\bot$ or $\at[\pt]\at[\pt']\bot$, corresponding to whether or not $\pt\le\pt'$. In order to understand the compatibility condition of \cref{def.valuations_compatible_lowersemi}, we consider these cases separately. 

In the second case, the assumption that $P$ is $\at[\pt']$-closed implies $\at[\pt] P$, so that the left-hand side is $1$. But since $\mu_{\pt'}$ takes values in $\at[\pt']$-lower reals, also the right-hand side is $1$. Thus the compatibility condition is nontrivial only in the other case, $\at[\pt'] \bot \imp \at[\pt] \bot$.

Recall from \Cref{val_localize} that if $\mu : \Op[X] \to \tlrr$ is a valuation, then for every $\pt$ the restriction of $\mu$ to $\at \Op[X]$ is an $\at$-local valuation. 

\begin{lemma}\label{lemma.val_rests_compat_lowersemi}
	Let $\mu : \Op[X] \to \tlrr$ be a valuation. Then the family $\left( \rest{\mu}{\at \Op[X]} \right)_{\pt : \pts}$ is a compatible and lower semicontinuous family of $\at$-local valuations.
\end{lemma}

\begin{proof}
	For compatibility, we need to show that if $P : \at \Op[X]$, then
	\[
		\mu( \at[\pt'] P ) = \at[\pt'] \mu(P).
	\]
	But this holds more generally for any $P:\Op[X]$ by \Cref{vals_vs_modalities}.

	For lower semicontinuity, we need to find $U : \prop$ such that for all $\pt : \pts$,
	\[
		\mu(\at P)(q) \: \Leftrightarrow \: \at U.
	\]
	But then again by \Cref{vals_vs_modalities}, this holds with $U := \mu(P)(q)$.
\end{proof}

We now consider the inverse problem of stitching together a compatible lower semicontinuous family of $\at[]$-local valuations to a valuation on $X$. This works as follows.

\begin{lemma}\label{lemma.compat_lowersemi_stitched}
	Let $(\mu_\pt)_{\pt : \pts}$ be a compatible and lower semicontinuous family of $\at[]$-local valuations. Then putting
	\begin{equation}
		\label{mu_stitched}
		\mu(P) := \forall (\pt : \pts) . \mu_\pt(\at P)
	\end{equation}
	for $P : \Op[X]$ defines a valuation.
\end{lemma}

\begin{proof}
	Let $\mu$ be as in \eqref{mu_stitched}; then $\mu(P)$ is indeed a lower real for any $P:\Op[X]$ thanks to \cref{vals_vs_modalities,prop:LR_locality}. To verify the conditions required of a valuation, it is enough to prove that each one holds $\at$-locally, thanks to \cref{ax.enough_pts}. To do so, we first prove that for every $P : \Op[X]$ and $\pt\in\pts$,
	\begin{equation}
		\label{stitching_reproduces}
		\at \mu(P) = \mu_\pt(\at P).
	\end{equation}
	By definition of $\mu$ and the fact that $\mu_\pt$ is $\at$-closed the inequality $\at \mu(P) \le \mu_\pt(\at P)$ is clear, so we just need to show that $\mu_\pt(\at P) \le \at \mu_{\pt'}(\at[\pt'] P)$ for all $\pt' : \pts$. But this holds by monotonicity, $\mu_\pt(\at P)\le\mu_\pt(\at\at[\pt']P)$ and the fact that
	\[
		\mu_\pt(\at \at[\pt'] P) = \at \mu_{\pt'}(\at[\pt'] P),
	\]
	which is itself an instance of the compatibility assumption.

	We have now established \eqref{stitching_reproduces}, and from there $\mu$ is easily seen to satisfy the normalization, monotonicity, and modularity conditions of \cref{def.prob_valuation}. For Scott continuity \eqref{eqn.scott_continuity}, let $D \subseteq \Op[X]$ be directed. It is then enough to show that for every $\pt$,
	\begin{equation}
		\label{goal_continuous}
		\mu_\pt(\at \exists (P : D) . P) \: \le \: \at \exists (P : D). \mu(P)
	\end{equation}

To start, let $d\colon P\to\prop$ classify $D\subseteq P$, and consider the predicate
	\[
		d_\pt \: : \: \at \Op[X] \longrightarrow \at \prop, \qquad Q \longmapsto \at \exists (P : \Op[X]) . (Q \imp \at P) \land \at d(P).
	\]
	Let $D_\pt\subseteq\at\Op[X]$ be the subtype corresponding to $d_\pt$; we claim that $D_\pt$ is $\at$-locally directed. Since $D$ is inhabited, one immediately checks that $d_\pt(\at\bot)$ holds; thus $D_\pt$ is $\at$-locally inhabited. Thus we need to prove that
\[
		\forall(Q_1, Q_2 : D_\pt ) .\at \exists (Q : D_\pt) .(Q_1 \lor Q_2)  \imp Q.
\]
	Take $Q_1, Q_2 : \at \Op[X]$ with $d_\pt(Q_1)$ and $d_\pt(Q_2)$ to be given. In order to then prove the $\at$-existence of $Q$ with the desired properties, we can unfold the definition of $d_\pt$ and drop the $\at$'s from the hypotheses. This gives $P_1$ and $P_2$ with $Q_i \imp P_i$ and $d(P_i)$. But, noting that $Q_1\lor Q_2$ is in $\at\Op[X]$ by \cref{prop.dec_mod_or}, it follows by directedness of $d$ that $d_\pt(Q_1 \lor Q_2)$.

	Having established that $d_k$ is indeed $\at$-locally directed, we apply $\at$-local Scott continuity of $\mu_\pt$ to it and obtain
\[
		\mu_\pt\left( \at \exists (Q : D_\pt). Q \right) = 
		\at \exists (Q : D_\pt) . \mu_\pt(Q).
\]
	Similar to the proof of \Cref{val_localize}, we have an implication
	\[
		\at \exists (P : D). P \quad \Longrightarrow \quad \at \exists (Q : D_\pt) . Q
	\]
	proven by taking $Q := \top$, and an implication
	\[
		\at \exists (Q : D_\pt) . \mu_\pt(Q) \quad \Longrightarrow \quad \at \exists (P : D) . \mu_\pt(\at P)
	\]
	obtained by removing the outer $\at$ on the left, unfolding $d_\pt(Q)$ and applying monotonicity of $\mu_\pt$ to the resulting $Q \imp \at P$. Applying $\mu$ and combining the above with \eqref{stitching_reproduces}, we obtain
	\begin{align*}
			\mu_\pt(\at \exists (P : D) . P) &\le
			\mu_\pt(\at \exists (Q : D_k). Q)\\&=
			\at \exists (Q : D_\pt).\mu_\pt(Q)\\&\le
			\at \exists (P : D). \mu_\pt(\at P)\\&=
			\at \exists (P : D). \at\mu(P)\\&=
			\at \exists (P : D). \mu(P),
  \end{align*}
which was the desired inequality \eqref{goal_continuous}. This establishes the Scott continuity of $\mu$.
\end{proof}

\begin{theorem}
	\label{main_internal}
	Let $(X,\Op[X])$ be an internal space. Then restricting a valuation on $X$ to a family of $\at[]$-local valuations implements a bijection between:
	\begin{enumerate}
		\item valuations on $X$, and
		\item those families of $\at[]$-local valuations which are compatible and lower semicontinuous.
	\end{enumerate}
\end{theorem}

\begin{proof}
	We only need to argue that the constructions from \cref{lemma.val_rests_compat_lowersemi,lemma.compat_lowersemi_stitched} are mutually inverse. Starting with a compatible and lower semicontinuous family, we need to show that for $P : \at \Op[X]$, we have
	\[
		\mu_\pt(P) = \forall (\pt' : \pts) . \mu_{\pt'}( \at[\pt'] P).
	\]
	But then using the compatibility assumption, the right-hand side evaluates to $\forall \pt' . \at[\pt'] \mu_\pt(P)$, and hence indeed equals the left-hand side by the enough points axiom \ref{ax.enough_pts}.

	Starting with a valuation $\mu$, we need to prove that for every $P : \Op[X]$,
	\[
		\mu(P) = \forall (\pt : \pts) . \mu(\at P).
	\]
	Applying \Cref{vals_vs_modalities} again turns this into an instance of the enough points axiom.
\end{proof}

\newpage
\part{Pointwise semantics of internal valuations}

\section{Intended semantics of systems of point modalities}
\label{points_semantics}

Our primary intended semantics is that our topos is $\shv(T)$ for some topological space $T$, and that every modality $\at$ is the quasi-closed modality associated to the open set $T \setminus \overline{\{\pt\}}$. More precisely, consider the underlying set $T$ of the space, and consider the associated constant presheaf on $T$, which assigns the set $T$ to each open $U\in\Op[T]$. We take $\church{\pts}$ to be the sheafification of this presheaf. Our next goal is to define a sheaf homomorphism
\beq
	\church{\at[]}\colon\church{\pts}\to\church{\decmod}.
\eeq
Since sheafification is left adjoint to the underlying presheaf functor, and since the inclusion of constant presheaves is left adjoint to the global sections functor, the sheaf morphism $\at[]$ can be identified with a single function $j\colon T\to\church{\decmod}(T)$. So fix a point $\pt\in T$;
to define an element $j_\pt\in\church{\decmod}(T)$ is to give a sheaf morphism $j_\pt\colon\Op[T]\to\Op[T]$ satisfying the following properties for all $U,V\in\Op[T]$:
\begin{enumerate}
	\item\label{j_increasing} $U\subseteq j_\pt(U)$;
	\item\label{j_idempotent} $j_\pt j_\pt(U)=j_\pt(U)$;
	\item\label{j_meets} $j_\pt(U\cap V)=j_\pt(U)\cap j_\pt(V)$; and
	\item\label{j_decidable} $j_\pt(U)\cup (U^c\cup j_\pt(\varnothing))^\circ=T$.
\end{enumerate}
where $^c$ is complement and $^\circ$ is interior. We define $j_\pt\colon\Op[T]\to\Op[T]$ by
\begin{equation}\label{eqn.j_k}
	j_\pt(U)\coloneqq
	\begin{cases}
		(\{\pt\}^c)^\circ&\tn{ if }\pt\not\in U\\
		T&\tn{ if } \pt\in U
	\end{cases}
\end{equation}
If $\pt\in U$ then $j_\pt(U)=T$ and conditions \ref{j_increasing}, \ref{j_idempotent}, and \ref{j_decidable} are trivially satisfied. Supposing now that $\pt\not\in U$ then $U\subseteq \{\pt\}^c$ and hence $U\subseteq j_\pt(U)$, giving condition \ref{j_increasing}. Since $\pt\not\in(\{\pt\}^c)^\circ=j_\pt(U)$, we also have condition \ref{j_idempotent}. Since $U\subseteq j_\pt(\varnothing)$, we have $T=U^c\cup U\subseteq (U^c\cup j_\pt(\varnothing))$ so we also have condition \ref{j_decidable}. For condition \ref{j_meets}, if $\pt\in U\cap V$ then both sides are $T$; if $\pt\not\in U\cap V$ then $\pt\not\in U$ or $\pt\not\in V$ in which case both sides are $(\{\pt\}^c)^\circ$. Thus \eqref{eqn.j_k} satisfies the necessary conditions, and we have defined our sheaf homomorphism $\church{\at[]}$ from \eqref{eqn.at_semantics}.

\begin{definition}[Specialization order]\label{def.specialization}
For points $\pt,\pt' \in T$, say that $\pt$ is a \emph{specialization} of $\pt'$, denoted $\pt'\le\pt$ if every open set containing $\pt'$ also contains $\pt$.
\end{definition}

\begin{lemma}\label{prop.specialization}
For points $\pt,\pt'\in T$, we have $\pt'\le\pt$ iff $T\models\at\bot\imp\at[\pt']\bot$ holds in $\shv(T)$.
\end{lemma}

\begin{proof}
We have $T\models\at\bot\imp\at[\pt']\bot$ iff $(\{\pt\}^c)^\circ\subseteq(\{\pt'\}^c)^\circ$. This holds iff $(\{\pt\}^c)^\circ\subseteq\{\pt'\}^c$. Letting $\ol{\{\pt\}}$ denote the closure of $\{\pt\}$, then $(\{\pt\}^c)^\circ=\ol{\{\pt\}}^c$, so the above holds iff $\ol{\{\pt\}}^c\subseteq\{\pt'\}^c$, iff $\pt'\in\ol{\{\pt\}}$, iff every closed set containing $\pt$ contains $\pt'$, iff $\pt'\le\pt$ as in \cref{def.specialization}.
\end{proof}

\begin{axiom}[{$\at[]$-Local decidability}]\label{ax.local_dec}
	For all $\pt : \pts$ and $P : \prop$,
	\[
		\at P \: \lor \: (P \imp \at \bot).
	\]
\end{axiom}

\begin{soundproof}
	This is simply the fact that $\church{\at}$ satisfies condition \ref{j_decidable}, as shown above.
\end{soundproof}

\begin{axiom}[Countable coherence]
	\label{ax.N_flabby}
	For all $\pt : \pts$ and predicates $P : \tnn \to \prop$,
	\[
		\at \exists (n : \tnn) . P(n) \quad \Longrightarrow \quad \exists (n : \tnn) . \at P(n).
	\]
\end{axiom}

\begin{soundproof}
Suppose $T\models\at \exists (n : \tnn) . P(n)$; then there is a neighborhood $U\ni\pt$ such that $U\models\exists (n : \tnn) . P(n)$, so take $n\in\tnn(U)$ and suppose $P(n)$. Since $\tnn$ is the sheafification of the constant presheaf $V\mapsto\nn$, a section of it on $U$ can be identified with a cover $U=\bigcup_{i\in I}V_i$ and a natural number $n_i\in\nn$ with $\rest{P}{V_i}(n_i)$ for each $i$. We have $k\in V_i$ for at least one such $V_i$. Thus we can take $n_i\in\tnn(U)$, and and prove $U\models\exists(n:\tnn).\at P(n)$.
\end{soundproof}

\begin{axiom}[Enough points]
	\label{ax.enough_pts}
	For all $P : \prop$,
	\[
		\big( \forall (\pt : \pts). \at P \big) \: \Rightarrow \: P.
	\]
\end{axiom}

\begin{soundproof}
Take $U\subseteq T$ and suppose $U\models\forall (\pt : \pts). \at P$. For each point $\pt\in T$, we have $U\models\at P$ iff either $\pt\in P$ or $U\subseteq\{\pt\}^c$. In particular for every $\pt\in U$ we have $\pt\in P$; hence $U\subseteq P$ which gives $U\models P$ as desired.
\end{soundproof}

We now show that these axioms are independent.

\begin{proposition}
	For each one of \Cref{ax.local_dec,ax.enough_pts,ax.N_flabby}, there is a topos together with an object $\pts$ and a morphism $\at[] \colon \pts \to \modts$ which does not satisfy that axiom while satisfying the other two.
\end{proposition}

\begin{proof}
	For \Cref{ax.local_dec}, consider any non-Boolean topos with only the identity modality. For \Cref{ax.enough_pts}, take $\cat{Set}$ with only the terminal modality $\top$. The case of \Cref{ax.N_flabby} requires a bit of elaboration.

	Let the space $T := \beta\nn$ be the Stone-\v{C}ech compactification of the natural numbers. This space has the following properties:
	\begin{itemize}
		\item $T$ is compact and extremally disconnected.
		\item For every $n \in \nn$, the point $n \in \nn$ is isolated.
		\item $\nn \subseteq T$ is dense.
	\end{itemize}
	The extremal disconnectedness implies that $\shv(T)$ is a de Morgan topos~\cite[D4.6]{elephant2}, meaning that the double negation modality $\lnot\lnot$ satisfies the decidability property of \Cref{ax.local_dec}. Thus let $\pts$ be the constant sheaf on the points of $T$, giving rise to the point modalities $\at[]$ as above, together with one additional element for the double negation modality. Then the enough points condition of \Cref{ax.enough_pts} holds (since by the soundness proof above, it already held without adding $\neg\neg$). 
	
	The proof will be complete upon showing that the double negation modality fails \Cref{ax.N_flabby} globally. To this end, consider the globally defined predicate $P$ where $\church{P} : \church{N} \to \church{\prop}$ is the unique sheaf map induced by the presheaf map out of the constant presheaf $\nn$ which takes every $n \in \nn$ to the open set $\{n\}$. Then $\nn \models \exists n. P(n)$, and therefore $B \models \lnot \lnot \exists n. P(n)$ by density of $\nn \subseteq B$. 
	
	For contradiction, suppose $B \models \exists n . \lnot\lnot P(n)$ were to hold as well. Then there  is some cover $(U_i)$ of $B$ and external naturals $(n_i)$ such that $U_i\models\neg\neg P(n_i)$. By compactness, we may assume $I$ is finite. Since each $\{n\}$ is open, the only natural number in the open set $\church{\neg\neg P(n_i)}$ is $n_i$, and the finiteness of $I$ and the fact that $U_i\subseteq \church{\neg\neg P(n_i)}$ present the anticipated contradiction.
\end{proof}

\tob{Move the following to where it belongs. Technically those statements aren't quite right yet, since $\pt$ on the left is internal while it's external on the right. But for now I'll pretend that something like this makes sense, and similarly further down in Sec 7}

Consider the geometric morphism
\[
	\adj{\shv(B)}{-_\pt}{\sky_\pt}{\Set}
\]
corresponding to the inclusion of the point $\pt\in B$. The type of $\at$-closed propositions has the following semantics. Here $X_\pt$ is called the \emph{stalk} of sheaf $X$ at $\pt$ and $\sky_\pt(S)$ is called the skyscraper sheaf of set $S$ at $\pt$. In particular,
\[
\sky_\pt(S)(U)=
\begin{cases}
	S&\tn{ if }\pt\in U\\
	1&\tn{ if } \pt\not\in U
\end{cases}
\]

\begin{lemma}
	\label{at_props_semantics}
	In the intended semantics on $\shv(B)$, we have 
	\[
		\church{\at \prop} \cong \sky_\pt(\{\bot,\top\}).
	\]
\end{lemma}

\begin{proof}
By \eqref{eqn.j_k}we have the following for any open $U$:
\[
	\church{\at\prop}(U)=\{V\subseteq U\mid V=(\{\pt\}^c)^\circ \text{ or }V=U\}.
\]
This set has two elements when $\pt\in U$ and one element when $\pt\not\in U$.
\end{proof}

More generally, the semantics of types of $\at$-closed predicates is as follows.

\begin{lemma}
	\label{at_preds_semantics}
	For any type $X$,
	\[
		\church{\at \prop^X} \cong \sky_\pt(\church{X}_\pt),
	\]
	\dis{This be $\church{\at \prop^X} \cong \sky_\pt(\{\bot,\top\}^{\church{X}_\pt})$, correct?}
	where $\church{X}_\pt$ denotes the stalk.
\end{lemma}

\begin{proof}
	Upon noting that $\at \prop^X$ is isomorphic to the function type $X \to \at \prop$,
	\dis{Minor point, but isn't $\at\prop^X$ \emph{equal} to the function type $X \to \at \prop$?}
	this follows from the previous lemma and a straightforward application of the standard semantics of function types.
\end{proof}


\section{Background on internal spaces and Moerdijk's theorem}

Recall from \cref{prop.local_homeo} that there is an equivalence between the category $\shv(T)$ of sheaves on a topological space $T$ and that of local homeomorphisms over $T$.

\begin{theorem}[{\cite[Theorem 1.5]{moerdijk1984spaced}}]
\label{moerdijks_theorem}
Let $T$ be a topological space, $X\in\shv(T)$ a sheaf on it, and $p\colon E_X\to T$ the corresponding local homeomorphism. Then there is a one-to-one correspondence between internal topologies $\Op$ on $X$ and diagrams of topological spaces
\[
\begin{tikzcd}
	E_X\ar[dr, "p"']\ar[rr, "c^{\Op{X}}"]&&
	E_X^{\Op{X}}\ar[dl, "p^{\Op{X}}"]\\&
	T
\end{tikzcd}
\]
for which the map $c$ is identity on points.
\end{theorem}

% ==== Section ====%
\subsection{$j$-local internal spaces}

Similar to the $j$-local lower reals, also the definition of internal space localizes with respect to a modality $j$.

\tob{At the moment this allows the frame of opens to live on any object, not just a $j$-sheaf. We may or may not want to change that}

More concretely, this means that a $j$-local internal space consists of an object $X$ and an openness predicate $\Op[X]^j : (\prop_j)^X \to \prop_j$, where $\prop_j$ is the object of $j$-closed propositions. This openness predicate needs to satisfy the obvious $j$-versions of the conditions above. Let $\Op[X]_j\subseteq(\prop_j)^X$ denote the $j$-closed subobject classified by $\Op(X)j$. Reducing the number of occurrences of $j$ as much as possible, these conditions are as follows:

\begin{enumerate}
	\item $\Op[X]^j(\top)$,
	\item $\Op[X]^j(j\bot)$,
	\item $(\Op[X]^j(U)\wedge\Op[X]^j(V))\imp \Op[X]^j(U\wedge V)$ for any $U,V\in\pow_j(X)$, and
	\item $\Op[X]^j(j\exists(P:S). P)$ for any $j$-closed subobject $S\subseteq\Op[X]^j$. 
\end{enumerate}

\begin{lemma}
	\label{space_localize}
	For any internal space $(X,\Op[X])$, the predicate
	\[
		j \Op[X] \: : \: \prop_j^X \longrightarrow \prop_j, \qquad P \longmapsto j \Op[X](P)
	\]
	produces a $j$-local internal space that we denote $(X,j \Op[X])$. 
\end{lemma}

\begin{proof}
	$j\bot$ is $j$-locally open since any constant predicate is open already in the original space.	The $j$-opens are (automatically $j$-locally) closed under finite intersections since the original opens are and $j$ commutes with intersections. 

	For the $j$-local openness of \eqref{global_sup}, note that for any $S\subseteq j\Op[X]$, this predicate is equivalent to
	\[
		\exists (Q : \Op[X]) . \left[ S(jQ) \land (jQ \imp  Q) \right] \land Q,
	\]
	which is open in the original topology. But then applying $j$ to it produces a $j$-local open, in the sense that it satisfies $j \Op[X]$.
\end{proof}

% ==== Section ====%
\subsection{Valuations}\label{sec.valuations}

\begin{definition}[Directed poset]\label{def.directed}
Let $(P,\le)$ be an internal poset in $\cat{E}$ (\cref{def.internal_poset}). It is \emph{directed} if it satisfies
\begin{enumerate}
	\item $\exists(p:P).\top$, and
	\item $\forall(p,p':P).\exists(q:P).(p\lor p')\imp q$.
\end{enumerate}
\end{definition}


Recall the lower unit interval type $\tii$ from \cref{def.unit_interval}. We may implicitly cast $r:\tii$ as a lower real using the function $\cast\colon\tii\to\tlrr$ from \cref{prop.unit_interval_cast}. For example in the modular condition (3) below, the expression $r+r'$ on either side of the equation is shorthand $\cast(r)+\cast(r')$. However condition (3) is the only place where we need to invoke $\cast$; e.g.\ in the continuity condition (4), recall from \cref{prop.cast_sups} that the $\sup$ can be computed in $\tii$.

Note that the inequality $\sup_{U: D}\mu(U)\le\mu\big(\exists(U:D).U\big)$ is purely formal, so Scott continuity is equivalent to

\begin{equation}\label{eqn.scott_continuity}
	\mu\big(\exists(U:D).U\big)\le\sup_{U: D}\mu(U).
\end{equation}


\begin{proposition}[Push-forward valuation]\label{prop.pushforward}
	Suppose that $f\colon X\to Y$ is a continuous map of internal topological spaces. Then for any valuation $\mu$ on $X$, the function $f_*\mu\colon\Op[Y]\to\tlrr$ given by $f_*\mu(U)\coloneqq\mu(f^{-1}(U))$. If $\mu$ is continuous (resp.\ a probability valuation) then $f_*\mu$ is too.
\end{proposition}
\begin{proof}
	The pullback functor $f^{-1}\colon\pow(Y)\to\pow(X)$ preserves limits and colimits, so any of the conditions 1,3,4,5 that holds for $\mu$ holds for $f_*\mu$ also. For 2, suppose $U\imp V$. Then $f^{-1}(U)\imp f^{-1}(V)$, so $\mu(f^{-1}(U))\le\mu(f^{-1}(V))$, proving the result.
\end{proof}

\begin{theorem}
Probability valuations coincide with probability measures on Polish spaces.
\end{theorem}

\dis{Explain somewhere how to get $j$-local version of anything; explain $j$-logic.}

\begin{definition}[$j$-local probability valuation]\label{def.at_prob_val}
\dis{Explain what's going on in terms of $j$'s and the interval $\mathbb{I}$.}
Let $(X,\Op[X])$ be an internal topological space. An \emph{$j$-local probability valuation} on $(X,\Op[X])$ is a function $\mu\colon j\Op[X]\to j\tii$ satisfying the following conditions:
\begin{enumerate}
	\item $\mu(j\bot)=0$ and $\mu(\top)=1$;
	\item $(U\imp V)\imp\mu(U)\le\mu(V)$; and
	\item $\mu(U)+\mu(V)=\mu(U\cup V)+\mu(U\cap V)$.
	\item If $D\subseteq j\Op[X]$ is a directed $j$-closed subposet then
	\begin{equation}\label{eqn.local_scott_continuity}
	\mu\big(j\exists(U:D).U\big)\le\sup_{U: D}\mu(U).
	\end{equation}
\end{enumerate}
\end{definition}




% ======== Chapter ========%

\section{Consequences for the semantics of internal valuations}

The previous sections have dealt with statements in intuitionistic type theory equipped with a bunch of additional modalities. We now move on to consider semantics in the topos $\shv(B)$, based on interpreting the $\at$-modalities as points as in \Cref{axioms_soundness}.

We start with the semantics of internal spaces. If $p : E \to B$ is a continuous map between topological spaces, then this defines an internal space in $\shv(B)$. We now explain how this works, following Moerdijk's work on internal spaces~\cite{moerdijk1984spaced}.

The sets of local sections of $p$ form a sheaf on $B$. Its \'etalification $\germs{E}{}$ is another space consisting of all the germs $(x,[f])$, where $[f]$ is the equivalence class of a local section $f\colon U\to E$ of $p$, for some open neighborhood $U\ni p$. We have the usual local homeomorphism $\germs{E}{} \to B$. But $\germs{E}{}$ carries another topology generated by choosing an open set $V\subseteq E$ and considering the set of germs $(x,[f])$ for which some representative $f\colon U\to E$ has $f(U)\subseteq V$.

\begin{lemma}
	This topology is (non-strictly) coarser than the \'etale topology, and the projection $\germs{E}{} \to B$ is continuous.
\end{lemma}

\begin{proof}
	For the first claim, we need to show that the set of germs contained in a given open $V \subseteq E$ is also \'etale open. So for a given germ $(x,[f])$ in $V$ represented by $x \in B$ and a local section $f : U \to E$, we need to find an \'etale neighborhood which is contained in the given open specified by $V$.

	The assumption that the germ $(x,[f])$ is in $V$ means that we can assume $f(U) \subseteq V$ by choosing $U$ small enough. But then the germ of $f$ at any point in $U$ lands in $V$, and this defines the desired \'etale neighborhood.

	For continuity of the projection $\germs{E}{} \to B$, consider an open $U \subseteq B$. Then its preimage consists of all germs defined on subopens of $U$. All of those have range contained in $p^{-1}(U)$, and therefore form an open set in $\germs{E}{}$.
\end{proof}

Using Moerdijk's \Cref{moerdijks_theorem}, the lemma shows that the sheaf of sections of $p$ comes with a canonical internal topology in $\shv(B)$. We denote the resulting internal space by $(E_p, \Op(E_p))$.

\begin{lemma}
	\label{opens_semantics}
	We have, for open $U \subseteq B$,
	\[
		\church{\Op(E_p)}(U) \cong \{ \textrm{open sets in } \germs{E}{} \cap p^{-1}(U) \},
	\]
	naturally in $U$ with respect to the obvious restriction maps on the right.
\end{lemma}

\begin{proof}
	\tob{Just need to unfold Moerdijk's constructions. I haven't done this yet, so I will just assume that this is true}
\end{proof}

Note that every stalk of the sheaf of sections of $p$ carries a canonical (external) topology as well, namely again the topology generated by the opens in $E$, or equivalently the subspace topology of the coarser topology on the \'etale space described above. For $x \in B$, let us denote this external topological space by $\germs{E}{x}$.

\begin{lemma}
	\label{at_opens_semantics}
	For $\pt \in \pts$, the type $\at \Op[E_p]$ has the following semantics:
	\[
		\church{\at \Op[E_p]} \cong \sky_\pt(\Op[\germs{E}{\pt}]).
	\]
\end{lemma}

\begin{proof}
	Recall that $\at \Op{E_p}$ is the subtype of $\Op{E_p}$ consisting of those opens which are $\at$-closed as predicates. In other words, we have a pullback diagram
	\[
		\begin{tikzcd}
			\at \Op{E_p} \ar{r} \ar{d}	& \Op{E_p} \ar{d}	\\
			\at \prop^{E_p} \ar{r}		& \prop^{E_p}
		\end{tikzcd}
	\]
	The claim then follows upon combining \Cref{opens_semantics} with \Cref{at_preds_semantics}.
\end{proof}

\begin{lemma}
	\label{at_lowerreals_semantics}
	For $\pt \in \pts$, we have
	\[
		\church{\at \tlrr} \cong \sky_\pt(\rr).
	\]
\end{lemma}

\begin{proof}
	\tob{tbw}
\end{proof}

\begin{lemma}
	For $\pt \in \pts$ and $E$ as above, we have
	\[
		\vals_{\at{\pt}}(E) = 
	\]
	\tob{continue here}
\end{lemma}

\tob{more lemmas to come. In particular, describe the semantics of $\at$ for lower reals}

It is natural to ask what the internal valuations on the internal space $E_p$ are.

Recall that $x \le x'$ in the specialization preorder means that every neighborhood of $x$ is also a neighborhood of $x'$. This implies that there is a restriction map $\germs{E}{x} \to \germs{E}{x'}$, which is easily seen to be continuous. If $\mu_x$ is a valuation on $\germs{E}{x}$, then we denote its pushforward to $\germs{E}{x'}$ by $\mu_x|_{x'}$. To be clear, its value on an open $U \subseteq \germs{E}{x'}$ is given by the value of $\mu_x$ on the preimage of $U$ in $\germs{E}{x}$.  
\begin{theorem}
	\label{main_external}
	Let $p : E \to B$ be a continuous open map between topological spaces. Then there is a bijection between:
	\begin{enumerate}
		\item Internal valuations in $\shv(B)$ on the internal space associated to $p$.
		\item Families $(\mu_x)_{x \in B}$, where $\mu_x$ is a valuation on $\germs{E}{x}$, subject to the following conditions:
			\begin{itemize}
				\item Compatibility: if $x \le x'$ in the specialization preorder on $B$, then
					\[
						\rest{\mu_x}{x'} = \mu_{x'}.
					\]
				\item Lower semicontinuity: for any open $U \subseteq \germs{E}{}$, the map
					\[
						B \longrightarrow \rr, \qquad x \longmapsto \mu_x(U \cap \germs{E}{x})
					\]
					is lower semicontinuous.
			\end{itemize}
	\end{enumerate}
	Moreover, this bijection is natural in $p$ for fixed $B$ (meaning a natural transformation between functors $\cat{Top}/B \to \cat{Set}$).
\end{theorem}

\begin{proof}
	\tob{Relevant steps: determine the semantics of objects $\at[]$-closed predicates}
	By \Cref{main_internal}, we can identify internal valuations on $E$ with the morphisms
	\[
		\mu_{\pointwise} : \pts \times \Op[E] \longrightarrow \tlrr
	\]
	such that every $\mu_{\pointwise}(\pt,-) : \Op[E] \to \tlrr$ is an $\at[\pt]$-local valuation, and such that the compatibility and lower semicontinuity conditions hold as $\pt$ varies.
	\tob{in progress}
\end{proof}

\newpage
\part{Application to stochastic processes and Euclidean QFTs}

\section{Stochastic processes as internal valuations}

We now apply the results of the previous two sections to hyperspaces.



\appendix
\part{Appendix: Topos-theoretic background}\label{sec.topos_background}

\section{Geometric formulas}

We follow Blechschmidt's account of geometric formulas and their interactions with modalities~\cite[Chapter~2~and~6]{blechschmidt2017internal}, also referring to Vicker's lucid review of geometric logic for background~\cite{vickers_geometric_logic}.

\clearpage

\bibliographystyle{plain}
\bibliography{InternalValsStochProc}


\end{document}
